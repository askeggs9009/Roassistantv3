<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoAssistant - Dashboard</title>
    <link rel="icon" type="image/png" href="roassistant-logo.png">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/sidebar.css">
    <link rel="stylesheet" href="styles/chat.css">
    <link rel="stylesheet" href="styles/responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">


    <style>
        /* Subscription Status Styles */
        .subscription-status {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem 1rem;
            background: rgba(33, 38, 45, 0.6);
            border: 1px solid #30363d;
            border-radius: 8px;
            margin-right: 1rem;
        }

        .plan-badge {
            background: linear-gradient(45deg, #58a6ff, #1f6feb);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .plan-badge.free {
            background: linear-gradient(45deg, #8b949e, #6e7681);
        }

        .plan-badge.pro {
            background: linear-gradient(45deg, #58a6ff, #1f6feb);
        }

        .plan-badge.enterprise {
            background: linear-gradient(45deg, #9d4edd, #7c3aed);
        }

        /* Project Context Styles */
        .project-files-info {
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid rgba(88, 166, 255, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        
        .welcome-content a {
            color: #58a6ff;
            text-decoration: none;
        }
        
        .welcome-content a:hover {
            text-decoration: underline;
        }

        .usage-counter {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #8b949e;
            font-size: 0.85rem;
        }

        .usage-bar {
            width: 100px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .usage-fill {
            height: 100%;
            background: linear-gradient(90deg, #58a6ff, #1f6feb);
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        .usage-fill.warning {
            background: linear-gradient(90deg, #d4ac0d, #f39c12);
        }

        .usage-fill.danger {
            background: linear-gradient(90deg, #f85149, #da3633);
        }

        .upgrade-prompt {
            display: none;
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: linear-gradient(135deg, #161b22, #21262d);
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 350px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: slideInUp 0.3s ease;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .upgrade-prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .upgrade-prompt-title {
            font-weight: 600;
            color: #f0f6fc;
        }

        .upgrade-prompt-close {
            background: none;
            border: none;
            color: #8b949e;
            cursor: pointer;
            font-size: 1.5rem;
            line-height: 1;
        }

        .upgrade-prompt-message {
            color: #8b949e;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            line-height: 1.4;
        }

        .upgrade-prompt-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .upgrade-btn {
            flex: 1;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
        }

        .upgrade-btn.primary {
            background: linear-gradient(45deg, #238636, #2ea043);
            color: white;
        }

        .upgrade-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(46, 160, 67, 0.4);
        }

        .upgrade-btn.secondary {
            background: transparent;
            border: 1px solid #30363d;
            color: #8b949e;
        }

        .upgrade-btn.secondary:hover {
            border-color: #58a6ff;
            color: #58a6ff;
        }

        .model-locked {
            position: relative;
        }

        .model-locked::after {
            content: '🔒';
            position: absolute;
            right: 35px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
        }

        .usage-warning {
            background: rgba(212, 172, 13, 0.1);
            border: 1px solid rgba(212, 172, 13, 0.3);
            border-radius: 8px;
            padding: 0.75rem;
            margin: 1rem;
            color: #d4ac0d;
            font-size: 0.85rem;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .usage-limit-reached {
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid rgba(248, 81, 73, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem;
            color: #f85149;
            text-align: center;
            display: none;
        }

        /* FIXED: Account switch notification */
        .account-switch-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #58a6ff, #1f6feb);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(88, 166, 255, 0.4);
            z-index: 1000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .account-switch-notification.show {
            opacity: 1;
            transform: translateX(0);
        }
    </style>
</head>

<body>
    <!-- FIXED: Account Switch Notification -->
    <div class="account-switch-notification" id="accountSwitchNotification">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span>🔄</span>
            <span>Account switched! Loading your data...</span>
        </div>
    </div>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="roassistant-logo.png" alt="RoAssistant Logo" class="sidebar-logo" style="width: 40px; height: 40px; object-fit: contain;">
            <div class="sidebar-title">RoAssistant</div>
        </div>

        <button class="new-chat-btn" onclick="startNewChat()">
            <span>+</span>
            New chat
        </button>


        <div class="sidebar-nav">
            <!-- Main Navigation -->
            <div class="nav-section">
                <div class="nav-item active" onclick="setActiveNav(this, 'chats')">
                    <span class="nav-icon"><i class="fas fa-comments"></i></span>
                    Chats
                </div>
                <div class="nav-item" onclick="setActiveNav(this, 'projects')">
                    <span class="nav-icon"><i class="fas fa-folder"></i></span>
                    Projects
                </div>
                <div class="nav-item" onclick="setActiveNav(this, 'scripts')">
                    <span class="nav-icon"><i class="fas fa-wrench"></i></span>
                    Scripts
                </div>
                <div class="nav-item" onclick="window.location.href='/pricing.html'" style="color: #58a6ff;">
                    <span class="nav-icon"><i class="fas fa-gem"></i></span>
                    Upgrade Plan
                </div>
            </div>

            <!-- Recent Chats -->
            <div class="nav-section">
                <div class="nav-title">Recents</div>
                <div id="chatHistory">
                    <!-- Chat history will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <div class="sidebar-footer">
            <div class="user-profile" id="userProfile">
                <!-- Default Sign In button - will be replaced by JavaScript -->
                <div class="user-avatar"><i class="fas fa-user"></i></div>
                <div class="user-info">
                    <div class="user-name">Guest User</div>
                    <div class="user-plan">Free Plan - <span style="color: #58a6ff; cursor: pointer;" onclick="window.location.href='/login.html'">Sign In for More</span></div>
                </div>
                <button onclick="window.location.href='/login.html'" style="background: #238636; border: none; border-radius: 6px; color: white; padding: 0.4rem 0.8rem; font-size: 0.8rem; cursor: pointer; margin-left: 0.5rem;">
                    Sign In
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="main-header">
            <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleSidebar()">
                ☰
            </button>
            <div class="header-title" id="chatTitle">New Chat</div>
            
            <!-- Subscription Status -->
            <div class="subscription-status" id="subscriptionStatus" style="display: none;">
                <div class="plan-badge" id="planBadge">Free</div>
                <div class="usage-counter">
                    <span id="usageText">0/10</span>
                    <div class="usage-bar">
                        <div class="usage-fill" id="usageFill" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
            
            <select class="model-selector" id="modelSelector">
                <option value="claude-4-sonnet" selected>RoCode 3</option>
                <option value="claude-4-opus">RoCode Nexus 3</option>
            </select>
        </div>

        <!-- Usage Warning -->
        <div id="usageWarning" class="usage-warning">
            ⚠️ You're approaching your daily message limit. Consider upgrading for unlimited access!
        </div>

        <!-- Usage Limit Reached -->
        <div id="usageLimitReached" class="usage-limit-reached">
            🚫 Daily message limit reached. <a href="/pricing.html" style="color: #58a6ff;">Upgrade now</a> for unlimited messages!
        </div>


        <!-- Chat Area -->
        <div class="chat-area">
            <div class="messages-container" id="messagesContainer">
                <!-- Welcome Screen -->
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="welcome-icon">🚀</div>
                    <h1 class="welcome-title">Welcome to RoAssistant</h1>
                    <p class="welcome-subtitle">Your intelligent assistant for Roblox game development</p>
                    
                    <div class="quick-actions">
                        <div class="quick-action" onclick="useQuickAction('Create a simple script that makes a part glow when touched')">
                            <span class="action-icon">✨</span>
                            <div class="action-title">Create Script</div>
                            <div class="action-desc">Generate Luau scripts for your Roblox game</div>
                        </div>
                        
                        <div class="quick-action" onclick="useQuickAction('Debug this error: attempt to index nil with HeadQuest')">
                            <span class="action-icon">🐛</span>
                            <div class="action-title">Debug Code</div>
                            <div class="action-desc">Fix errors and optimize your scripts</div>
                        </div>
                        
                        <div class="quick-action" onclick="useQuickAction('Explain how RemoteEvents work in Roblox')">
                            <span class="action-icon">📚</span>
                            <div class="action-title">Learn Concepts</div>
                            <div class="action-desc">Understand Roblox development concepts</div>
                        </div>
                        
                        <div class="quick-action" onclick="useQuickAction('Create a shop GUI with purchase functionality')">
                            <span class="action-icon">🎮</span>
                            <div class="action-title">Build Systems</div>
                            <div class="action-desc">Design game mechanics and systems</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-container">
                <div class="input-wrapper" id="inputWrapper">
                    <div class="input-content">
                        <!-- File attachments area -->
                        <div class="file-attachments" id="fileAttachments" style="display: none;"></div>
                        
                        <!-- Input row -->
                        <div class="input-row">
                            <button class="attach-button" id="attachButton" onclick="openFileDialog()" title="Add file or image">
                                <span>📎</span>
                            </button>
                            <textarea 
                                class="input-area" 
                                id="messageInput" 
                                placeholder="Ask me about Roblox scripting, debugging, or game development..."
                                rows="1"
                            ></textarea>
                            <button class="send-button" id="sendButton" onclick="sendMessage()">
                                <span>Send</span>
                            </button>
                        </div>
                    </div>
                </div>
                <input type="file" id="fileInput" accept="image/*,.txt,.lua,.luau,.js,.json,.md" style="display: none;" onchange="handleFileSelect(event)" multiple>
                
                <!-- Drag & Drop Overlay -->
                <div class="drag-overlay" id="dragOverlay" style="display: none;">
                    <div class="drag-content">
                        <div class="drag-icon"><i class="fas fa-folder-open"></i></div>
                        <div class="drag-text">Drop files here to upload</div>
                        <div class="drag-subtext">Images, code files, and documents</div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Upgrade Prompt -->
    <div class="upgrade-prompt" id="upgradePrompt">
        <div class="upgrade-prompt-header">
            <div class="upgrade-prompt-title">🚀 Unlock More Power</div>
            <button class="upgrade-prompt-close" onclick="closeUpgradePrompt()">×</button>
        </div>
        <div class="upgrade-prompt-message" id="upgradePromptMessage">
            You've used 8 of your 10 daily messages. Upgrade to Pro for 500 messages per day!
        </div>
        <div class="upgrade-prompt-buttons">
            <button class="upgrade-btn primary" onclick="window.location.href='/pricing.html'">
                View Plans
            </button>
            <button class="upgrade-btn secondary" onclick="closeUpgradePrompt()">
                Maybe Later
            </button>
        </div>
    </div>

    <script>
        // DYNAMIC API CONFIGURATION - Updated for production deployment
        const getApiBaseUrl = () => {
            // Check if we're running on localhost (development)
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                return 'http://localhost:3000';
            }
            
            // For production, point to Railway backend
            return 'https://roassistantv3-production.up.railway.app';
        };

        const API_BASE_URL = getApiBaseUrl();
        console.log(`[CONFIG] Using API Base URL: ${API_BASE_URL}`);

        // FIXED: Global variables with proper user isolation
        let currentChatId = null;
        let isLoggedIn = false;
        let authToken = null;
        let currentUser = null;
        let selectedModel = 'gpt-4o-mini';
        let currentView = 'chats';
        let attachedFiles = [];

        // FIXED: User-specific data storage
        let userChats = [];
        let userScripts = [];

        // Subscription management
        let userSubscription = {
            plan: 'free',
            limits: {
                daily_messages: 10,
                models: ['gpt-4o-mini']
            },
            usage: {
                daily_messages: 0,
                daily_limit: 10
            }
        };

        // Message counter for ad insertion
        let messageCount = 0;
        const AD_FREQUENCY = 5; // Show ad every 5 messages

        // FIXED: Account switching functionality
        class AccountManager {
            constructor() {
                this.lastKnownUser = null;
                this.initializeWatcher();
            }

            initializeWatcher() {
                // Watch for auth token changes
                const originalSetItem = localStorage.setItem;
                const originalRemoveItem = localStorage.removeItem;
                
                localStorage.setItem = (key, value) => {
                    if (key === 'authToken' || key === 'user') {
                        setTimeout(() => this.checkForAccountSwitch(), 100);
                    }
                    return originalSetItem.call(localStorage, key, value);
                };
                
                localStorage.removeItem = (key) => {
                    if (key === 'authToken' || key === 'user') {
                        setTimeout(() => this.checkForAccountSwitch(), 100);
                    }
                    return originalRemoveItem.call(localStorage, key);
                };
            }

            checkForAccountSwitch() {
                const currentToken = localStorage.getItem('authToken');
                const currentUserData = localStorage.getItem('user');
                
                let currentUserId = null;
                if (currentUserData) {
                    try {
                        const user = JSON.parse(currentUserData);
                        currentUserId = user.id || user.email;
                    } catch (error) {
                        console.error('Error parsing user data:', error);
                    }
                }

                // Check if user has switched
                if (this.lastKnownUser !== currentUserId) {
                    console.log('[ACCOUNT] User switch detected:', this.lastKnownUser, '->', currentUserId);
                    this.handleAccountSwitch(currentUserId);
                    this.lastKnownUser = currentUserId;
                }
            }
        }


        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing app...');
            initApp();
            
            // Check subscription status and refresh periodically
            checkSubscriptionStatus();
            setInterval(checkSubscriptionStatus, 60000); // Refresh every minute
        });

        // Check for project parameter in URL
        function checkProjectParameter() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('project');
            
            if (projectId) {
                // Load project context if needed
                console.log('Loading project context:', projectId);
                // You can implement project-specific logic here
            }
        }


        // Authentication and User Profile Functions
        function checkAuth() {
            console.log('Checking auth...');
            authToken = localStorage.getItem('authToken');
            const user = localStorage.getItem('user');

            if (authToken && user) {
                try {
                    const userData = JSON.parse(user);
                    currentUser = userData;
                    showLoggedInUser(userData);
                    isLoggedIn = true;
                } catch (error) {
                    console.error('Error parsing user data:', error);
                    showGuestUser();
                    isLoggedIn = false;
                    currentUser = null;
                }
            } else {
                showGuestUser();
                isLoggedIn = false;
                currentUser = null;
            }
            updateModelSelector();
        }

        // Show logged in user profile
        function showLoggedInUser(userData) {
            const userProfile = document.getElementById('userProfile');
            if (userProfile) {
                const planText = userData.subscription?.plan || 'free';
                const planDisplay = planText.charAt(0).toUpperCase() + planText.slice(1);
                
                userProfile.innerHTML = `
                    <div class="user-avatar">${(userData.name || userData.email || 'U').charAt(0).toUpperCase()}</div>
                    <div class="user-info">
                        <div class="user-name">${userData.name || userData.email || 'User'}</div>
                        <div class="user-plan">${planDisplay} Plan</div>
                    </div>
                    <button onclick="logout()" style="background: #f85149; border: none; border-radius: 6px; color: white; padding: 0.4rem 0.8rem; font-size: 0.8rem; cursor: pointer; margin-left: 0.5rem;">
                        Logout
                    </button>
                `;
            }
        }

        // Show guest user profile
        function showGuestUser() {
            console.log('[AUTH] Showing guest user profile...');
            const userProfile = document.getElementById('userProfile');
            if (userProfile) {
                userProfile.innerHTML = `
                    <div class="user-avatar"><i class="fas fa-user"></i></div>
                    <div class="user-info">
                        <div class="user-name">Guest User</div>
                        <div class="user-plan">Free Plan - <span style="color: #58a6ff; cursor: pointer;" onclick="window.location.href='/login.html'">Sign In for More</span></div>
                    </div>
                    <button onclick="window.location.href='/login.html'" style="background: #238636; border: none; border-radius: 6px; color: white; padding: 0.4rem 0.8rem; font-size: 0.8rem; cursor: pointer; margin-left: 0.5rem;">
                        Sign In
                    </button>
                `;
                console.log('[AUTH] Guest user profile updated successfully');
            } else {
                console.error('[AUTH] Could not find userProfile element!');
            }
        }

        // Logout function
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('user');
            
            isLoggedIn = false;
            authToken = null;
            currentUser = null;
            
            showGuestUser();
            updateModelSelector();
            
            // Switch to available model for guests
            if (selectedModel !== 'gpt-4o-mini') {
                selectedModel = 'gpt-4o-mini';
                document.getElementById('modelSelector').value = selectedModel;
            }
        }

        // Update model selector for auth status
        function updateModelSelector() {
            const modelSelector = document.getElementById('modelSelector');
            if (modelSelector) {
                const options = modelSelector.querySelectorAll('option');
                
                options.forEach(option => {
                    if (option.value === 'claude-4-opus') {
                        option.disabled = !isLoggedIn;
                        if (!isLoggedIn && !option.textContent.includes('Sign in required')) {
                            option.textContent = 'RoCode Nexus 3 (Premium) - Sign in required';
                        } else if (isLoggedIn) {
                            option.textContent = 'RoCode Nexus 3 (Premium)';
                        }
                    }
                });
            }
        }

        // Initialize app
        function initApp() {
            console.log('Initializing app...');
            checkAuth();
        }

        // Check subscription status (stub for now)
        function checkSubscriptionStatus() {
            // This function would normally check subscription status from server
            console.log('Checking subscription status...');
        }
    </script>

    <!-- Load JavaScript modules -->
    <script src="js/auth.js"></script>
    <script src="js/chat.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/scripts.js"></script>
    <script src="js/app.js"></script>

    <!-- Initialize the application -->
    <script>
        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            const app = new App();
            app.init();
        });
    </script>



    <!-- ReactBits-Inspired Animations -->
    <script src="js/animations/particles-background.js"></script>
    <script src="js/animations/click-spark.js"></script>
    <script src="js/animations/cursor-trail.js"></script>
    <script src="js/animations/blur-text.js"></script>
    <script src="js/animations/micro-interactions.js"></script>
    <script src="js/animations/animations-init.js"></script>

</body>
</html>
