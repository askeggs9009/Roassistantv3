<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roblox Luau AI Assistant</title>
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #0d1117;
            color: #f0f6fc;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background: #161b22;
            border-right: 1px solid #21262d;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid #21262d;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sidebar-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(45deg, #00d4ff, #9d4edd);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 14px;
        }

        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #f0f6fc;
        }

        .new-chat-btn {
            background: #238636;
            border: none;
            border-radius: 8px;
            color: white;
            padding: 0.75rem 1rem;
            margin: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .new-chat-btn:hover {
            background: #2ea043;
            transform: translateY(-1px);
        }

        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
            padding: 0 1rem;
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-title {
            color: #8b949e;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
            padding-left: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            color: #e6edf3;
            margin-bottom: 0.25rem;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-item.active {
            background: rgba(88, 166, 255, 0.15);
            color: #58a6ff;
        }

        .nav-icon {
            width: 16px;
            height: 16px;
            opacity: 0.8;
        }

        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid #21262d;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .user-profile:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(45deg, #58a6ff, #1f6feb);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-size: 0.9rem;
            font-weight: 500;
            color: #f0f6fc;
        }

        .user-plan {
            font-size: 0.75rem;
            color: #8b949e;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            width: 100%;
            min-width: 0;
        }

        .main-header {
            background: rgba(13, 17, 23, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid #21262d;
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-shrink: 0;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: #f0f6fc;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
        }

        .mobile-menu-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .header-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #f0f6fc;
            flex: 1;
        }

        .model-selector {
            background: rgba(33, 38, 45, 0.8);
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            color: #f0f6fc;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            outline: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%238b949e' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        .model-selector:hover {
            border-color: #58a6ff;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            min-height: 0;
        }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 2rem;
        }

        .welcome-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #00d4ff, #9d4edd);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            margin-bottom: 1.5rem;
        }

        .welcome-title {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            background: linear-gradient(45deg, #00d4ff, #9d4edd);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-subtitle {
            color: #8b949e;
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            max-width: 600px;
            width: 100%;
        }

        .quick-action {
            background: rgba(33, 38, 45, 0.8);
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }

        .quick-action:hover {
            border-color: #58a6ff;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .action-icon {
            font-size: 1.5rem;
            margin-bottom: 0.75rem;
            display: block;
        }

        .action-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #f0f6fc;
        }

        .action-desc {
            font-size: 0.85rem;
            color: #8b949e;
            line-height: 1.4;
        }

        /* Messages */
        .message {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
            max-width: 100%;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }

        .user .message-avatar {
            background: linear-gradient(45deg, #58a6ff, #1f6feb);
            color: white;
        }

        .assistant .message-avatar {
            background: linear-gradient(45deg, #00d4ff, #9d4edd);
            color: white;
        }

        .message-content {
            flex: 1;
            min-width: 0;
        }

        .message-text {
            background: #161b22;
            border: 1px solid #21262d;
            border-radius: 12px;
            padding: 1rem;
            line-height: 1.6;
            word-wrap: break-word;
        }

        .user .message-text {
            background: #0969da;
            border-color: #1f6feb;
            color: white;
        }

        /* Input Area */
        .input-container {
            background: #0d1117;
            border-top: 1px solid #21262d;
            padding: 1.5rem;
            width: 100%;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
        }

        .input-wrapper {
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 1rem;
            transition: border-color 0.2s ease;
            width: 100%;
            max-width: 800px;
        }

        .input-wrapper:focus-within {
            border-color: #58a6ff;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }

        .input-content {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            width: 100%;
        }

        .input-row {
            display: flex;
            align-items: flex-end;
            gap: 1rem;
            width: 100%;
        }

        .input-area {
            flex: 1;
            background: transparent;
            border: none;
            color: #f0f6fc;
            font-size: 1rem;
            font-family: inherit;
            resize: none;
            outline: none;
            min-height: 24px;
            max-height: 120px;
            line-height: 1.5;
        }

        .input-area::placeholder {
            color: #8b949e;
        }

        .attach-button {
            background: transparent;
            border: none;
            color: #8b949e;
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            min-width: 36px;
            height: 36px;
            flex-shrink: 0;
        }

        .attach-button:hover {
            background: rgba(139, 148, 158, 0.2);
            color: #f0f6fc;
        }

        .send-button {
            background: linear-gradient(45deg, #58a6ff, #1f6feb);
            border: none;
            border-radius: 8px;
            color: white;
            padding: 0.5rem 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-height: 36px;
            flex-shrink: 0;
        }

        .send-button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(88, 166, 255, 0.4);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Sidebar Overlay for Mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 1000;
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .mobile-menu-btn {
                display: block;
            }

            .main-content {
                width: 100%;
            }

            .main-header {
                padding: 1rem;
            }

            .messages-container {
                padding: 1rem;
            }

            .input-container {
                padding: 1rem;
            }

            .quick-actions {
                grid-template-columns: 1fr;
            }

            .sidebar-overlay.open {
                display: block;
            }
        }

        /* Chat History Styles */
        .chat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
            color: #e6edf3;
            margin-bottom: 0.25rem;
            position: relative;
        }

        .chat-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .chat-item.active {
            background: rgba(88, 166, 255, 0.15);
            color: #58a6ff;
        }

        .chat-title {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-time {
            font-size: 0.75rem;
            color: #8b949e;
        }

        .chat-menu {
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .chat-item:hover .chat-menu {
            opacity: 1;
        }

        .menu-btn {
            background: none;
            border: none;
            color: #8b949e;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .menu-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #f0f6fc;
        }

        /* Scrollbar Styles */
        .sidebar-nav::-webkit-scrollbar,
        .messages-container::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-nav::-webkit-scrollbar-track,
        .messages-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar-nav::-webkit-scrollbar-thumb,
        .messages-container::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 3px;
        }

        .sidebar-nav::-webkit-scrollbar-thumb:hover,
        .messages-container::-webkit-scrollbar-thumb:hover {
            background: #484f58;
        }
    </style>
</head>

<body>
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-icon">RL</div>
            <div class="sidebar-title">Roblox Assistant</div>
        </div>

        <button class="new-chat-btn" onclick="startNewChat()">
            <span>➕</span>
            New chat
        </button>

        <div class="sidebar-nav">
            <!-- Main Navigation -->
            <div class="nav-section">
                <div class="nav-item active" onclick="setActiveNav(this, 'chats')">
                    <span class="nav-icon">💬</span>
                    Chats
                </div>
                <div class="nav-item" onclick="setActiveNav(this, 'projects')">
                    <span class="nav-icon">📂</span>
                    Projects
                </div>
                <div class="nav-item" onclick="setActiveNav(this, 'scripts')">
                    <span class="nav-icon">🔧</span>
                    Scripts
                </div>
                <div class="nav-item" onclick="window.location.href='/pricing.html'" style="color: #58a6ff;">
                    <span class="nav-icon">💎</span>
                    Upgrade Plan
                </div>
            </div>

            <!-- Recent Chats -->
            <div class="nav-section">
                <div class="nav-title">Recents</div>
                <div id="chatHistory">
                    <div style="padding: 1rem; text-align: center; color: #8b949e; font-size: 0.85rem;">
                        No chats yet<br>
                        <small>Start a new conversation!</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="sidebar-footer">
            <div class="user-profile" id="userProfile">
                <div class="user-avatar">👤</div>
                <div class="user-info">
                    <div class="user-name">Guest User</div>
                    <div class="user-plan">Free Plan - <span style="color: #58a6ff; cursor: pointer;" onclick="window.location.href='/login.html'">Sign In for More</span></div>
                </div>
                <button onclick="window.location.href='/login.html'" style="background: #238636; border: none; border-radius: 6px; color: white; padding: 0.4rem 0.8rem; font-size: 0.8rem; cursor: pointer; margin-left: 0.5rem;">
                    Sign In
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="main-header">
            <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleSidebar()">
                ☰
            </button>
            <div class="header-title" id="chatTitle">New Chat</div>
            
            <select class="model-selector" id="modelSelector">
                <option value="gpt-4o-mini">GPT-4o Mini</option>
                <option value="gpt-4.1" disabled>GPT-4.1 - Sign in required</option>
                <option value="gpt-5" disabled>GPT-5 - Sign in required</option>
            </select>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <div class="messages-container" id="messagesContainer">
                <!-- Welcome Screen -->
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="welcome-icon">🚀</div>
                    <h1 class="welcome-title">Welcome to Roblox Luau AI</h1>
                    <p class="welcome-subtitle">Your intelligent assistant for Roblox game development</p>
                    
                    <div class="quick-actions">
                        <div class="quick-action" onclick="useQuickAction('Create a simple script that makes a part glow when touched')">
                            <span class="action-icon">✨</span>
                            <div class="action-title">Create Script</div>
                            <div class="action-desc">Generate Luau scripts for your Roblox game</div>
                        </div>
                        
                        <div class="quick-action" onclick="useQuickAction('Debug this error: attempt to index nil with HeadQuest')">
                            <span class="action-icon">🐛</span>
                            <div class="action-title">Debug Code</div>
                            <div class="action-desc">Fix errors and optimize your scripts</div>
                        </div>
                        
                        <div class="quick-action" onclick="useQuickAction('Explain how RemoteEvents work in Roblox')">
                            <span class="action-icon">📚</span>
                            <div class="action-title">Learn Concepts</div>
                            <div class="action-desc">Understand Roblox development concepts</div>
                        </div>
                        
                        <div class="quick-action" onclick="useQuickAction('Create a shop GUI with purchase functionality')">
                            <span class="action-icon">🎮</span>
                            <div class="action-title">Build Systems</div>
                            <div class="action-desc">Design game mechanics and systems</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-container">
                <div class="input-wrapper" id="inputWrapper">
                    <div class="input-content">
                        <!-- Input row -->
                        <div class="input-row">
                            <button class="attach-button" id="attachButton" onclick="openFileDialog()" title="Add file or image">
                                <span>📎</span>
                            </button>
                            <textarea 
                                class="input-area" 
                                id="messageInput" 
                                placeholder="Ask me about Roblox scripting, debugging, or game development..."
                                rows="1"
                            ></textarea>
                            <button class="send-button" id="sendButton" onclick="sendMessage()">
                                <span>Send</span>
                            </button>
                        </div>
                    </div>
                </div>
                <input type="file" id="fileInput" accept="image/*,.txt,.lua,.luau,.js,.json,.md" style="display: none;" onchange="handleFileSelect(event)" multiple>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const getApiBaseUrl = () => {
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                return 'http://localhost:3000';
            }
            return 'https://roassistantv3-production.up.railway.app';
        };

        const API_BASE_URL = getApiBaseUrl();
        console.log(`[CONFIG] Using API Base URL: ${API_BASE_URL}`);

        // Global variables
        let currentChatId = null;
        let isLoggedIn = false;
        let authToken = null;
        let currentUser = null;
        let selectedModel = 'gpt-4o-mini';
        let currentView = 'chats';
        let attachedFiles = [];
        let userChats = [];
        let messageCount = 0;

        // Initialize app
        function initApp() {
            console.log('Initializing app...');
            checkAuth();
            loadChatHistory();
        }

        // Update model selector
        function updateModelSelector() {
            const modelSelector = document.getElementById('modelSelector');
            if (modelSelector) {
                const options = modelSelector.querySelectorAll('option');
                
                options.forEach(option => {
                    if (option.value !== 'gpt-4o-mini') {
                        option.disabled = !isLoggedIn;
                        option.textContent = isLoggedIn ? 
                            option.textContent.replace(' - Sign in required', '') :
                            option.textContent.includes(' - Sign in required') ? 
                                option.textContent : 
                                option.textContent + ' - Sign in required';
                    }
                });
            }
            
            updateNavItems();
        }

        // Update navigation items
        function updateNavItems() {
            const scriptsNav = document.querySelector('.nav-item[onclick*="scripts"]');
            const projectsNav = document.querySelector('.nav-item[onclick*="projects"]');
            
            if (scriptsNav && projectsNav) {
                if (isLoggedIn) {
                    scriptsNav.style.opacity = '1';
                    scriptsNav.style.cursor = 'pointer';
                    scriptsNav.title = '';
                    
                    projectsNav.style.opacity = '1';
                    projectsNav.style.cursor = 'pointer';
                    projectsNav.title = '';
                } else {
                    scriptsNav.style.opacity = '0.5';
                    scriptsNav.style.cursor = 'not-allowed';
                    scriptsNav.title = 'Sign in required';
                    
                    projectsNav.style.opacity = '0.5';
                    projectsNav.style.cursor = 'not-allowed';
                    projectsNav.title = 'Sign in required';
                }
            }
        }

        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar && overlay) {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('open');
            }
        }

        // Close sidebar
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar && overlay) {
                sidebar.classList.remove('open');
                overlay.classList.remove('open');
            }
        }

        // Set active navigation item
        function setActiveNav(element, section) {
            if ((section === 'scripts' || section === 'projects') && !isLoggedIn) {
                alert('Please sign in to access ' + (section === 'scripts' ? 'Scripts' : 'Projects') + '.');
                return;
            }
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            element.classList.add('active');
            
            currentView = section;
            
            if (section === 'chats') {
                loadChatHistory();
            } else if (section === 'scripts') {
                loadScriptsView();
            } else if (section === 'projects') {
                window.location.href = '/projects.html';
            }
        }

        // Start new chat
        function startNewChat() {
            currentChatId = null;
            messageCount = 0;
            document.getElementById('chatTitle').textContent = 'New Chat';
            showWelcomeScreen();
            
            const firstNavItem = document.querySelector('.nav-item');
            if (firstNavItem) {
                setActiveNav(firstNavItem, 'chats');
            }
            closeSidebar();
        }

        // Show welcome screen
        function showWelcomeScreen() {
            const messagesContainer = document.getElementById('messagesContainer');
            if (messagesContainer) {
                messagesContainer.innerHTML = `
                    <div class="welcome-screen" id="welcomeScreen">
                        <div class="welcome-icon">🚀</div>
                        <h1 class="welcome-title">Welcome to Roblox Luau AI</h1>
                        <p class="welcome-subtitle">Your intelligent assistant for Roblox game development</p>
                        
                        <div class="quick-actions">
                            <div class="quick-action" onclick="useQuickAction('Create a simple script that makes a part glow when touched')">
                                <span class="action-icon">✨</span>
                                <div class="action-title">Create Script</div>
                                <div class="action-desc">Generate Luau scripts for your Roblox game</div>
                            </div>
                            
                            <div class="quick-action" onclick="useQuickAction('Debug this error: attempt to index nil with HeadQuest')">
                                <span class="action-icon">🐛</span>
                                <div class="action-title">Debug Code</div>
                                <div class="action-desc">Fix errors and optimize your scripts</div>
                            </div>
                            
                            <div class="quick-action" onclick="useQuickAction('Explain how RemoteEvents work in Roblox')">
                                <span class="action-icon">📚</span>
                                <div class="action-title">Learn Concepts</div>
                                <div class="action-desc">Understand Roblox development concepts</div>
                            </div>
                            
                            <div class="quick-action" onclick="useQuickAction('Create a shop GUI with purchase functionality')">
                                <span class="action-icon">🎮</span>
                                <div class="action-title">Build Systems</div>
                                <div class="action-desc">Design game mechanics and systems</div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Use quick action
        function useQuickAction(prompt) {
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.value = prompt;
                sendMessage();
            }
        }

        // File handling functions
        function openFileDialog() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.click();
            }
        }

        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length > 0) {
                console.log('Files selected:', files.length);
                // Handle file processing here
            }
        }

        // Add message to chat
        function addMessage(content, isUser = false, isSystem = false) {
            const welcomeScreen = document.getElementById('welcomeScreen');
            if (welcomeScreen) {
                welcomeScreen.remove();
            }

            const messagesContainer = document.getElementById('messagesContainer');
            if (!messagesContainer) return;

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
            
            if (isSystem) {
                messageDiv.style.opacity = '0.8';
                messageDiv.style.fontSize = '0.9rem';
            }
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = isUser ? 'U' : (isSystem ? '⚙️' : 'AI');
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const messageText = document.createElement('div');
            messageText.className = 'message-text';
            messageText.innerHTML = formatMessageContent(content);
            
            contentDiv.appendChild(messageText);
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            if (!isSystem) {
                saveMessageToChat(content, isUser);
            }
        }

        // Format message content
        function formatMessageContent(content) {
            // Handle code blocks
            content = content.replace(/```(?:lua|luau)?\n?([\s\S]*?)```/g, (match, code) => {
                return `
                    <div style="background: #0d1117; border: 1px solid #21262d; border-radius: 6px; padding: 1rem; margin: 0.5rem 0; overflow-x: auto;">
                        <div style="color: #8b949e; font-size: 0.8rem; margin-bottom: 0.5rem; border-bottom: 1px solid #21262d; padding-bottom: 0.5rem;">Luau Script</div>
                        <pre style="margin: 0; font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, monospace; font-size: 0.85rem; color: #e6edf3;"><code>${escapeHtml(code.trim())}</code></pre>
                    </div>
                `;
            });
            
            // Handle markdown
            content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            content = content.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            content = content.replace(/`([^`]+)`/g, '<code style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; font-family: monospace;">$1</code>');
            content = content.replace(/\n/g, '<br>');
            
            return content;
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Send message
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            
            if (!messageInput || !sendButton) return;
            
            const message = messageInput.value.trim();
            if (!message) return;

            sendButton.disabled = true;
            sendButton.textContent = 'Sending...';
            
            addMessage(message, true);
            messageInput.value = '';
            messageInput.style.height = 'auto';

            try {
                const headers = { "Content-Type": "application/json" };
                
                if (isLoggedIn && authToken) {
                    headers["Authorization"] = `Bearer ${authToken}`;
                }

                const response = await fetch(`${API_BASE_URL}/ask`, {
                    method: "POST",
                    headers: headers,
                    body: JSON.stringify({ 
                        prompt: message,
                        model: selectedModel 
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.reply) {
                        addMessage(data.reply, false);
                    } else {
                        addMessage('⚠️ Error: ' + (data.error || 'Unknown error occurred'), false);
                    }
                } else {
                    if (response.status === 403 && data.requiresAuth) {
                        addMessage(`🔒 ${data.error}`, false, true);
                        
                        if (data.availableModel) {
                            selectedModel = data.availableModel;
                            document.getElementById('modelSelector').value = selectedModel;
                            addMessage(`🔄 Switched to ${selectedModel} (available for guests)`, false, true);
                        }
                    } else {
                        addMessage('⚠️ Error: ' + (data.error || 'Unknown error occurred'), false);
                    }
                }
            } catch (error) {
                console.error('Network error:', error);
                addMessage('⚠️ Connection Error: Make sure your server is running at ' + API_BASE_URL, false);
            } finally {
                sendButton.disabled = false;
                sendButton.textContent = 'Send';
                messageInput.focus();
            }
        }

        // Save message to chat
        async function saveMessageToChat(content, isUser) {
            if (!currentChatId) {
                currentChatId = Date.now().toString();
                const title = content.length > 50 ? content.substring(0, 50) + '...' : content;
                
                const newChat = {
                    id: currentChatId,
                    title: title,
                    messages: [],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                userChats.push(newChat);
                
                if (isLoggedIn && authToken) {
                    try {
                        await fetch(`${API_BASE_URL}/api/user-chats`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${authToken}`
                            },
                            body: JSON.stringify({ chat: newChat })
                        });
                    } catch (error) {
                        console.error('Error saving chat to server:', error);
                    }
                } else {
                    const guestChats = JSON.parse(localStorage.getItem('guest_chats') || '[]');
                    guestChats.push(newChat);
                    localStorage.setItem('guest_chats', JSON.stringify(guestChats));
                }
                
                const chatTitle = document.getElementById('chatTitle');
                if (chatTitle) {
                    chatTitle.textContent = title;
                }
            }

            const chat = userChats.find(c => c.id === currentChatId);
            if (chat) {
                chat.messages.push({
                    content: content,
                    isUser: isUser,
                    timestamp: new Date().toISOString()
                });
                chat.updatedAt = new Date().toISOString();
                
                if (isLoggedIn && authToken) {
                    try {
                        await fetch(`${API_BASE_URL}/api/user-chats/${currentChatId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${authToken}`
                            },
                            body: JSON.stringify({ chat: chat })
                        });
                    } catch (error) {
                        console.error('Error updating chat on server:', error);
                    }
                } else {
                    const guestChats = JSON.parse(localStorage.getItem('guest_chats') || '[]');
                    const chatIndex = guestChats.findIndex(c => c.id === currentChatId);
                    if (chatIndex !== -1) {
                        guestChats[chatIndex] = chat;
                        localStorage.setItem('guest_chats', JSON.stringify(guestChats));
                    }
                }
                
                loadChatHistory();
            }
        }

        // Load chat history
        function loadChatHistory() {
            const chatHistory = document.getElementById('chatHistory');
            if (!chatHistory) return;
            
            let chatsToDisplay = [];
            
            if (isLoggedIn) {
                chatsToDisplay = userChats;
            } else {
                chatsToDisplay = JSON.parse(localStorage.getItem('guest_chats') || '[]');
            }
            
            if (chatsToDisplay.length === 0) {
                chatHistory.innerHTML = `
                    <div style="padding: 1rem; text-align: center; color: #8b949e; font-size: 0.85rem;">
                        No chats yet<br>
                        <small>Start a new conversation!</small>
                    </div>
                `;
                return;
            }

            const sortedChats = [...chatsToDisplay].sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
            
            chatHistory.innerHTML = sortedChats.map(chat => {
                const timeAgo = getTimeAgo(new Date(chat.updatedAt));
                return `
                    <div class="chat-item ${chat.id === currentChatId ? 'active' : ''}" 
                         data-chat-id="${chat.id}" 
                         onclick="loadChat('${chat.id}')">
                        <div class="chat-title">${chat.title}</div>
                        <div class="chat-time">${timeAgo}</div>
                        <div class="chat-menu">
                            <button class="menu-btn" onclick="deleteChat('${chat.id}', event)" title="Delete chat">
                                🗑️
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load chat
        function loadChat(chatId) {
            let chatsToSearch = [];
            
            if (isLoggedIn) {
                chatsToSearch = userChats;
            } else {
                chatsToSearch = JSON.parse(localStorage.getItem('guest_chats') || '[]');
            }
            
            const chat = chatsToSearch.find(c => c.id === chatId);
            if (!chat) return;

            currentChatId = chatId;
            messageCount = chat.messages.length;
            
            const chatTitle = document.getElementById('chatTitle');
            if (chatTitle) {
                chatTitle.textContent = chat.title;
            }
            
            const messagesContainer = document.getElementById('messagesContainer');
            if (messagesContainer) {
                messagesContainer.innerHTML = '';
                
                chat.messages.forEach((message, index) => {
                    addMessage(message.content, message.isUser, false);
                });
            }

            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-chat-id="${chatId}"]`)?.classList.add('active');
            
            const firstNavItem = document.querySelector('.nav-item');
            if (firstNavItem) {
                setActiveNav(firstNavItem, 'chats');
            }
            closeSidebar();
        }

        // Delete chat
        async function deleteChat(chatId, event) {
            event.stopPropagation();
            
            if (confirm('Are you sure you want to delete this chat?')) {
                if (isLoggedIn && authToken) {
                    try {
                        await fetch(`${API_BASE_URL}/api/user-chats/${chatId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${authToken}`
                            }
                        });
                        
                        userChats = userChats.filter(c => c.id !== chatId);
                    } catch (error) {
                        console.error('Error deleting chat from server:', error);
                    }
                } else {
                    const guestChats = JSON.parse(localStorage.getItem('guest_chats') || '[]');
                    const filteredChats = guestChats.filter(c => c.id !== chatId);
                    localStorage.setItem('guest_chats', JSON.stringify(filteredChats));
                }
                
                loadChatHistory();
                
                if (currentChatId === chatId) {
                    startNewChat();
                }
            }
        }

        // Get time ago string
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Now';
            if (diffMins < 60) return `${diffMins}m`;
            if (diffHours < 24) return `${diffHours}h`;
            if (diffDays < 7) return `${diffDays}d`;
            return date.toLocaleDateString();
        }

        // Scripts functionality
        function loadScriptsView() {
            const chatHistory = document.getElementById('chatHistory');
            if (chatHistory) {
                chatHistory.innerHTML = `
                    <div style="padding: 1rem; text-align: center; color: #8b949e; font-size: 0.85rem;">
                        Scripts feature coming soon!<br>
                        <small>Generated scripts will appear here</small>
                    </div>
                `;
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            const messageInput = document.getElementById('messageInput');
            const modelSelector = document.getElementById('modelSelector');

            if (messageInput) {
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                });

                messageInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }

            if (modelSelector) {
                modelSelector.addEventListener('change', function() {
                    if (this.value !== 'gpt-4o-mini' && !isLoggedIn) {
                        this.value = selectedModel;
                        alert('Please sign in to access premium models');
                        return;
                    }
                    selectedModel = this.value;
                });
            }
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing app...');
            initApp();
        });
    </script>
</body>
</html>hatHistory();
            setupEventListeners();
        }

        // Check authentication
        function checkAuth() {
            authToken = localStorage.getItem('authToken');
            const user = localStorage.getItem('user');

            if (authToken && user) {
                try {
                    const userData = JSON.parse(user);
                    currentUser = userData;
                    showLoggedInUser(userData);
                    isLoggedIn = true;
                    loadUserSpecificData();
                } catch (error) {
                    console.error('Error parsing user data:', error);
                    showGuestUser();
                    isLoggedIn = false;
                    currentUser = null;
                }
            } else {
                showGuestUser();
                isLoggedIn = false;
                currentUser = null;
            }
            updateModelSelector();
        }

        // Load user-specific data
        async function loadUserSpecificData() {
            if (!authToken) return;
            
            try {
                const chatsResponse = await fetch(`${API_BASE_URL}/api/user-chats`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (chatsResponse.ok) {
                    const chatsData = await chatsResponse.json();
                    userChats = chatsData.chats || [];
                    console.log(`[DATA] Loaded ${userChats.length} chats for user`);
                    loadChatHistory();
                } else {
                    console.error('Failed to load user chats:', chatsResponse.status);
                    userChats = [];
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                userChats = [];
            }
        }

        // Show logged in user profile
        function showLoggedInUser(userData) {
            const userProfile = document.getElementById('userProfile');
            if (userProfile) {
                const planText = userData.subscription?.plan || 'free';
                const planDisplay = planText.charAt(0).toUpperCase() + planText.slice(1);
                
                userProfile.innerHTML = `
                    <div class="user-avatar">${(userData.name || userData.email || 'U').charAt(0).toUpperCase()}</div>
                    <div class="user-info">
                        <div class="user-name">${userData.name || userData.email || 'User'}</div>
                        <div class="user-plan">${planDisplay} Plan</div>
                    </div>
                    <button onclick="logout()" style="background: #f85149; border: none; border-radius: 6px; color: white; padding: 0.4rem 0.8rem; font-size: 0.8rem; cursor: pointer; margin-left: 0.5rem;">
                        Logout
                    </button>
                `;
                updateNavItems();
            }
        }

        // Show guest user profile
        function showGuestUser() {
            const userProfile = document.getElementById('userProfile');
            if (userProfile) {
                userProfile.innerHTML = `
                    <div class="user-avatar">👤</div>
                    <div class="user-info">
                        <div class="user-name">Guest User</div>
                        <div class="user-plan">Free Plan - <span style="color: #58a6ff; cursor: pointer;" onclick="window.location.href='/login.html'">Sign In for More</span></div>
                    </div>
                    <button onclick="window.location.href='/login.html'" style="background: #238636; border: none; border-radius: 6px; color: white; padding: 0.4rem 0.8rem; font-size: 0.8rem; cursor: pointer; margin-left: 0.5rem;">
                        Sign In
                    </button>
                `;
                updateNavItems();
            }
        }

        // Logout function
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('user');
            
            isLoggedIn = false;
            authToken = null;
            currentUser = null;
            userChats = [];
            currentChatId = null;
            messageCount = 0;
            
            showGuestUser();
            updateModelSelector();
            showWelcomeScreen();
            
            if (selectedModel !== 'gpt-4o-mini') {
                selectedModel = 'gpt-4o-mini';
                document.getElementById('modelSelector').value = selectedModel;
                addMessage('🔄 Switched to GPT-4o Mini (Guest access)', false, true);
            }
            
            loadC
