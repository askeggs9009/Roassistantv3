<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roblox Luau AI Assistant - Dashboard</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/sidebar.css">
    <link rel="stylesheet" href="styles/chat.css">
    <link rel="stylesheet" href="styles/responsive.css">
</head>
<body>
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-icon">RL</div>
            <div class="sidebar-title">Roblox Assistant</div>
        </div>

        <button class="new-chat-btn" onclick="startNewChat()">
            <span>‚ûï</span>
            New chat
        </button>

        <div class="sidebar-nav">
            <!-- Main Navigation -->
            <div class="nav-section">
                <div class="nav-item active" onclick="setActiveNav(this, 'chats')">
                    <span class="nav-icon">üí¨</span>
                    Chats
                </div>
                <div class="nav-item" onclick="setActiveNav(this, 'projects')">
                    <span class="nav-icon">üìÇ</span>
                    Projects
                </div>
                <div class="nav-item" onclick="setActiveNav(this, 'scripts')">
                    <span class="nav-icon">üîß</span>
                    Scripts
                </div>
            </div>

            <!-- Recent Chats -->
            <div class="nav-section">
                <div class="nav-title">Recents</div>
                <div id="chatHistory">
                    <!-- Chat history will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <div class="sidebar-footer">
            <div class="user-profile" id="userProfile">
                <!-- User profile will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="main-header">
            <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleSidebar()">
                ‚ò∞
            </button>
            <div class="header-title" id="chatTitle">New Chat</div>
            <select class="model-selector" id="modelSelector">
                <option value="gpt-4o-mini">GPT-4o Mini</option>
                <option value="gpt-4.1">GPT-4.1</option>
                <option value="gpt-5">GPT-5</option>
            </select>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <div class="messages-container" id="messagesContainer">
                <!-- Welcome Screen -->
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="welcome-icon">üöÄ</div>
                    <h1 class="welcome-title">Welcome to Roblox Luau AI</h1>
                    <p class="welcome-subtitle">Your intelligent assistant for Roblox game development</p>
                    
                    <div class="quick-actions">
                        <div class="quick-action" onclick="useQuickAction('Create a simple script that makes a part glow when touched')">
                            <span class="action-icon">‚ú®</span>
                            <div class="action-title">Create Script</div>
                            <div class="action-desc">Generate Luau scripts for your Roblox game</div>
                        </div>
                        
                        <div class="quick-action" onclick="useQuickAction('Debug this error: attempt to index nil with HeadQuest')">
                            <span class="action-icon">üêõ</span>
                            <div class="action-title">Debug Code</div>
                            <div class="action-desc">Fix errors and optimize your scripts</div>
                        </div>
                        
                        <div class="quick-action" onclick="useQuickAction('Explain how RemoteEvents work in Roblox')">
                            <span class="action-icon">üìö</span>
                            <div class="action-title">Learn Concepts</div>
                            <div class="action-desc">Understand Roblox development concepts</div>
                        </div>
                        
                        <div class="quick-action" onclick="useQuickAction('Create a shop GUI with purchase functionality')">
                            <span class="action-icon">üéÆ</span>
                            <div class="action-title">Build Systems</div>
                            <div class="action-desc">Design game mechanics and systems</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-container">
                <div class="input-wrapper" id="inputWrapper">
                    <div class="input-content">
                        <!-- File attachments area -->
                        <div class="file-attachments" id="fileAttachments" style="display: none;"></div>
                        
                        <!-- Input row -->
                        <div class="input-row">
                            <button class="attach-button" id="attachButton" onclick="openFileDialog()" title="Add file or image">
                                <span>üìé</span>
                            </button>
                            <textarea 
                                class="input-area" 
                                id="messageInput" 
                                placeholder="Ask me about Roblox scripting, debugging, or game development..."
                                rows="1"
                            ></textarea>
                            <button class="send-button" id="sendButton" onclick="sendMessage()">
                                <span>Send</span>
                            </button>
                        </div>
                    </div>
                </div>
                <input type="file" id="fileInput" accept="image/*,.txt,.lua,.luau,.js,.json,.md" style="display: none;" onchange="handleFileSelect(event)" multiple>
                
                <!-- Drag & Drop Overlay -->
                <div class="drag-overlay" id="dragOverlay" style="display: none;">
                    <div class="drag-content">
                        <div class="drag-icon">üìÅ</div>
                        <div class="drag-text">Drop files here to upload</div>
                        <div class="drag-subtext">Images, code files, and documents</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentChatId = null;
        let chats = JSON.parse(localStorage.getItem('roblox_ai_chats') || '[]');
        let scripts = JSON.parse(localStorage.getItem('roblox_ai_scripts') || '[]');
        let isLoggedIn = false;
        let authToken = null;
        let selectedModel = 'gpt-4o-mini';
        let currentView = 'chats';
        let attachedFiles = [];

        // Usage limits management
        class UsageLimitsManager {
            constructor() {
                this.limits = {};
                this.isAuthenticated = false;
                this.currentUsage = {};
            }

            // Initialize usage limits
            async init() {
                await this.fetchUsageLimits();
                this.updateModelSelector();
                this.showUsageBanner();
            }

            // Fetch current usage limits from server
            async fetchUsageLimits() {
                try {
                    const headers = {};
                    if (authToken) {
                        headers['Authorization'] = `Bearer ${authToken}`;
                    }

                    const response = await fetch('http://localhost:3000/usage-limits', {
                        headers: headers
                    });

                    const data = await response.json();
                    this.isAuthenticated = data.type === 'authenticated';
                    this.limits = data.limits;

                    console.log('Usage limits loaded:', data);
                } catch (error) {
                    console.error('Failed to fetch usage limits:', error);
                }
            }

            // Update model selector with usage info
            updateModelSelector() {
                const modelSelector = document.getElementById('modelSelector');
                if (!modelSelector) return;

                if (this.isAuthenticated) {
                    // Clear any usage indicators for authenticated users
                    Array.from(modelSelector.options).forEach(option => {
                        option.textContent = option.textContent.replace(/ \(\d+\/\d+ left.*?\)/, '');
                        option.disabled = false;
                        option.style.color = '';
                    });
                    return;
                }

                // Update options with usage info for guests
                Array.from(modelSelector.options).forEach(option => {
                    const modelName = option.value;
                    const modelLimits = this.limits[modelName];

                    if (modelLimits) {
                        const remaining = modelLimits.dailyRemaining;
                        const dailyLimit = modelLimits.dailyLimit;
                        
                        // Clean existing usage text
                        option.textContent = option.textContent.replace(/ \(\d+\/\d+ left.*?\)/, '');
                        
                        if (remaining <= 0) {
                            option.textContent += ` (0/${dailyLimit} left - limit reached)`;
                            option.disabled = true;
                            option.style.color = '#f85149';
                        } else if (remaining <= 2) {
                            option.textContent += ` (${remaining}/${dailyLimit} left - almost out!)`;
                            option.style.color = '#d4ac0d';
                        } else {
                            option.textContent += ` (${remaining}/${dailyLimit} left)`;
                            option.style.color = '';
                        }
                    }
                });
            }

            // Show usage banner for guests
            showUsageBanner() {
                if (this.isAuthenticated) {
                    this.hideUsageBanner();
                    return;
                }

                const existingBanner = document.getElementById('usageBanner');
                if (existingBanner) {
                    existingBanner.remove();
                }

                const banner = document.createElement('div');
                banner.id = 'usageBanner';
                banner.style.cssText = `
                    background: linear-gradient(90deg, rgba(88, 166, 255, 0.1), rgba(157, 78, 221, 0.1));
                    border: 1px solid rgba(88, 166, 255, 0.3);
                    border-radius: 8px;
                    padding: 0.75rem 1rem;
                    margin: 0 1rem 1rem 1rem;
                    font-size: 0.85rem;
                    color: #e6edf3;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    flex-wrap: wrap;
                    gap: 0.5rem;
                `;

                const usageInfo = document.createElement('div');
                usageInfo.style.cssText = 'display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;';

                let hasLimits = false;
                Object.entries(this.limits).forEach(([model, limits]) => {
                    if (limits.dailyRemaining !== undefined) {
                        hasLimits = true;
                        const modelDiv = document.createElement('div');
                        const remaining = limits.dailyRemaining;
                        const total = limits.dailyLimit;
                        
                        let color = '#2ea043';
                        if (remaining <= 0) color = '#f85149';
                        else if (remaining <= 2) color = '#d4ac0d';
                        
                        modelDiv.innerHTML = `
                            <span style="font-weight: 500;">${model}:</span> 
                            <span style="color: ${color};">${remaining}/${total}</span>
                        `;
                        usageInfo.appendChild(modelDiv);
                    }
                });

                if (hasLimits) {
                    const upgradeBtn = document.createElement('button');
                    upgradeBtn.textContent = '‚ú® Sign Up for Unlimited';
                    upgradeBtn.style.cssText = `
                        background: linear-gradient(45deg, #238636, #2ea043);
                        border: none;
                        border-radius: 6px;
                        color: white;
                        padding: 0.4rem 0.8rem;
                        font-size: 0.8rem;
                        font-weight: 500;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    `;
                    upgradeBtn.onmouseover = () => upgradeBtn.style.transform = 'translateY(-1px)';
                    upgradeBtn.onmouseout = () => upgradeBtn.style.transform = 'none';
                    upgradeBtn.onclick = () => window.location.href = '/login.html';

                    banner.appendChild(usageInfo);
                    banner.appendChild(upgradeBtn);

                    const mainContent = document.querySelector('.main-content');
                    const mainHeader = document.querySelector('.main-header');
                    if (mainContent && mainHeader) {
                        mainContent.insertBefore(banner, mainHeader.nextSibling);
                    }
                }
            }

            // Hide usage banner
            hideUsageBanner() {
                const banner = document.getElementById('usageBanner');
                if (banner) {
                    banner.remove();
                }
            }

            // Handle usage limit errors
            handleUsageLimitError(error, model) {
                if (error.resetTime) {
                    const resetTime = new Date(error.resetTime);
                    const timeUntilReset = this.getTimeUntilReset(resetTime);
                    
                    this.showLimitReachedModal(error.error, timeUntilReset, model);
                } else {
                    addMessage(`üö´ ${error.error}`, false, true);
                }
            }

            // Get human-readable time until reset
            getTimeUntilReset(resetTime) {
                const now = new Date();
                const diffMs = resetTime - now;
                
                if (diffMs <= 0) return 'now';
                
                const hours = Math.floor(diffMs / (1000 * 60 * 60));
                const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                
                if (hours > 0) {
                    return `${hours}h ${minutes}m`;
                } else {
                    return `${minutes}m`;
                }
            }

            // Show limit reached modal
            showLimitReachedModal(message, timeUntilReset, model) {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.7);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                    padding: 2rem;
                `;

                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: #161b22;
                    border: 1px solid #f85149;
                    border-radius: 12px;
                    padding: 2rem;
                    max-width: 500px;
                    width: 100%;
                    text-align: center;
                `;

                modalContent.innerHTML = `
                    <div style="font-size: 3rem; margin-bottom: 1rem;">‚è∞</div>
                    <h2 style="color: #f85149; margin-bottom: 1rem; font-size: 1.3rem;">Usage Limit Reached</h2>
                    <p style="color: #e6edf3; margin-bottom: 1.5rem; line-height: 1.5;">${message}</p>
                    <p style="color: #8b949e; margin-bottom: 2rem; font-size: 0.9rem;">
                        Reset in: <strong style="color: #58a6ff;">${timeUntilReset}</strong>
                    </p>
                    
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <button onclick="this.closest('.modal-overlay').remove()" style="
                            background: transparent;
                            border: 1px solid #30363d;
                            border-radius: 8px;
                            color: #e6edf3;
                            padding: 0.75rem 1.5rem;
                            cursor: pointer;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.borderColor='#58a6ff'" onmouseout="this.style.borderColor='#30363d'">
                            Close
                        </button>
                        <button onclick="window.location.href='/login.html'" style="
                            background: linear-gradient(45deg, #238636, #2ea043);
                            border: none;
                            border-radius: 8px;
                            color: white;
                            padding: 0.75rem 1.5rem;
                            cursor: pointer;
                            font-weight: 600;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='none'">
                            ‚ú® Sign Up for Unlimited
                        </button>
                    </div>
                `;

                modal.className = 'modal-overlay';
                modal.appendChild(modalContent);
                document.body.appendChild(modal);

                // Auto-close after 10 seconds
                setTimeout(() => {
                    if (modal.parentNode) {
                        modal.remove();
                    }
                }, 10000);
            }

            // Update usage after successful request
            async updateUsageAfterRequest(model, usageInfo) {
                if (usageInfo && !this.isAuthenticated) {
                    // Update local usage tracking
                    if (!this.limits[model]) {
                        this.limits[model] = {};
                    }
                    
                    this.limits[model].dailyUsed = usageInfo.dailyUsed;
                    this.limits[model].dailyRemaining = usageInfo.dailyLimit - usageInfo.dailyUsed;
                    this.limits[model].hourlyUsed = usageInfo.hourlyUsed;
                    this.limits[model].hourlyRemaining = usageInfo.hourlyLimit - usageInfo.hourlyUsed;

                    // Update UI
                    this.updateModelSelector();
                    this.showUsageBanner();

                    // Show warning if almost out of uses
                    if (usageInfo.upgradeMessage) {
                        this.showUpgradePrompt(usageInfo.upgradeMessage);
                    }
                }
            }

            // Show upgrade prompt
            showUpgradePrompt(message) {
                const existingPrompt = document.getElementById('upgradePrompt');
                if (existingPrompt) {
                    existingPrompt.remove();
                }

                const prompt = document.createElement('div');
                prompt.id = 'upgradePrompt';
                prompt.style.cssText = `
                    position: fixed;
                    bottom: 2rem;
                    right: 2rem;
                    background: linear-gradient(45deg, #238636, #2ea043);
                    border: 1px solid #2ea043;
                    border-radius: 12px;
                    padding: 1rem;
                    color: white;
                    font-size: 0.9rem;
                    max-width: 300px;
                    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
                    z-index: 999;
                    animation: slideInRight 0.3s ease;
                `;

                prompt.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                        <div style="font-size: 1.5rem;">‚ö°</div>
                        <div style="font-weight: 600; flex: 1;">Almost Out!</div>
                        <button onclick="this.closest('#upgradePrompt').remove()" style="
                            background: none;
                            border: none;
                            color: rgba(255, 255, 255, 0.7);
                            cursor: pointer;
                            padding: 0.25rem;
                            border-radius: 4px;
                        " onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='none'">
                            √ó
                        </button>
                    </div>
                    <p style="margin: 0 0 1rem 0; line-height: 1.4;">${message}</p>
                    <button onclick="window.location.href='/login.html'" style="
                        background: rgba(255, 255, 255, 0.2);
                        border: 1px solid rgba(255, 255, 255, 0.3);
                        border-radius: 6px;
                        color: white;
                        padding: 0.5rem 1rem;
                        cursor: pointer;
                        font-weight: 500;
                        width: 100%;
                        transition: all 0.2s ease;
                    " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                        Sign Up Now
                    </button>
                `;

                // Add animation keyframes
                if (!document.getElementById('upgradePromptStyles')) {
                    const style = document.createElement('style');
                    style.id = 'upgradePromptStyles';
                    style.textContent = `
                        @keyframes slideInRight {
                            from {
                                transform: translateX(100%);
                                opacity: 0;
                            }
                            to {
                                transform: translateX(0);
                                opacity: 1;
                            }
                        }
                    `;
                    document.head.appendChild(style);
                }

                document.body.appendChild(prompt);

                // Auto-hide after 8 seconds
                setTimeout(() => {
                    if (prompt.parentNode) {
                        prompt.style.animation = 'slideInRight 0.3s ease reverse';
                        setTimeout(() => prompt.remove(), 300);
                    }
                }, 8000);
            }
        }

        // Create global instance
        const usageLimitsManager = new UsageLimitsManager();

        // Initialize the app
        function initApp() {
            console.log('Initializing app...');
            checkAuth();
            loadChatHistory();
            setupEventListeners();
            
            // Initialize usage limits
            setTimeout(() => {
                usageLimitsManager.init();
            }, 500);
        }

        // Setup event listeners
        function setupEventListeners() {
            const messageInput = document.getElementById('messageInput');
            const modelSelector = document.getElementById('modelSelector');

            if (messageInput) {
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                });

                messageInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });

                messageInput.addEventListener('paste', handlePaste);
            }

            if (modelSelector) {
                modelSelector.addEventListener('change', function() {
                    const selectedModel = this.value;
                    
                    // Check if guest is trying to use a model they've reached the limit for
                    if (!usageLimitsManager.isAuthenticated && usageLimitsManager.limits[selectedModel]) {
                        const limits = usageLimitsManager.limits[selectedModel];
                        
                        if (limits.dailyRemaining <= 0) {
                            // Reset to previous valid selection
                            this.value = 'gpt-4o-mini';
                            
                            usageLimitsManager.showLimitReachedModal(
                                `You've reached your daily limit for ${selectedModel}. Try a different model or sign up for unlimited access.`,
                                'tomorrow',
                                selectedModel
                            );
                            return;
                        }
                        
                        if (limits.hourlyRemaining <= 0) {
                            // Reset to previous valid selection
                            this.value = 'gpt-4o-mini';
                            
                            usageLimitsManager.showLimitReachedModal(
                                `You've reached your hourly limit for ${selectedModel}. Try again in an hour or sign up for unlimited access.`,
                                usageLimitsManager.getTimeUntilReset(new Date(Date.now() + 60 * 60 * 1000)),
                                selectedModel
                            );
                            return;
                        }
                    }
                    
                    selectedModel = this.value;
                });
            }

            setupDragAndDrop();
        }

        // Setup drag and drop functionality
        function setupDragAndDrop() {
            const inputContainer = document.getElementById('inputWrapper');
            const dragOverlay = document.getElementById('dragOverlay');
            let dragCounter = 0;

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                document.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                document.addEventListener(eventName, handleDragEnter, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                document.addEventListener(eventName, handleDragLeave, false);
            });

            function handleDragEnter(e) {
                dragCounter++;
                if (dragOverlay && inputContainer) {
                    dragOverlay.style.display = 'flex';
                    inputContainer.classList.add('drag-active');
                }
            }

            function handleDragLeave(e) {
                dragCounter--;
                if (dragCounter === 0) {
                    if (dragOverlay && inputContainer) {
                        dragOverlay.style.display = 'none';
                        inputContainer.classList.remove('drag-active');
                    }
                }
            }

            document.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                dragCounter = 0;
                if (dragOverlay && inputContainer) {
                    dragOverlay.style.display = 'none';
                    inputContainer.classList.remove('drag-active');
                }

                const dt = e.dataTransfer;
                const files = dt.files;

                if (files.length > 0) {
                    handleMultipleFiles(files);
                }
            }
        }

        // Handle paste events
        function handlePaste(e) {
            const items = e.clipboardData.items;
            
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                
                if (item.type.indexOf('image') !== -1) {
                    e.preventDefault();
                    const blob = item.getAsFile();
                    const fileName = `pasted-image-${Date.now()}.png`;
                    
                    addFileToAttachments({
                        file: blob,
                        name: fileName,
                        type: 'image',
                        size: blob.size
                    });
                    return;
                }
                
                if (item.type === 'text/plain') {
                    item.getAsString(function(text) {
                        if (isLikelyCode(text)) {
                            const fileName = `pasted-code-${Date.now()}.txt`;
                            addFileToAttachments({
                                content: text,
                                name: fileName,
                                type: 'text',
                                size: text.length
                            });
                        } else {
                            const messageInput = document.getElementById('messageInput');
                            if (messageInput) {
                                const start = messageInput.selectionStart;
                                const end = messageInput.selectionEnd;
                                const currentValue = messageInput.value;
                                messageInput.value = currentValue.substring(0, start) + text + currentValue.substring(end);
                                messageInput.setSelectionRange(start + text.length, start + text.length);
                            }
                        }
                    });
                }
            }
        }

        // Check if text looks like code
        function isLikelyCode(text) {
            const codeIndicators = [
                'function', 'local', 'end', 'if', 'then', 'else',
                'for', 'while', 'do', 'return', 'require',
                '{', '}', '[', ']', '(', ')',
                '==', '~=', '<=', '>=', 
                'script', 'game', 'workspace'
            ];
            
            const lines = text.split('\n');
            if (lines.length < 3) return false;
            
            let codeScore = 0;
            lines.forEach(line => {
                codeIndicators.forEach(indicator => {
                    if (line.includes(indicator)) codeScore++;
                });
                if (line.match(/^\s{2,}/)) codeScore++;
            });
            
            return codeScore > lines.length * 0.3;
        }

        // Handle multiple files
        function handleMultipleFiles(files) {
            Array.from(files).forEach((file, index) => {
                setTimeout(() => {
                    processFile(file);
                }, index * 100);
            });
        }

        // Process a single file
        function processFile(file) {
            const maxSize = 10 * 1024 * 1024;
            if (file.size > maxSize) {
                alert(`File "${file.name}" is too large. Please select files smaller than 10MB.`);
                return;
            }

            if (file.type.startsWith('image/')) {
                addFileToAttachments({
                    file: file,
                    name: file.name,
                    type: 'image',
                    size: file.size
                });
            } else {
                const reader = new FileReader();
                reader.onload = function(e) {
                    addFileToAttachments({
                        content: e.target.result,
                        name: file.name,
                        type: 'text',
                        size: file.size,
                        mimeType: file.type
                    });
                };
                reader.readAsText(file);
            }
        }

        // Add file to attachments area
        function addFileToAttachments(fileData) {
            const fileAttachments = document.getElementById('fileAttachments');
            const fileId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
            
            attachedFiles.push({
                id: fileId,
                ...fileData
            });

            fileAttachments.style.display = 'flex';

            const attachment = document.createElement('div');
            attachment.className = `file-attachment ${fileData.type}`;
            attachment.dataset.fileId = fileId;

            if (fileData.type === 'image') {
                if (fileData.file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        attachment.innerHTML = `
                            <img src="${e.target.result}" alt="${fileData.name}" class="file-preview">
                            <div class="file-info">
                                <div class="file-name">${fileData.name}</div>
                                <div class="file-size">${formatFileSize(fileData.size)}</div>
                            </div>
                            <button class="file-remove" onclick="removeAttachment('${fileId}')" title="Remove">√ó</button>
                        `;
                    };
                    reader.readAsDataURL(fileData.file);
                } else {
                    attachment.innerHTML = `
                        <div class="file-icon">üñºÔ∏è</div>
                        <div class="file-info">
                            <div class="file-name">${fileData.name}</div>
                            <div class="file-size">${formatFileSize(fileData.size)}</div>
                        </div>
                        <button class="file-remove" onclick="removeAttachment('${fileId}')" title="Remove">√ó</button>
                    `;
                }
            } else {
                const icon = getFileIcon(fileData.name, fileData.mimeType);
                attachment.innerHTML = `
                    <div class="file-icon">${icon}</div>
                    <div class="file-info">
                        <div class="file-name">${fileData.name}</div>
                        <div class="file-size">${formatFileSize(fileData.size)}</div>
                    </div>
                    <button class="file-remove" onclick="removeAttachment('${fileId}')" title="Remove">√ó</button>
                `;
            }

            fileAttachments.appendChild(attachment);

            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.value = '';
            }
        }

        // Remove attachment
        function removeAttachment(fileId) {
            attachedFiles = attachedFiles.filter(file => file.id !== fileId);
            
            const attachment = document.querySelector(`[data-file-id="${fileId}"]`);
            if (attachment) {
                attachment.remove();
            }

            const fileAttachments = document.getElementById('fileAttachments');
            if (attachedFiles.length === 0) {
                fileAttachments.style.display = 'none';
            }
        }

        // Get file icon
        function getFileIcon(fileName, mimeType) {
            const extension = fileName.split('.').pop().toLowerCase();
            
            if (mimeType && mimeType.includes('lua')) return 'üéÆ';
            if (['lua', 'luau'].includes(extension)) return 'üéÆ';
            if (['js', 'json'].includes(extension)) return '‚ö°';
            if (['txt', 'md'].includes(extension)) return 'üìÑ';
            if (mimeType && mimeType.includes('image')) return 'üñºÔ∏è';
            
            return 'üìÑ';
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Check authentication status
        function checkAuth() {
            console.log('Checking auth...');
            authToken = localStorage.getItem('authToken');
            const user = localStorage.getItem('user');

            if (authToken && user) {
                try {
                    const userData = JSON.parse(user);
                    showLoggedInUser(userData);
                    isLoggedIn = true;
                } catch (error) {
                    showGuestUser();
                    isLoggedIn = false;
                }
            } else {
                showGuestUser();
                isLoggedIn = false;
            }
            updateModelSelector();
        }

        // Show logged in user profile
        function showLoggedInUser(userData) {
            const userProfile = document.getElementById('userProfile');
            if (userProfile) {
                userProfile.innerHTML = `
                    <div class="user-avatar">${(userData.name || userData.email || 'U').charAt(0).toUpperCase()}</div>
                    <div class="user-info">
                        <div class="user-name">${userData.name || userData.email || 'User'}</div>
                        <div class="user-plan">Premium User</div>
                    </div>
                    <button onclick="logout()" style="background: #f85149; border: none; border-radius: 6px; color: white; padding: 0.4rem 0.8rem; font-size: 0.8rem; cursor: pointer; margin-left: 0.5rem;">
                        Logout
                    </button>
                `;
                updateNavItems();
                
                // Update usage limits
                usageLimitsManager.isAuthenticated = true;
                usageLimitsManager.hideUsageBanner();
                usageLimitsManager.updateModelSelector();
            }
        }

        // Show guest user profile
        function showGuestUser() {
            const userProfile = document.getElementById('userProfile');
            if (userProfile) {
                userProfile.innerHTML = `
                    <div class="user-avatar">üë§</div>
                    <div class="user-info">
                        <div class="user-name">Guest User</div>
                        <div class="user-plan">Free Plan - <span style="color: #58a6ff; cursor: pointer;" onclick="window.location.href='/login.html'">Sign In for More</span></div>
                    </div>
                    <button onclick="window.location.href='/login.html'" style="background: #238636; border: none; border-radius: 6px; color: white; padding: 0.4rem 0.8rem; font-size: 0.8rem; cursor: pointer; margin-left: 0.5rem;">
                        Sign In
                    </button>
                `;
                updateNavItems();
                
                // Update usage limits
                usageLimitsManager.isAuthenticated = false;
                usageLimitsManager.init();
            }
        }

        // Logout function
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('user');
            isLoggedIn = false;
            authToken = null;
            showGuestUser();
            updateModelSelector();
            
            if (selectedModel !== 'gpt-4o-mini') {
                selectedModel = 'gpt-4o-mini';
                document.getElementById('modelSelector').value = selectedModel;
                addMessage('üîÑ Switched to GPT-4o Mini (Guest access)', false, true);
            }
        }

        // Update model selector
        function updateModelSelector() {
            const modelSelector = document.getElementById('modelSelector');
            if (modelSelector) {
                const options = modelSelector.querySelectorAll('option');
                
                options.forEach(option => {
                    if (option.value !== 'gpt-4o-mini') {
                        option.disabled = !isLoggedIn;
                        option.textContent = isLoggedIn ? 
                            option.textContent.replace(' - Sign in required', '') :
                            option.textContent.includes(' - Sign in required') ? 
                                option.textContent : 
                                option.textContent + ' - Sign in required';
                    }
                });
            }
            
            updateNavItems();
        }

        // Update navigation items
        function updateNavItems() {
            const scriptsNav = document.querySelector('.nav-item[onclick*="scripts"]');
            const projectsNav = document.querySelector('.nav-item[onclick*="projects"]');
            
            if (scriptsNav && projectsNav) {
                if (isLoggedIn) {
                    scriptsNav.style.opacity = '1';
                    scriptsNav.style.cursor = 'pointer';
                    scriptsNav.title = '';
                    
                    projectsNav.style.opacity = '1';
                    projectsNav.style.cursor = 'pointer';
                    projectsNav.title = '';
                } else {
                    scriptsNav.style.opacity = '0.5';
                    scriptsNav.style.cursor = 'not-allowed';
                    scriptsNav.title = 'Sign in required';
                    
                    projectsNav.style.opacity = '0.5';
                    projectsNav.style.cursor = 'not-allowed';
                    projectsNav.title = 'Sign in required';
                }
            }
        }

        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar && overlay) {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('open');
            }
        }

        // Close sidebar
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar && overlay) {
                sidebar.classList.remove('open');
                overlay.classList.remove('open');
            }
        }

        // Set active navigation item
        function setActiveNav(element, section) {
            if ((section === 'scripts' || section === 'projects') && !isLoggedIn) {
                alert('Please sign in to access ' + (section === 'scripts' ? 'Scripts' : 'Projects') + '.');
                return;
            }
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            element.classList.add('active');
            
            currentView = section;
            
            if (section === 'chats') {
                loadChatHistory();
            } else if (section === 'scripts') {
                loadScriptsView();
            } else if (section === 'projects') {
                window.location.href = '/projects.html';
            }
        }

        // Start new chat
        function startNewChat() {
            currentChatId = null;
            document.getElementById('chatTitle').textContent = 'New Chat';
            showWelcomeScreen();
            clearAttachments();
            
            const firstNavItem = document.querySelector('.nav-item');
            if (firstNavItem) {
                setActiveNav(firstNavItem, 'chats');
            }
            closeSidebar();
        }

        // Show welcome screen
        function showWelcomeScreen() {
            const messagesContainer = document.getElementById('messagesContainer');
            if (messagesContainer) {
                messagesContainer.innerHTML = `
                    <div class="welcome-screen" id="welcomeScreen">
                        <div class="welcome-icon">üöÄ</div>
                        <h1 class="welcome-title">Welcome to Roblox Luau AI</h1>
                        <p class="welcome-subtitle">Your intelligent assistant for Roblox game development</p>
                        
                        <div class="quick-actions">
                            <div class="quick-action" onclick="useQuickAction('Create a simple script that makes a part glow when touched')">
                                <span class="action-icon">‚ú®</span>
                                <div class="action-title">Create Script</div>
                                <div class="action-desc">Generate Luau scripts for your Roblox game</div>
                            </div>
                            
                            <div class="quick-action" onclick="useQuickAction('Debug this error: attempt to index nil with HeadQuest')">
                                <span class="action-icon">üêõ</span>
                                <div class="action-title">Debug Code</div>
                                <div class="action-desc">Fix errors and optimize your scripts</div>
                            </div>
                            
                            <div class="quick-action" onclick="useQuickAction('Explain how RemoteEvents work in Roblox')">
                                <span class="action-icon">üìö</span>
                                <div class="action-title">Learn Concepts</div>
                                <div class="action-desc">Understand Roblox development concepts</div>
                            </div>
                            
                            <div class="quick-action" onclick="useQuickAction('Create a shop GUI with purchase functionality')">
                                <span class="action-icon">üéÆ</span>
                                <div class="action-title">Build Systems</div>
                                <div class="action-desc">Design game mechanics and systems</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Show usage info for guests
            setTimeout(updateWelcomeScreenWithUsage, 100);
        }

        // Show usage limits in welcome screen for guests
        function updateWelcomeScreenWithUsage() {
            if (usageLimitsManager.isAuthenticated) return;
            
            const welcomeScreen = document.getElementById('welcomeScreen');
            if (!welcomeScreen) return;
            
            const existingUsageInfo = welcomeScreen.querySelector('.usage-limits-info');
            if (existingUsageInfo) {
                existingUsageInfo.remove();
            }
            
            const quickActions = welcomeScreen.querySelector('.quick-actions');
            if (quickActions && Object.keys(usageLimitsManager.limits).length > 0) {
                const usageInfo = document.createElement('div');
                usageInfo.className = 'usage-limits-info';
                usageInfo.style.cssText = `
                    background: rgba(33, 38, 45, 0.6);
                    border: 1px solid #30363d;
                    border-radius: 12px;
                    padding: 1.5rem;
                    margin-top: 2rem;
                    text-align: center;
                `;
                
                let hasLimits = false;
                let usageHTML = '<h3 style="color: #58a6ff; margin-bottom: 1rem; font-size: 1.1rem;">üìä Your Usage Today</h3>';
                usageHTML += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">';
                
                Object.entries(usageLimitsManager.limits).forEach(([model, limits]) => {
                    if (limits.dailyRemaining !== undefined) {
                        hasLimits = true;
                        const used = limits.dailyUsed || 0;
                        const total = limits.dailyLimit;
                        const percentage = Math.round((used / total) * 100);
                        
                        let statusColor = '#2ea043';
                        let statusText = 'Available';
                        if (used >= total) {
                            statusColor = '#f85149';
                            statusText = 'Limit Reached';
                        } else if (used >= total - 2) {
                            statusColor = '#d4ac0d';
                            statusText = 'Almost Full';
                        }
                        
                        usageHTML += `
                            <div style="background: rgba(255, 255, 255, 0.02); border-radius: 8px; padding: 1rem;">
                                <div style="font-weight: 600; margin-bottom: 0.5rem; color: #f0f6fc;">${model}</div>
                                <div style="color: ${statusColor}; font-size: 1.2rem; font-weight: bold; margin-bottom: 0.25rem;">${used}/${total}</div>
                                <div style="color: #8b949e; font-size: 0.8rem;">${statusText}</div>
                                <div style="background: #21262d; height: 4px; border-radius: 2px; margin-top: 0.5rem; overflow: hidden;">
                                    <div style="background: ${statusColor}; height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                usageHTML += '</div>';
                
                if (hasLimits) {
                    usageHTML += `
                        <p style="color: #8b949e; margin-bottom: 1rem; font-size: 0.9rem;">
                            Sign up for <strong style="color: #58a6ff;">unlimited access</strong> to all models!
                        </p>
                        <button onclick="window.location.href='/login.html'" style="
                            background: linear-gradient(45deg, #238636, #2ea043);
                            border: none;
                            border-radius: 8px;
                            color: white;
                            padding: 0.75rem 2rem;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            font-size: 0.95rem;
                        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='none'">
                            ‚ú® Get Unlimited Access
                        </button>
                    `;
                    
                    usageInfo.innerHTML = usageHTML;
                    quickActions.parentNode.insertBefore(usageInfo, quickActions.nextSibling);
                }
            }
        }

        // Use quick action
        function useQuickAction(prompt) {
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.value = prompt;
                sendMessage();
            }
        }

        // File handling functions
        function openFileDialog() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.click();
            }
        }

        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length > 0) {
                handleMultipleFiles(files);
            }
        }

        // Clear all attachments
        function clearAttachments() {
            attachedFiles = [];
            const fileAttachments = document.getElementById('fileAttachments');
            if (fileAttachments) {
                fileAttachments.innerHTML = '';
                fileAttachments.style.display = 'none';
            }
        }

        // Send message function with usage limits integration
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            
            if (!messageInput || !sendButton) return;
            
            const message = messageInput.value.trim();
            
            if (!message && attachedFiles.length === 0) return;

            sendButton.disabled = true;
            sendButton.textContent = 'Sending...';
            
            if (attachedFiles.length > 0) {
                for (const fileData of attachedFiles) {
                    await addFileToChat(fileData);
                }
            }

            if (message) {
                addMessage(message, true);
            }
            
            let combinedPrompt = '';
            
            if (attachedFiles.length > 0) {
                combinedPrompt += 'I have attached the following files:\n\n';
                attachedFiles.forEach((file, index) => {
                    combinedPrompt += `${index + 1}. ${file.name} (${file.type})\n`;
                    if (file.content) {
                        combinedPrompt += `Content:\n${file.content}\n\n`;
                    }
                });
            }
            
            if (message) {
                combinedPrompt += message;
            }
            
            messageInput.value = '';
            messageInput.style.height = 'auto';
            clearAttachments();

            try {
                const headers = { "Content-Type": "application/json" };
                
                if (isLoggedIn && authToken) {
                    headers["Authorization"] = `Bearer ${authToken}`;
                }

                const response = await fetch("http://localhost:3000/ask", {
                    method: "POST",
                    headers: headers,
                    body: JSON.stringify({ 
                        prompt: combinedPrompt,
                        model: selectedModel 
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.reply) {
                        addMessage(data.reply, false);
                        
                        // Update usage info for guests
                        if (data.usageInfo) {
                            await usageLimitsManager.updateUsageAfterRequest(selectedModel, data.usageInfo);
                        }
                    } else {
                        addMessage('‚ö†Ô∏è Error: ' + (data.error || 'Unknown error occurred'), false);
                    }
                } else if (response.status === 429) {
                    // Handle usage limit errors
                    usageLimitsManager.handleUsageLimitError(data, selectedModel);
                } else {
                    if (response.status === 403 && data.requiresAuth) {
                        addMessage(`üîí ${data.error}`, false, true);
                        
                        if (data.availableModel) {
                            selectedModel = data.availableModel;
                            document.getElementById('modelSelector').value = selectedModel;
                            addMessage(`üîÑ Switched to ${selectedModel} (available for guests)`, false, true);
                        }
                    } else {
                        addMessage('‚ö†Ô∏è Error: ' + (data.error || 'Unknown error occurred'), false);
                    }
                }
            } catch (error) {
                addMessage('‚ö†Ô∏è Connection Error: Make sure your server is running on http://localhost:3000', false);
            } finally {
                sendButton.disabled = false;
                sendButton.textContent = 'Send';
                messageInput.focus();
            }
        }

        // Add file to chat display
        async function addFileToChat(fileData) {
            const welcomeScreen = document.getElementById('welcomeScreen');
            if (welcomeScreen) {
                welcomeScreen.remove();
            }

            const messagesContainer = document.getElementById('messagesContainer');
            if (!messagesContainer) return;

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = 'U';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const messageText = document.createElement('div');
            messageText.className = 'message-text';
            
            if (fileData.type === 'image') {
                let imageSrc = '';
                if (fileData.file) {
                    const reader = new FileReader();
                    imageSrc = await new Promise((resolve) => {
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(fileData.file);
                    });
                }
                
                messageText.innerHTML = `
                    <div style="margin-bottom: 0.5rem;">
                        <strong>üì∑ ${fileData.name}</strong>
                    </div>
                    ${imageSrc ? `<img src="${imageSrc}" alt="${fileData.name}" style="max-width: 100%; max-height: 300px; border-radius: 8px; display: block;">` : ''}
                `;
            } else {
                const preview = fileData.content.length > 500 ? fileData.content.substring(0, 500) + '...' : fileData.content;
                const icon = getFileIcon(fileData.name, fileData.mimeType);
                messageText.innerHTML = `
                    <div style="margin-bottom: 0.5rem;">
                        <strong>${icon} ${fileData.name}</strong>
                    </div>
                    <div style="background: #0d1117; border: 1px solid #21262d; border-radius: 6px; padding: 1rem; margin: 0.5rem 0; overflow-x: auto;">
                        <pre style="margin: 0; font-family: monospace; font-size: 0.85rem; color: #e6edf3; white-space: pre-wrap;">${escapeHtml(preview)}</pre>
                    </div>
                `;
            }
            
            contentDiv.appendChild(messageText);
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            const fileMessage = fileData.type === 'image' ? 
                `[Image: ${fileData.name}]` : 
                `[File: ${fileData.name}]\n\n${fileData.content}`;
            
            saveMessageToChat(fileMessage, true);
        }

        // Add message to chat
        function addMessage(content, isUser = false, isSystem = false) {
            const welcomeScreen = document.getElementById('welcomeScreen');
            if (welcomeScreen) {
                welcomeScreen.remove();
            }

            const messagesContainer = document.getElementById('messagesContainer');
            if (!messagesContainer) return;

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
            
            if (isSystem) {
                messageDiv.style.opacity = '0.8';
                messageDiv.style.fontSize = '0.9rem';
            }
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = isUser ? 'U' : (isSystem ? '‚öôÔ∏è' : 'AI');
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const messageText = document.createElement('div');
            messageText.className = 'message-text';
            messageText.innerHTML = formatMessageContent(content);
            
            contentDiv.appendChild(messageText);
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            if (!isSystem) {
                saveMessageToChat(content, isUser);
                
                if (!isUser) {
                    const chatTitle = document.getElementById('chatTitle').textContent;
                    extractAndSaveScripts(content, chatTitle);
                }
            }
        }

        // Format message content
        function formatMessageContent(content) {
            content = content.replace(/```(?:lua|luau)?\n?([\s\S]*?)```/g, (match, code) => {
                return `
                    <div style="background: #0d1117; border: 1px solid #21262d; border-radius: 6px; padding: 1rem; margin: 0.5rem 0; overflow-x: auto;">
                        <div style="color: #8b949e; font-size: 0.8rem; margin-bottom: 0.5rem; border-bottom: 1px solid #21262d; padding-bottom: 0.5rem;">Luau Script</div>
                        <pre style="margin: 0; font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, monospace; font-size: 0.85rem; color: #e6edf3;"><code>${escapeHtml(code.trim())}</code></pre>
                    </div>
                `;
            });
            
            content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            content = content.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            content = content.replace(/`([^`]+)`/g, '<code style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; font-family: monospace;">$1</code>');
            content = content.replace(/\n/g, '<br>');
            
            return content;
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Save message to current chat
        function saveMessageToChat(content, isUser) {
            if (!currentChatId) {
                currentChatId = Date.now().toString();
                const title = content.length > 50 ? content.substring(0, 50) + '...' : content;
                
                const newChat = {
                    id: currentChatId,
                    title: title,
                    messages: [],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                chats.push(newChat);
                const chatTitle = document.getElementById('chatTitle');
                if (chatTitle) {
                    chatTitle.textContent = title;
                }
            }

            const chat = chats.find(c => c.id === currentChatId);
            if (chat) {
                chat.messages.push({
                    content: content,
                    isUser: isUser,
                    timestamp: new Date().toISOString()
                });
                chat.updatedAt = new Date().toISOString();
                
                localStorage.setItem('roblox_ai_chats', JSON.stringify(chats));
                loadChatHistory();
            }
        }

        // Load chat history
        function loadChatHistory() {
            const chatHistory = document.getElementById('chatHistory');
            if (!chatHistory) return;
            
            if (chats.length === 0) {
                chatHistory.innerHTML = `
                    <div style="padding: 1rem; text-align: center; color: #8b949e; font-size: 0.85rem;">
                        No chats yet<br>
                        <small>Start a new conversation!</small>
                    </div>
                `;
                return;
            }

            const sortedChats = [...chats].sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
            
            chatHistory.innerHTML = sortedChats.map(chat => {
                const timeAgo = getTimeAgo(new Date(chat.updatedAt));
                return `
                    <div class="chat-item ${chat.id === currentChatId ? 'active' : ''}" 
                         data-chat-id="${chat.id}" 
                         onclick="loadChat('${chat.id}')">
                        <div class="chat-title">${chat.title}</div>
                        <div class="chat-time">${timeAgo}</div>
                        <div class="chat-menu">
                            <button class="menu-btn" onclick="deleteChat('${chat.id}', event)" title="Delete chat">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load a specific chat
        function loadChat(chatId) {
            const chat = chats.find(c => c.id === chatId);
            if (!chat) return;

            currentChatId = chatId;
            const chatTitle = document.getElementById('chatTitle');
            if (chatTitle) {
                chatTitle.textContent = chat.title;
            }
            
            const messagesContainer = document.getElementById('messagesContainer');
            if (messagesContainer) {
                messagesContainer.innerHTML = '';
                
                chat.messages.forEach(message => {
                    addMessage(message.content, message.isUser, false);
                });
            }

            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-chat-id="${chatId}"]`)?.classList.add('active');
            
            const firstNavItem = document.querySelector('.nav-item');
            if (firstNavItem) {
                setActiveNav(firstNavItem, 'chats');
            }
            closeSidebar();
        }

        // Delete chat
        function deleteChat(chatId, event) {
            event.stopPropagation();
            
            if (confirm('Are you sure you want to delete this chat?')) {
                chats = chats.filter(c => c.id !== chatId);
                localStorage.setItem('roblox_ai_chats', JSON.stringify(chats));
                loadChatHistory();
                
                if (currentChatId === chatId) {
                    startNewChat();
                }
            }
        }

        // Get time ago string
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Now';
            if (diffMins < 60) return `${diffMins}m`;
            if (diffHours < 24) return `${diffHours}h`;
            if (diffDays < 7) return `${diffDays}d`;
            return date.toLocaleDateString();
        }

        // Scripts functionality
        function loadScriptsView() {
            const chatHistory = document.getElementById('chatHistory');
            if (chatHistory) {
                chatHistory.innerHTML = `
                    <div style="padding: 1rem; text-align: center; color: #8b949e; font-size: 0.85rem;">
                        Scripts feature coming soon!<br>
                        <small>Generated scripts will appear here</small>
                    </div>
                `;
            }
        }

        // Extract and save scripts
        function extractAndSaveScripts(content, chatTitle) {
            const codeBlockRegex = /```(?:lua|luau)?\n?([\s\S]*?)```/g;
            let match;
            
            while ((match = codeBlockRegex.exec(content)) !== null) {
                const scriptContent = match[1].trim();
                if (scriptContent.length > 50) {
                    console.log('Script detected:', scriptContent.substring(0, 100) + '...');
                }
            }
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing app...');
            initApp();
        });
    </script>
</body>
</html>