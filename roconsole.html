<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoAssistant - RoConsole</title>
    <link rel="icon" type="image/png" href="/roassistant-logo.png">

    <!-- Redirect to unified interface -->
    <script>
        // Redirect roconsole.html to index.html, preserving query parameters
        window.location.href = '/index.html' + window.location.search;
    </script>

    <link rel="stylesheet" href="styles/liquid-glass.css">
    <link rel="stylesheet" href="styles/dot-grid.css">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/sidebar.css">
    <link rel="stylesheet" href="styles/chat.css">
    <link rel="stylesheet" href="styles/animations.css">
    <link rel="stylesheet" href="styles/responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* Subscription Status Styles */
        .subscription-status {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem 1rem;
            background: rgba(33, 38, 45, 0.6);
            border: 1px solid #30363d;
            border-radius: 8px;
            margin-right: 1rem;
        }

        .plan-badge {
            background: linear-gradient(45deg, #58a6ff, #1f6feb);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .plan-badge.free {
            background: linear-gradient(45deg, #8b949e, #6e7681);
        }

        .plan-badge.pro {
            background: linear-gradient(45deg, #58a6ff, #1f6feb);
        }

        .plan-badge.enterprise {
            background: linear-gradient(45deg, #9d4edd, #7c3aed);
        }

        /* Project Context Styles */
        .project-files-info {
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid rgba(88, 166, 255, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .welcome-content a {
            color: #58a6ff;
            text-decoration: none;
        }

        .welcome-content a:hover {
            text-decoration: underline;
        }

        .usage-counter {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #8b949e;
            font-size: 0.85rem;
        }

        .usage-bar {
            width: 100px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .usage-fill {
            height: 100%;
            background: linear-gradient(90deg, #58a6ff, #1f6feb);
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        .usage-fill.warning {
            background: linear-gradient(90deg, #d4ac0d, #f39c12);
        }

        .usage-fill.danger {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }

        /* Roblox Connection Status Styles */
        .roblox-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            background: rgba(33, 38, 45, 0.6);
            border: 1px solid #30363d;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-right: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .roblox-status:hover {
            background: rgba(33, 38, 45, 0.8);
            border-color: #484f58;
        }

        .roblox-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .roblox-status-dot.connected {
            background: #57f287;
            box-shadow: 0 0 8px rgba(87, 242, 135, 0.6);
        }

        .roblox-status-dot.disconnected {
            background: #ed4245;
            box-shadow: 0 0 8px rgba(237, 66, 69, 0.6);
        }

        .roblox-status-text {
            color: #8b949e;
            font-weight: 500;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Send to Roblox Button */
        .send-to-roblox-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            transition: all 0.2s ease;
            margin-left: 0.5rem;
        }

        .send-to-roblox-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
        }

        .send-to-roblox-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .send-to-roblox-btn i {
            font-size: 0.9rem;
        }

        .usage-fill.danger {
            background: linear-gradient(90deg, #f85149, #da3633);
        }

        /* Explorer Panel Styles */
        .explorer-panel {
            position: fixed;
            right: 0;
            top: 0;
            width: 300px;
            height: 100vh;
            background: rgba(22, 27, 34, 0.95);
            backdrop-filter: blur(10px);
            border-left: 1px solid #30363d;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease, right 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .explorer-panel.hidden {
            transform: translateX(100%);
        }

        /* Shift Explorer left when code panel is open */
        /* Initial position - will be overridden by JS with actual code panel width */
        body.code-panel-open .explorer-panel {
            right: 50%;
        }

        .explorer-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            border-bottom: 1px solid #30363d;
            background: rgba(33, 38, 45, 0.6);
        }

        .explorer-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            font-weight: 600;
            color: #c9d1d9;
        }

        .explorer-title i {
            color: #58a6ff;
        }

        .explorer-refresh, .explorer-toggle {
            background: transparent;
            border: none;
            color: #8b949e;
            cursor: pointer;
            padding: 0.4rem;
            border-radius: 6px;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .explorer-refresh:hover, .explorer-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #c9d1d9;
        }

        .explorer-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            color: #8b949e;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid #30363d;
        }

        .explorer-status i {
            font-size: 0.5rem;
            color: #ed4245;
        }

        .explorer-status.connected i {
            color: #57f287;
        }

        .explorer-content {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .explorer-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #8b949e;
            text-align: center;
        }

        .explorer-empty i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .explorer-empty p {
            font-size: 0.9rem;
        }

        /* Explorer Tree Styles */
        .explorer-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.3rem 0.5rem;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.15s ease;
            user-select: none;
            font-size: 0.85rem;
        }

        .explorer-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .explorer-item-icon {
            width: 16px;
            text-align: center;
            flex-shrink: 0;
        }

        .explorer-item-toggle {
            color: #8b949e;
            font-size: 0.7rem;
            width: 12px;
            flex-shrink: 0;
        }

        .explorer-item-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .explorer-item-name {
            color: #c9d1d9;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .explorer-item-class {
            color: #8b949e;
            font-size: 0.75rem;
            opacity: 0.7;
        }

        .explorer-children {
            margin-left: 1rem;
            border-left: 1px solid rgba(255, 255, 255, 0.05);
            padding-left: 0.5rem;
        }

        .explorer-children.collapsed {
            display: none;
        }

        /* Icon colors for different instance types */
        .icon-script { color: #58a6ff; }
        .icon-localscript { color: #79c0ff; }
        .icon-modulescript { color: #f85149; }
        .icon-folder { color: #8b949e; }
        .icon-part { color: #57f287; }
        .icon-model { color: #d2a8ff; }
        .icon-screengui { color: #f0883e; }
        .icon-default { color: #8b949e; }

        /* Adjust main content when explorer is visible */
        .main-content.explorer-visible {
            margin-right: 300px;
        }

        /* Script Viewer Modal */
        .script-viewer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .script-viewer-modal.active {
            display: flex;
        }

        .script-viewer-content {
            background: rgba(22, 27, 34, 0.95);
            border: 1px solid #30363d;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .script-viewer-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #30363d;
            background: rgba(33, 38, 45, 0.6);
            border-radius: 12px 12px 0 0;
        }

        .script-viewer-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: #c9d1d9;
        }

        .script-viewer-title i {
            color: #58a6ff;
        }

        .script-viewer-close {
            background: transparent;
            border: none;
            color: #8b949e;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.2s ease;
            font-size: 1.2rem;
        }

        .script-viewer-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #c9d1d9;
        }

        .script-viewer-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .script-viewer-body pre {
            margin: 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 1rem;
        }

        .script-viewer-body code {
            color: #c9d1d9;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* Make script items clickable */
        .explorer-item.script-item {
            cursor: pointer;
        }

        .explorer-item.script-item:hover {
            background: rgba(88, 166, 255, 0.15);
        }

        .explorer-item.script-item:hover .explorer-item-name {
            color: #58a6ff;
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="roassistant-logo.png" alt="RoAssistant Logo" class="sidebar-logo" style="width: 40px; height: 40px; object-fit: contain;">
            <div class="sidebar-title">RoAssistant</div>
        </div>

        <button class="new-chat-btn" onclick="startNewChat()">
            <span>+</span>
            New chat
        </button>

        <div class="sidebar-nav">
            <!-- Main Navigation -->
            <div class="nav-section">
                <div class="nav-item" onclick="window.location.href='/index.html'">
                    <span class="nav-icon"><i class="fas fa-comments"></i></span>
                    Chats
                </div>
                <div class="nav-item" onclick="window.location.href='/projects.html'">
                    <span class="nav-icon"><i class="fas fa-folder"></i></span>
                    Projects
                </div>
                <div class="nav-item active" onclick="window.location.href='/roconsole.html'">
                    <span class="nav-icon"><i class="fas fa-cube"></i></span>
                    RoConsole
                </div>
                <div class="nav-item" onclick="window.location.href='/scripts.html'">
                    <span class="nav-icon"><i class="fas fa-wrench"></i></span>
                    Scripts
                </div>
                <div class="nav-item authenticated-only" onclick="window.location.href='/account.html'" style="color: #8b949e;">
                    <span class="nav-icon">⚙️</span>
                    Account
                </div>
                <div class="nav-item" onclick="window.location.href='/pricing.html'" style="color: #58a6ff;">
                    <span class="nav-icon"><i class="fas fa-gem"></i></span>
                    Upgrade Plan
                </div>
            </div>

            <!-- Recent Chats -->
            <div class="nav-section">
                <div class="nav-title">Recents</div>
                <div id="chatHistory">
                    <!-- Chat history will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <div class="sidebar-footer">
            <div class="user-profile" id="userProfile">
                <!-- Default Sign In button - will be replaced by JavaScript -->
                <div class="user-avatar"><i class="fas fa-user"></i></div>
                <div class="user-info">
                    <div class="user-name">Guest User</div>
                    <div class="user-plan">Free Plan - <span style="color: #58a6ff; cursor: pointer;" onclick="window.location.href='/login.html'">Sign In for More</span></div>
                </div>
                <button onclick="window.location.href='/login.html'" style="background: #238636; border: none; border-radius: 6px; color: white; padding: 0.4rem 0.8rem; font-size: 0.8rem; cursor: pointer; margin-left: 0.5rem;">
                    Sign In
                </button>
            </div>
        </div>
    </div>

    <!-- Code Panel (for displaying code blocks) -->
    <div class="code-panel-overlay" id="codePanel">
        <div class="code-panel-resize-handle" id="codePanelResizeHandle"></div>
        <div class="code-panel-header">
            <div class="code-panel-title">
                <i class="fas fa-code"></i>
                <span>Code Output</span>
            </div>
            <button class="code-panel-close" onclick="closeCodePanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="code-panel-content" id="codePanelContent">
            <!-- Code blocks will be displayed here -->
        </div>
    </div>

    <!-- Explorer Panel -->
    <div class="explorer-panel" id="explorerPanel">
        <div class="explorer-header">
            <div class="explorer-title">
                <i class="fas fa-folder-tree"></i>
                <span>Explorer</span>
            </div>
            <button class="explorer-refresh" id="explorerRefreshBtn" title="Refresh Explorer">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="explorer-toggle" id="explorerToggleBtn" title="Close Explorer">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="explorer-status" id="explorerStatus">
            <i class="fas fa-circle"></i>
            <span>Disconnected</span>
        </div>
        <div class="explorer-content" id="explorerContent">
            <div class="explorer-empty">
                <i class="fas fa-cube"></i>
                <p>Connect Roblox Studio to view Explorer</p>
            </div>
        </div>
    </div>

    <!-- Script Viewer Modal -->
    <div class="script-viewer-modal" id="scriptViewerModal">
        <div class="script-viewer-content">
            <div class="script-viewer-header">
                <div class="script-viewer-title">
                    <i class="fas fa-file-code"></i>
                    <span id="scriptViewerName">Script</span>
                </div>
                <button class="script-viewer-close" onclick="closeScriptViewer()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="script-viewer-body">
                <pre><code id="scriptViewerCode" class="language-lua"></code></pre>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Header -->
        <div class="main-header">
            <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleSidebar()">
                ☰
            </button>
            <div class="header-title" id="chatTitle">New Chat</div>

            <!-- Subscription Status -->
            <div class="subscription-status" id="subscriptionStatus" style="display: none;">
                <a href="/account.html" style="text-decoration: none;">
                    <div class="plan-badge" id="planBadge" style="cursor: pointer; transition: transform 0.2s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'" title="View Account Details">Free</div>
                </a>
                <div class="usage-counter">
                    <span id="usageText">0/10</span>
                    <div class="usage-bar">
                        <div class="usage-fill" id="usageFill" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <div class="messages-container" id="messagesContainer">
                <!-- Welcome Screen -->
                <div class="welcome-screen stagger-animation" id="welcomeScreen">
                    <div class="welcome-icon"><i class="fas fa-rocket"></i></div>
                    <h1 class="welcome-title" data-text="Welcome to RoAssistant">Welcome to RoAssistant</h1>
                    <p class="welcome-subtitle">Your intelligent assistant for Roblox game development</p>
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-container">
                <div class="input-wrapper" id="inputWrapper">
                    <div class="input-content">
                        <!-- File attachments area -->
                        <div class="file-attachments" id="fileAttachments" style="display: none;"></div>

                        <!-- Roblox Studio Connection Status -->
                        <div class="roblox-status-banner" style="padding: 10px 16px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(88, 101, 242, 0.05);">
                            <i class="fas fa-cube" style="font-size: 16px; color: #5865f2;"></i>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; color: rgba(255,255,255,0.9); font-weight: 500;">Roblox Studio Connection</div>
                                <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 2px;">Auto-sends Lua scripts to connected Studio</div>
                            </div>
                            <div id="robloxStatus" style="display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: rgba(0,0,0,0.2); border-radius: 12px;">
                                <div id="robloxStatusDot" style="width: 10px; height: 10px; border-radius: 50%; background: #666;"></div>
                                <span id="robloxStatusText" style="font-size: 12px; font-weight: 500;">Checking...</span>
                            </div>
                        </div>

                        <!-- Input row -->
                        <div class="input-row">
                            <button class="model-button" id="modelButton" onclick="toggleModelSelector()" title="Select AI Model">
                                <span><i class="fas fa-sliders-h"></i></span>
                            </button>

                            <!-- Model Selector Dropdown -->
                            <div class="model-dropdown" id="modelDropdown" style="display: none;">
                                <div class="model-dropdown-header">Select Model</div>
                                <div class="model-option selected" data-model="claude-4-sonnet" onclick="selectModel('claude-4-sonnet')">
                                    <div class="model-name">RoCode 3</div>
                                    <i class="fas fa-check model-check"></i>
                                </div>
                                <div class="model-option premium" data-model="claude-4-opus" onclick="selectModel('claude-4-opus')">
                                    <div class="model-name">RoCode Nexus 3</div>
                                    <i class="fas fa-check model-check" style="display: none;"></i>
                                </div>
                            </div>

                            <textarea
                                class="input-area"
                                id="messageInput"
                                placeholder="Ask me about your project..."
                                rows="1"
                            ></textarea>
                            <button class="send-button" id="sendButton" onclick="sendMessage()">
                                <span>Send</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DYNAMIC API CONFIGURATION
        const getApiBaseUrl = () => {
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                return 'http://localhost:3000';
            }
            return 'https://roassistantv3-production.up.railway.app';
        };

        const API_BASE_URL = getApiBaseUrl();
        console.log(`[CONFIG] Using API Base URL: ${API_BASE_URL}`);

        // Global variables
        let selectedModel = 'claude-4-sonnet';
        window.selectedModel = selectedModel;
        let currentProject = null;
        let currentChatName = 'New Chat';

        // RoConsole doesn't need project loading - it's a standalone Roblox chat
        function loadProjectFromUrl() {
            // No project loading for RoConsole
            console.log('RoConsole loaded - ready for Roblox coding');
        }

        // No project artifacts for RoConsole
        function displayProjectArtifacts() {
            // RoConsole doesn't use projects
        }

        // Simple chat title for RoConsole
        function updateChatTitle() {
            const chatTitle = document.getElementById('chatTitle');
            if (!chatTitle) return;
            chatTitle.textContent = currentChatName;
        }

        // Update chat name when it changes
        window.updateChatName = function(newName) {
            currentChatName = newName || 'New Chat';
            updateChatTitle();
        }

        // Global sendMessage wrapper
        function sendMessage() {
            if (window.chatManager) {
                window.chatManager.sendMessage();
            } else {
                console.error('ChatManager not initialized');
            }
        }

        // Toggle model selector dropdown
        function toggleModelSelector() {
            const dropdown = document.getElementById('modelDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        // Select a model
        function selectModel(model) {
            selectedModel = model;
            window.selectedModel = selectedModel;

            // Update selected state in dropdown
            document.querySelectorAll('.model-option').forEach(option => {
                option.classList.remove('selected');
                const check = option.querySelector('.model-check');
                if (check) {
                    check.style.display = 'none';
                }
            });

            const selectedOption = document.querySelector(`.model-option[data-model="${model}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
                const check = selectedOption.querySelector('.model-check');
                if (check) {
                    check.style.display = 'block';
                }
            }

            // Start a new chat when model changes
            startNewChat();

            // Show a message indicating the model change
            const modelName = model === 'claude-4-opus' ? 'RoCode Nexus 3' : 'RoCode 3';
            if (window.chatManager) {
                window.chatManager.addMessage('system', `🔄 Switched to ${modelName}. Starting a new conversation.`);
            }

            // Hide dropdown
            document.getElementById('modelDropdown').style.display = 'none';
        }

        // Start new chat
        function startNewChat() {
            currentChatName = 'New Chat';
            updateChatTitle();
            if (window.chatManager) {
                window.chatManager.startNewChat();
            }
        }

        // Set active nav
        function setActiveNav(element, section) {
            if (section === 'chats') {
                window.location.href = 'index.html';
            } else if (section === 'projects') {
                window.location.href = 'projects.html';
            } else if (section === 'scripts') {
                window.location.href = 'scripts.html';
            }
        }

        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }

        // ============================================
        // ROBLOX AUTO-SEND FUNCTIONALITY
        // ============================================

        let robloxConnected = false;
        let sentCodeBlocks = new Set(); // Track which code blocks we've already sent

        // ============================================
        // STRUCTURED SCRIPT PARSER
        // ============================================

        /**
         * Parse structured Roblox scripts from AI response
         * Looks for <roblox_script> tags with metadata
         * @param {string} response - The AI response text
         * @returns {Array} Array of script objects with {name, type, location, code}
         */
        function parseStructuredScripts(response) {
            const scripts = [];

            // Regex to match <roblox_script> tags with attributes and content
            const scriptRegex = /<roblox_script\s+name="([^"]+)"\s+type="([^"]+)"\s+location="([^"]+)">([\s\S]*?)<\/roblox_script>/gi;

            let match;
            while ((match = scriptRegex.exec(response)) !== null) {
                const [, name, type, location, code] = match;

                scripts.push({
                    name: name.trim(),
                    type: type.trim(),
                    location: location.trim(),
                    code: code.trim(),
                    id: `structured_${Date.now()}_${scripts.length}` // Unique ID
                });

                console.log(`[Parser] Found structured script: ${name} (${type}) -> ${location}`);
            }

            return scripts;
        }

        /**
         * Determine the appropriate scriptType for Roblox Studio
         * @param {string} type - The type from the structured format
         * @returns {string} Roblox script type (Script, LocalScript, or ModuleScript)
         */
        function getScriptType(type) {
            const typeMap = {
                'Script': 'Script',
                'LocalScript': 'LocalScript',
                'ModuleScript': 'ModuleScript',
                'ScreenGui': 'Instance',
                'Frame': 'Instance',
                'TextButton': 'Instance',
                'TextLabel': 'Instance',
                'TextBox': 'Instance',
                'ImageLabel': 'Instance',
                'ImageButton': 'Instance',
                'ScrollingFrame': 'Instance',
                'Folder': 'Instance',
                'RemoteEvent': 'Instance',
                'RemoteFunction': 'Instance',
                'Part': 'Instance',
                'Model': 'Instance',
                'Tool': 'Instance',
                'MeshPart': 'Instance',
                'UnionOperation': 'Instance',
                'WedgePart': 'Instance',
                'CornerWedgePart': 'Instance'
            };

            return typeMap[type] || 'Script';
        }

        // Check Roblox connection status
        async function checkRobloxConnection() {
            try {
                const response = await fetch(`${getApiBaseUrl()}/roblox/connection-status`);
                const data = await response.json();

                robloxConnected = data.connected && data.clients > 0;

                const statusDot = document.getElementById('robloxStatusDot');
                const statusText = document.getElementById('robloxStatusText');

                if (robloxConnected) {
                    statusDot.style.background = '#57f287'; // Green
                    statusText.textContent = 'Connected';
                } else {
                    statusDot.style.background = '#ed4245'; // Red
                    statusText.textContent = 'Disconnected';
                }
            } catch (error) {
                console.error('[Roblox] Failed to check connection:', error);
                const statusDot = document.getElementById('robloxStatusDot');
                const statusText = document.getElementById('robloxStatusText');
                statusDot.style.background = '#666';
                statusText.textContent = 'Error';
            }
        }

        // Send code to Roblox Studio (with support for structured scripts)
        async function sendCodeToRoblox(codeBlock) {
            try {
                // Check if this is a structured script with metadata
                const scriptName = codeBlock.name || codeBlock.summary || codeBlock.id || 'GeneratedScript';
                const scriptType = codeBlock.type ? getScriptType(codeBlock.type) : 'Script';
                const location = codeBlock.location || 'ServerScriptService';
                const code = codeBlock.code || '';

                const response = await fetch(`${getApiBaseUrl()}/roblox/send-script`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: scriptName,
                        code: code,
                        scriptType: scriptType,
                        location: location,
                        instanceType: codeBlock.type || scriptType // Pass original type for instances
                    })
                });

                const result = await response.json();

                if (result.success) {
                    console.log(`[Roblox] ✅ Sent ${codeBlock.type || 'script'}: ${scriptName} to ${location}`);
                    return { success: true, scriptName, location };
                } else {
                    console.error(`[Roblox] ❌ Failed to send script: ${scriptName}`);
                    return { success: false, scriptName, location };
                }
            } catch (error) {
                console.error('[Roblox] Error sending script:', error);
                return { success: false, scriptName: codeBlock.name || codeBlock.summary || 'Unknown' };
            }
        }

        // Send structured scripts to Roblox Studio
        async function sendStructuredScripts(scripts) {
            if (!scripts || scripts.length === 0) {
                console.log('[Roblox] No structured scripts to send');
                return;
            }

            console.log(`[Roblox] Sending ${scripts.length} structured script(s)...`);

            const results = [];
            for (const script of scripts) {
                // Mark as sent to avoid duplicate sending
                sentCodeBlocks.add(script.id);

                const result = await sendCodeToRoblox(script);
                results.push(result);

                // Small delay between scripts to ensure proper ordering
                await new Promise(resolve => setTimeout(resolve, 200));
            }

            // Show notification
            const successCount = results.filter(r => r.success).length;
            const totalCount = results.length;

            if (successCount > 0) {
                showRobloxNotification(`✅ Created ${successCount}/${totalCount} component(s) in Roblox Studio`);
            } else {
                showRobloxNotification(`❌ Failed to create components in Roblox Studio`, 'error');
            }

            return results;
        }

        // Store the last AI response for parsing
        let lastAIResponse = '';

        // Auto-send NEW code blocks to Roblox Studio (always enabled in RoConsole)
        async function autoSendToRoblox(fullResponse) {
            // Only check if we're connected
            if (!robloxConnected) {
                console.log('[Roblox] Not connected to Roblox Studio');
                return;
            }

            // Update last response if provided
            if (fullResponse) {
                lastAIResponse = fullResponse;
            }

            // PRIORITY 1: Check for structured scripts in the AI response
            if (lastAIResponse) {
                const structuredScripts = parseStructuredScripts(lastAIResponse);

                if (structuredScripts.length > 0) {
                    console.log(`[Roblox] Found ${structuredScripts.length} structured script(s) in AI response`);
                    await sendStructuredScripts(structuredScripts);

                    // Clear the response to avoid re-sending
                    lastAIResponse = '';
                    return; // Don't fallback to code blocks
                }
            }

            // FALLBACK: Get all code blocks from global storage (old behavior)
            if (!window._codeBlocks || Object.keys(window._codeBlocks).length === 0) {
                console.log('[Roblox] No code blocks to send');
                return;
            }

            // Find NEW code blocks that haven't been sent yet
            const newBlocks = [];
            for (const blockId in window._codeBlocks) {
                if (!sentCodeBlocks.has(blockId)) {
                    newBlocks.push(window._codeBlocks[blockId]);
                    sentCodeBlocks.add(blockId); // Mark as sent
                }
            }

            if (newBlocks.length === 0) {
                console.log('[Roblox] No new code blocks to send');
                return;
            }

            console.log(`[Roblox] Auto-sending ${newBlocks.length} NEW code block(s)...`);

            const results = [];
            for (const block of newBlocks) {
                const result = await sendCodeToRoblox(block);
                results.push(result);
            }

            // Show notification
            const successCount = results.filter(r => r.success).length;
            const totalCount = results.length;

            if (successCount > 0) {
                // Create a simple toast notification
                showRobloxNotification(`✅ Sent ${successCount}/${totalCount} script(s) to Roblox Studio`);
            } else {
                showRobloxNotification(`❌ Failed to send scripts to Roblox Studio`, 'error');
            }
        }

        // Show notification toast
        function showRobloxNotification(message, type = 'success') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                padding: 12px 20px;
                background: ${type === 'success' ? '#57f287' : '#ed4245'};
                color: #000;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            // Add animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(400px); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);

            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Hook into ChatManager to trigger auto-send when message completes
        function setupRobloxAutoSendHook() {
            // Check connection every 5 seconds
            checkRobloxConnection();
            setInterval(checkRobloxConnection, 5000);

            // Listen for when code blocks are added to the global storage
            // This ensures we wait for the typewriter effect to complete
            let codeBlockCheckInterval = null;
            let lastCodeBlockCount = 0;

            // Override the original addMessage to trigger auto-send when assistant messages complete
            if (window.chatManager) {
                const originalAddMessage = window.chatManager.addMessage.bind(window.chatManager);

                window.chatManager.addMessage = function(role, content, options) {
                    const result = originalAddMessage(role, content, options);

                    // If this is an assistant message, set up code block monitoring
                    if (role === 'assistant') {
                        // Clear any existing interval
                        if (codeBlockCheckInterval) {
                            clearInterval(codeBlockCheckInterval);
                        }

                        // Reset code block count for new message
                        lastCodeBlockCount = 0;

                        // Store the content for structured parsing
                        lastAIResponse = content;

                        // Check if response has structured scripts (immediate send)
                        const hasStructuredScripts = /<roblox_script\s+name="[^"]+"\s+type="[^"]+"\s+location="[^"]+">/.test(content);

                        if (hasStructuredScripts) {
                            // Structured scripts don't use code blocks, send immediately after typewriter
                            console.log('[Roblox] Detected structured scripts, will auto-send after render');
                            setTimeout(() => {
                                console.log('[Roblox] Triggering auto-send for structured scripts');
                                autoSendToRoblox(content);
                            }, 500); // Short delay to ensure rendering completes
                            return result;
                        }

                        // Start checking for code blocks every 200ms (fallback for regular code blocks)
                        let checksWithoutChange = 0;
                        let hasSeenCodeBlocks = false;
                        codeBlockCheckInterval = setInterval(() => {
                            const currentCount = window._codeBlocks ? Object.keys(window._codeBlocks).length : 0;

                            // Don't start stability counter until we've seen at least one code block
                            if (currentCount > 0) {
                                hasSeenCodeBlocks = true;
                            }

                            // Only check stability if we've seen code blocks
                            if (hasSeenCodeBlocks) {
                                // If count hasn't changed for 2 checks (400ms of stability), send
                                if (currentCount === lastCodeBlockCount) {
                                    checksWithoutChange++;

                                    if (checksWithoutChange >= 2) {
                                        // Code blocks are stable, send them
                                        clearInterval(codeBlockCheckInterval);
                                        codeBlockCheckInterval = null;

                                        console.log('[Roblox] Code blocks stable, triggering auto-send');
                                        autoSendToRoblox(content);
                                    }
                                } else {
                                    // Count changed, reset stability counter
                                    checksWithoutChange = 0;
                                    lastCodeBlockCount = currentCount;
                                }
                            }

                            // Safety timeout: after 5 seconds, send anyway (only if we've seen blocks)
                            if (checksWithoutChange >= 25 && hasSeenCodeBlocks) {
                                clearInterval(codeBlockCheckInterval);
                                codeBlockCheckInterval = null;
                                console.log('[Roblox] Timeout reached, sending anyway');
                                autoSendToRoblox(content);
                            }
                        }, 200);
                    }

                    return result;
                };
            }
        }

        // ============================================
        // END ROBLOX FUNCTIONALITY
        // ============================================

        // ============================================
        // EXPLORER PANEL FUNCTIONALITY
        // ============================================

        let explorerVisible = true;
        let explorerData = null;

        // Get icon for instance class
        function getInstanceIcon(className) {
            const iconMap = {
                'Script': 'fas fa-file-code icon-script',
                'LocalScript': 'fas fa-file-code icon-localscript',
                'ModuleScript': 'fas fa-cube icon-modulescript',
                'Folder': 'fas fa-folder icon-folder',
                'Part': 'fas fa-cube icon-part',
                'Model': 'fas fa-cubes icon-model',
                'ScreenGui': 'fas fa-desktop icon-screengui',
                'Frame': 'fas fa-square icon-default',
                'TextButton': 'fas fa-mouse-pointer icon-default',
                'TextLabel': 'fas fa-font icon-default',
                'RemoteEvent': 'fas fa-bolt icon-default',
                'RemoteFunction': 'fas fa-bolt icon-default'
            };

            return iconMap[className] || 'fas fa-circle icon-default';
        }

        // Open script viewer modal
        function openScriptViewer(scriptName, sourceCode) {
            const modal = document.getElementById('scriptViewerModal');
            const nameElement = document.getElementById('scriptViewerName');
            const codeElement = document.getElementById('scriptViewerCode');

            nameElement.textContent = scriptName;
            codeElement.textContent = sourceCode;

            modal.classList.add('active');
        }

        // Close script viewer modal
        function closeScriptViewer() {
            const modal = document.getElementById('scriptViewerModal');
            modal.classList.remove('active');
        }

        // Make closeScriptViewer globally available
        window.closeScriptViewer = closeScriptViewer;

        // Render explorer item
        function renderExplorerItem(item, level = 0) {
            const hasChildren = item.children && item.children.length > 0;
            const isScript = item.source && (item.className === 'Script' || item.className === 'LocalScript' || item.className === 'ModuleScript');

            const itemDiv = document.createElement('div');
            itemDiv.className = 'explorer-item-wrapper';
            itemDiv.style.marginLeft = (level * 0.5) + 'rem';

            const itemHeader = document.createElement('div');
            itemHeader.className = 'explorer-item';

            // Add script-item class if this is a script with source code
            if (isScript) {
                itemHeader.classList.add('script-item');
            }

            // Toggle arrow for items with children
            if (hasChildren) {
                const toggle = document.createElement('span');
                toggle.className = 'explorer-item-toggle';
                toggle.innerHTML = '<i class="fas fa-chevron-down"></i>';
                itemHeader.appendChild(toggle);
            } else {
                const spacer = document.createElement('span');
                spacer.className = 'explorer-item-toggle';
                spacer.innerHTML = '';
                itemHeader.appendChild(spacer);
            }

            // Icon
            const icon = document.createElement('span');
            icon.className = 'explorer-item-icon';
            icon.innerHTML = `<i class="${getInstanceIcon(item.className)}"></i>`;
            itemHeader.appendChild(icon);

            // Name
            const name = document.createElement('span');
            name.className = 'explorer-item-name';
            name.textContent = item.name;
            itemHeader.appendChild(name);

            // Class name hint
            const className = document.createElement('span');
            className.className = 'explorer-item-class';
            className.textContent = item.className;
            itemHeader.appendChild(className);

            itemDiv.appendChild(itemHeader);

            // Click handler for scripts - open viewer
            if (isScript) {
                itemHeader.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openScriptViewer(item.name, item.source);
                });
            }

            // Children container
            if (hasChildren) {
                const childrenDiv = document.createElement('div');
                childrenDiv.className = 'explorer-children';

                for (const child of item.children) {
                    childrenDiv.appendChild(renderExplorerItem(child, level + 1));
                }

                itemDiv.appendChild(childrenDiv);

                // Toggle click handler (only if not a script, to avoid conflict)
                if (!isScript) {
                    itemHeader.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const toggle = itemHeader.querySelector('.explorer-item-toggle i');
                        if (toggle) {
                            toggle.classList.toggle('collapsed');
                            childrenDiv.classList.toggle('collapsed');
                        }
                    });
                }
            }

            return itemDiv;
        }

        // Fetch and display Explorer data
        async function updateExplorerPanel() {
            try {
                const response = await fetch(`${getApiBaseUrl()}/roblox/explorer`);
                const data = await response.json();

                console.log('[Explorer] Received data:', {
                    connected: data.connected,
                    hierarchyLength: data.hierarchy ? data.hierarchy.length : 0,
                    lastUpdate: data.lastUpdate
                });

                const explorerContent = document.getElementById('explorerContent');
                const explorerStatus = document.getElementById('explorerStatus');

                if (data.connected && data.hierarchy && data.hierarchy.length > 0) {
                    // Update status
                    explorerStatus.classList.add('connected');
                    explorerStatus.innerHTML = '<i class="fas fa-circle"></i><span>Connected</span>';

                    // Clear content
                    explorerContent.innerHTML = '';

                    // Render hierarchy
                    for (const service of data.hierarchy) {
                        explorerContent.appendChild(renderExplorerItem(service));
                    }

                    explorerData = data.hierarchy;
                } else {
                    // Show empty state
                    explorerStatus.classList.remove('connected');
                    explorerStatus.innerHTML = '<i class="fas fa-circle"></i><span>Disconnected</span>';

                    explorerContent.innerHTML = `
                        <div class="explorer-empty">
                            <i class="fas fa-cube"></i>
                            <p>Connect Roblox Studio to view Explorer</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('[Explorer] Failed to fetch data:', error);
            }
        }

        // Toggle Explorer panel
        function toggleExplorerPanel() {
            explorerVisible = !explorerVisible;
            const panel = document.getElementById('explorerPanel');
            const mainContent = document.getElementById('mainContent');

            if (explorerVisible) {
                panel.classList.remove('hidden');
                mainContent.classList.add('explorer-visible');
            } else {
                panel.classList.add('hidden');
                mainContent.classList.remove('explorer-visible');
            }
        }

        // Initialize Explorer panel
        function initializeExplorerPanel() {
            // Close modal on backdrop click
            document.getElementById('scriptViewerModal').addEventListener('click', (e) => {
                if (e.target.id === 'scriptViewerModal') {
                    closeScriptViewer();
                }
            });

            // Toggle button
            document.getElementById('explorerToggleBtn').addEventListener('click', toggleExplorerPanel);

            // Refresh button
            document.getElementById('explorerRefreshBtn').addEventListener('click', () => {
                const btn = document.getElementById('explorerRefreshBtn');
                btn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i>';

                updateExplorerPanel().then(() => {
                    setTimeout(() => {
                        btn.innerHTML = '<i class="fas fa-sync-alt"></i>';
                    }, 500);
                });
            });

            // Initial fetch
            updateExplorerPanel();

            // Auto-refresh every 3 seconds
            setInterval(updateExplorerPanel, 3000);

            // Show panel and adjust main content
            const mainContent = document.getElementById('mainContent');
            mainContent.classList.add('explorer-visible');
        }

        // ============================================
        // END EXPLORER FUNCTIONALITY
        // ============================================

        // Initialize RoConsole when DOM is ready
        window.addEventListener('DOMContentLoaded', function() {
            console.log('RoConsole DOM loaded');

            // Initialize Roblox auto-send functionality
            setTimeout(setupRobloxAutoSendHook, 500);

            // Initialize Explorer panel
            setTimeout(initializeExplorerPanel, 100);
        });
    </script>

    <!-- Load JavaScript modules - EXACT SAME ORDER AS index.html -->
    <script src="js/storage-utils.js"></script>
    <script src="js/sync-manager.js"></script>
    <script src="js/sync-ui.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/chat.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/scripts.js"></script>
    <script src="js/micro-interactions.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

    <!-- ReactBits-Inspired Animations -->
    <script src="js/animations/dot-grid-background.js"></script>
    <script src="js/animations/blur-text.js"></script>
    <script src="js/animations/micro-interactions.js"></script>
    <script src="js/animations/animations-init.js"></script>

    <script src="js/app.js"></script>

    <!-- Initialize the application -->
    <script>
        // Ensure openCodePanel is available globally for project chat
        if (!window.openCodePanel) {
            window.openCodePanel = function(blockId) {
                console.log('[Project Chat] openCodePanel called for:', blockId);
                if (window.chatManager && window.chatManager.openCodePanel) {
                    window.chatManager.openCodePanel(blockId);
                } else {
                    console.error('[Project Chat] ChatManager not ready, retrying...');
                    // Retry after a short delay
                    setTimeout(() => {
                        if (window.chatManager && window.chatManager.openCodePanel) {
                            window.chatManager.openCodePanel(blockId);
                        } else {
                            console.error('[Project Chat] ChatManager still not available');
                        }
                    }, 500);
                }
            };
        }

        // Close code panel function
        function closeCodePanel() {
            const codePanel = document.getElementById('codePanel');
            const mainContent = document.getElementById('mainContent');
            const explorerPanel = document.getElementById('explorerPanel');

            if (codePanel) {
                codePanel.classList.remove('active');
            }
            if (mainContent) {
                mainContent.classList.remove('code-panel-active');
            }
            // Remove body class to shift Explorer back
            document.body.classList.remove('code-panel-open');

            // Reset Explorer position
            if (explorerPanel) {
                explorerPanel.style.right = '';
            }
        }

        // Make closeCodePanel globally available
        window.closeCodePanel = closeCodePanel;

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Add click outside listener for model dropdown
            document.addEventListener('click', function(e) {
                const modelDropdown = document.getElementById('modelDropdown');
                const modelButton = document.getElementById('modelButton');

                if (modelDropdown && modelButton) {
                    if (!modelButton.contains(e.target) && !modelDropdown.contains(e.target)) {
                        modelDropdown.style.display = 'none';
                    }
                }
            });

            // Code panel resize functionality
            const codePanel = document.getElementById('codePanel');
            const resizeHandle = document.getElementById('codePanelResizeHandle');

            if (codePanel && resizeHandle) {
                let isResizing = false;
                let startX = 0;
                let startWidth = 0;

                resizeHandle.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    startX = e.clientX;
                    startWidth = codePanel.offsetWidth;
                    resizeHandle.classList.add('resizing');
                    document.body.style.cursor = 'ew-resize';
                    document.body.style.userSelect = 'none';
                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isResizing) return;

                    const deltaX = startX - e.clientX;
                    const newWidth = startWidth + deltaX;

                    // Min width: 300px, Max width: 80% of window
                    const minWidth = 300;
                    const maxWidth = window.innerWidth * 0.8;

                    if (newWidth >= minWidth && newWidth <= maxWidth) {
                        codePanel.style.width = `${newWidth}px`;
                    }
                });

                document.addEventListener('mouseup', () => {
                    if (isResizing) {
                        isResizing = false;
                        resizeHandle.classList.remove('resizing');
                        document.body.style.cursor = '';
                        document.body.style.userSelect = '';
                    }
                });
            }

            // ================================================
            // ROBLOX STUDIO INTEGRATION
            // ================================================

            // Check Roblox connection status
            async function checkRobloxConnection() {
                try {
                    const response = await fetch('/roblox/connection-status');
                    const data = await response.json();

                    const statusDot = document.getElementById('robloxStatusDot');
                    const statusText = document.getElementById('robloxStatusText');

                    if (data.connected) {
                        statusDot.classList.remove('disconnected');
                        statusDot.classList.add('connected');
                        statusText.textContent = 'Roblox Studio ✓';
                    } else {
                        statusDot.classList.remove('connected');
                        statusDot.classList.add('disconnected');
                        statusText.textContent = 'Roblox Studio';
                    }
                } catch (error) {
                    console.error('Error checking Roblox connection:', error);
                }
            }

            // Send script to Roblox Studio
            async function sendToRoblox(code, name, scriptType = 'Script', location = 'ServerScriptService') {
                try {
                    // Show loading state
                    const buttons = document.querySelectorAll('.send-to-roblox-btn');
                    buttons.forEach(btn => {
                        btn.disabled = true;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                    });

                    const response = await fetch('/roblox/send-script', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: name || 'GeneratedScript',
                            code: code,
                            scriptType: scriptType,
                            location: location
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Show success message
                        showToast(data.sentImmediately ?
                            '✅ Script sent to Roblox Studio!' :
                            '📥 Script queued for Roblox Studio', 'success');

                        // Reset button state
                        setTimeout(() => {
                            buttons.forEach(btn => {
                                btn.disabled = false;
                                btn.innerHTML = '<i class="fas fa-cube"></i> Send to Roblox';
                            });
                        }, 2000);
                    } else {
                        throw new Error(data.error || 'Failed to send script');
                    }
                } catch (error) {
                    console.error('Error sending to Roblox:', error);
                    showToast('❌ Failed to send script: ' + error.message, 'error');

                    // Reset button state
                    const buttons = document.querySelectorAll('.send-to-roblox-btn');
                    buttons.forEach(btn => {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-cube"></i> Send to Roblox';
                    });
                }
            }

            // Show toast notification
            function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    background: ${type === 'success' ? '#238636' : type === 'error' ? '#da3633' : '#1f6feb'};
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                    z-index: 10000;
                    font-size: 0.9rem;
                    animation: slideIn 0.3s ease;
                `;
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            // Add "Send to Roblox" buttons to code blocks
            function addRobloxButtons() {
                // Handle both regular code blocks AND artifact code previews
                const regularCodeBlocks = document.querySelectorAll('pre code');
                const artifactCodePreviews = document.querySelectorAll('.artifact-code-preview');

                // Handle regular code blocks
                regularCodeBlocks.forEach((codeBlock) => {
                    if (codeBlock.parentElement.querySelector('.send-to-roblox-btn')) {
                        return;
                    }

                    const code = codeBlock.textContent;
                    const button = document.createElement('button');
                    button.className = 'send-to-roblox-btn';
                    button.innerHTML = '<i class="fas fa-cube"></i> Send to Roblox';
                    button.onclick = () => {
                        let scriptName = 'GeneratedScript';
                        const messageDiv = codeBlock.closest('.message');
                        if (messageDiv) {
                            const text = messageDiv.textContent;
                            const match = text.match(/script\s+(?:named|called)\s+["']?(\w+)["']?/i);
                            if (match) {
                                scriptName = match[1];
                            }
                        }
                        sendToRoblox(code, scriptName);
                    };

                    const pre = codeBlock.parentElement;
                    if (pre.tagName === 'PRE') {
                        pre.style.position = 'relative';
                        button.style.position = 'absolute';
                        button.style.top = '8px';
                        button.style.right = '8px';
                        pre.appendChild(button);
                    }
                });

                // Handle artifact code previews
                artifactCodePreviews.forEach((artifact) => {
                    if (artifact.querySelector('.send-to-roblox-btn')) {
                        return;
                    }

                    const artifactId = artifact.dataset.artifactId;
                    if (!artifactId || !window._codeBlocks || !window._codeBlocks[artifactId]) {
                        return;
                    }

                    const codeData = window._codeBlocks[artifactId];
                    const button = document.createElement('button');
                    button.className = 'send-to-roblox-btn';
                    button.innerHTML = '<i class="fas fa-cube"></i> Send to Roblox';
                    button.style.position = 'absolute';
                    button.style.top = '12px';
                    button.style.right = '40px';
                    button.style.zIndex = '10';

                    button.onclick = (e) => {
                        e.stopPropagation(); // Prevent artifact from opening
                        const scriptName = codeData.title || 'GeneratedScript';
                        sendToRoblox(codeData.code, scriptName);
                    };

                    artifact.style.position = 'relative';
                    artifact.appendChild(button);
                });
            }

            // Initialize Roblox integration
            checkRobloxConnection();
            setInterval(checkRobloxConnection, 5000); // Check every 5 seconds

            // Add Roblox buttons when messages are added
            const messagesContainer = document.getElementById('messagesContainer');
            if (messagesContainer) {
                const observer = new MutationObserver(() => {
                    addRobloxButtons();
                });

                observer.observe(messagesContainer, {
                    childList: true,
                    subtree: true
                });
            }

            // Add click handler for connection status
            document.getElementById('robloxStatus')?.addEventListener('click', () => {
                checkRobloxConnection();
                showToast('🔄 Checking connection...', 'info');
            });

            // Add CSS animations for toast
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }

                @keyframes slideOut {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);

            // ================================================
            // END ROBLOX INTEGRATION
            // ================================================
        });
    </script>
</body>
</html>