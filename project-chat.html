<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Chat - RoAssistant</title>
    <link rel="icon" type="image/png" href="roassistant-logo.png">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/sidebar.css">
    <link rel="stylesheet" href="styles/chat.css">
    <link rel="stylesheet" href="styles/responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- AdSense Integration -->
    <link rel="stylesheet" href="styles/ads.css">
    <script src="js/adsense.js"></script>

    <!-- Google AdSense Verification Code -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7434697703458325"
            crossorigin="anonymous"></script>

    <style>
        /* Subscription Status Styles */
        .subscription-status {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem 1rem;
            background: rgba(33, 38, 45, 0.6);
            border: 1px solid #30363d;
            border-radius: 8px;
            margin-right: 1rem;
        }

        .plan-badge {
            background: linear-gradient(45deg, #58a6ff, #1f6feb);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .plan-badge.free {
            background: linear-gradient(45deg, #8b949e, #6e7681);
        }

        .plan-badge.pro {
            background: linear-gradient(45deg, #58a6ff, #1f6feb);
        }

        .plan-badge.enterprise {
            background: linear-gradient(45deg, #9d4edd, #7c3aed);
        }

        /* Project Chat Context Styles */
        .project-context-header {
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid rgba(88, 166, 255, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .project-context-icon {
            font-size: 2rem;
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #58a6ff, #a5b4fc);
            border-radius: 8px;
        }
        
        .project-context-details h3 {
            color: #f0f6fc;
            margin: 0 0 0.25rem 0;
            font-size: 1.125rem;
        }
        
        .project-context-details p {
            color: #8b949e;
            margin: 0;
            font-size: 0.875rem;
        }
        
        .back-to-projects {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #8b949e;
            text-decoration: none;
            font-size: 0.875rem;
            margin: 1rem;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .back-to-projects:hover {
            color: #f0f6fc;
            background: rgba(110, 118, 129, 0.1);
        }
        
        /* Project Context Styles */
        .project-files-info {
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid rgba(88, 166, 255, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        
        .welcome-content a {
            color: #58a6ff;
            text-decoration: none;
        }
        
        .welcome-content a:hover {
            text-decoration: underline;
        }

        .usage-counter {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #8b949e;
            font-size: 0.85rem;
        }

        .usage-bar {
            width: 100px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .usage-fill {
            height: 100%;
            background: linear-gradient(90deg, #58a6ff, #1f6feb);
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        .usage-fill.warning {
            background: linear-gradient(90deg, #d4ac0d, #f39c12);
        }

        .usage-fill.danger {
            background: linear-gradient(90deg, #f85149, #da3633);
        }

        .upgrade-prompt {
            display: none;
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: linear-gradient(135deg, #161b22, #21262d);
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 350px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: slideInUp 0.3s ease;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .upgrade-prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .upgrade-prompt-title {
            font-weight: 600;
            color: #f0f6fc;
        }

        .upgrade-prompt-close {
            background: none;
            border: none;
            color: #8b949e;
            cursor: pointer;
            font-size: 1.5rem;
            line-height: 1;
        }

        .upgrade-prompt-message {
            color: #8b949e;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            line-height: 1.4;
        }

        .upgrade-prompt-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .upgrade-btn {
            flex: 1;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
        }

        .upgrade-btn.primary {
            background: linear-gradient(45deg, #238636, #2ea043);
            color: white;
        }

        .upgrade-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(46, 160, 67, 0.4);
        }

        .upgrade-btn.secondary {
            background: transparent;
            border: 1px solid #30363d;
            color: #8b949e;
        }

        .upgrade-btn.secondary:hover {
            border-color: #58a6ff;
            color: #58a6ff;
        }

        .model-locked {
            position: relative;
        }

        .model-locked::after {
            content: '\f023';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 35px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
        }

        .usage-warning {
            background: rgba(212, 172, 13, 0.1);
            border: 1px solid rgba(212, 172, 13, 0.3);
            border-radius: 8px;
            padding: 0.75rem;
            margin: 1rem;
            color: #d4ac0d;
            font-size: 0.85rem;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .usage-limit-reached {
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid rgba(248, 81, 73, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem;
            color: #f85149;
            text-align: center;
            display: none;
        }

        /* FIXED: Account switch notification */
        .account-switch-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #58a6ff, #1f6feb);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(88, 166, 255, 0.4);
            z-index: 1000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .account-switch-notification.show {
            opacity: 1;
            transform: translateX(0);
        }
    </style>
</head>

<body>
    <!-- FIXED: Account Switch Notification -->
    <div class="account-switch-notification" id="accountSwitchNotification">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-sync-alt"></i>
            <span>Account switched! Loading your data...</span>
        </div>
    </div>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="roassistant-logo.png" alt="RoAssistant Logo" class="sidebar-logo" style="width: 40px; height: 40px; object-fit: contain;">
            <div class="sidebar-title">RoAssistant</div>
        </div>

        <button class="new-chat-btn" onclick="startNewChat()">
            <span>+</span>
            New chat
        </button>


        <div class="sidebar-nav">
            <!-- Main Navigation -->
            <div class="nav-section">
                <div class="nav-item" onclick="setActiveNav(this, 'chats')">
                    <span class="nav-icon"><i class="fas fa-comments"></i></span>
                    Chats
                </div>
                <div class="nav-item active" onclick="setActiveNav(this, 'projects')">
                    <span class="nav-icon"><i class="fas fa-folder"></i></span>
                    Projects
                </div>
                <div class="nav-item" onclick="setActiveNav(this, 'scripts')">
                    <span class="nav-icon"><i class="fas fa-wrench"></i></span>
                    Scripts
                </div>
                <div class="nav-item" onclick="window.location.href='/pricing.html'" style="color: #58a6ff;">
                    <span class="nav-icon"><i class="fas fa-gem"></i></span>
                    Upgrade Plan
                </div>
            </div>

            <!-- Recent Chats -->
            <div class="nav-section">
                <div class="nav-title">Recents</div>
                <div id="chatHistory">
                    <!-- Chat history will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <div class="sidebar-footer">
            <div class="user-profile" id="userProfile">
                <!-- Default Sign In button - will be replaced by JavaScript -->
                <div class="user-avatar"><i class="fas fa-user"></i></div>
                <div class="user-info">
                    <div class="user-name">Guest User</div>
                    <div class="user-plan">Free Plan - <span style="color: #58a6ff; cursor: pointer;" onclick="window.location.href='/login.html'">Sign In for More</span></div>
                </div>
                <button onclick="window.location.href='/login.html'" style="background: #238636; border: none; border-radius: 6px; color: white; padding: 0.4rem 0.8rem; font-size: 0.8rem; cursor: pointer; margin-left: 0.5rem;">
                    Sign In
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="main-header">
            <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleSidebar()">
                ☰
            </button>
            <div class="header-title" id="chatTitle">Project Chat</div>
            
            <!-- Subscription Status -->
            <div class="subscription-status" id="subscriptionStatus" style="display: none;">
                <div class="plan-badge" id="planBadge">Free</div>
                <div class="usage-counter">
                    <span id="usageText">0/10</span>
                    <div class="usage-bar">
                        <div class="usage-fill" id="usageFill" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Usage Warning -->
        <div id="usageWarning" class="usage-warning">
            <i class="fas fa-exclamation-triangle"></i> You're approaching your daily message limit. Consider upgrading for unlimited access!
        </div>

        <!-- Usage Limit Reached -->
        <div id="usageLimitReached" class="usage-limit-reached">
            <i class="fas fa-ban"></i> Daily message limit reached. <a href="/pricing.html" style="color: #58a6ff;">Upgrade now</a> for unlimited messages!
        </div>

        <!-- Project Context Header -->
        <div class="project-context-header" id="projectContextHeader">
            <div class="project-icon" id="projectIcon"><i class="fas fa-folder"></i></div>
            <div class="project-context-info">
                <h3 id="projectName">Loading project...</h3>
                <p id="projectDescription">Please wait while we load your project details.</p>
            </div>
            <div style="margin-left: auto; display: flex; gap: 0.5rem; align-items: center;">
                <button onclick="openArtifactsModal()" style="background: rgba(88, 166, 255, 0.15); border: 1px solid rgba(88, 166, 255, 0.3); border-radius: 6px; color: #58a6ff; padding: 0.5rem 1rem; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-paperclip"></i> <span id="artifactCount">0</span> Artifacts
                </button>
                <button onclick="openAddFileDialog()" style="background: #238636; border: none; border-radius: 6px; color: white; padding: 0.5rem 1rem; cursor: pointer; font-size: 0.85rem;">
                    <i class="fas fa-folder-open"></i> Add Files
                </button>
                <button onclick="openAddTextModal()" style="background: #1f6feb; border: none; border-radius: 6px; color: white; padding: 0.5rem 1rem; cursor: pointer; font-size: 0.85rem;">
                    <i class="fas fa-edit"></i> Add Text
                </button>
                <a href="projects.html" class="back-to-projects"><i class="fas fa-arrow-left"></i> Back</a>
            </div>
        </div>

        <!-- Header Banner Ad -->
        <div id="headerBannerAd" class="ad-container banner-ad">
            <div class="ad-label">Advertisement</div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <div class="messages-container" id="messagesContainer">
                <!-- Welcome Screen -->
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="welcome-icon"><i class="fas fa-rocket"></i></div>
                    <h1 class="welcome-title">Project Chat</h1>
                    <p class="welcome-subtitle">Discuss your project with context-aware AI assistance</p>
                    
                    <div class="project-files-info" id="projectFilesInfo">
                        <strong><i class="fas fa-folder-open"></i> Project Context Loaded</strong><br>
                        Your AI assistant has access to this project's files and can help you with specific questions about your code, debugging, and improvements.
                    </div>
                    
                    <div class="quick-actions">
                        <div class="quick-action" onclick="useQuickAction('Analyze my project structure and suggest improvements')">
                            <span class="action-icon"><i class="fas fa-search"></i></span>
                            <div class="action-title">Analyze Project</div>
                            <div class="action-desc">Review your project structure and code</div>
                        </div>
                        
                        <div class="quick-action" onclick="useQuickAction('Help me debug issues in this project')">
                            <span class="action-icon"><i class="fas fa-bug"></i></span>
                            <div class="action-title">Debug Issues</div>
                            <div class="action-desc">Find and fix problems in your code</div>
                        </div>
                        
                        <div class="quick-action" onclick="useQuickAction('Suggest new features for this project')">
                            <span class="action-icon"><i class="fas fa-star"></i></span>
                            <div class="action-title">Add Features</div>
                            <div class="action-desc">Get ideas for project enhancements</div>
                        </div>
                        
                        <div class="quick-action" onclick="useQuickAction('Help me optimize the performance of this project')">
                            <span class="action-icon"><i class="fas fa-bolt"></i></span>
                            <div class="action-title">Optimize Code</div>
                            <div class="action-desc">Improve speed and efficiency</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-container">
                <div class="input-wrapper" id="inputWrapper">
                    <div class="input-content">
                        <!-- File attachments area -->
                        <div class="file-attachments" id="fileAttachments" style="display: none;"></div>
                        
                        <!-- Input row -->
                        <div class="input-row">
                            <button class="attach-button" id="attachButton" onclick="openFileDialog()" title="Add file or image">
                                <span><i class="fas fa-paperclip"></i></span>
                            </button>
                            <button class="model-button" id="modelButton" onclick="toggleModelSelector()" title="Select AI Model">
                                <span><i class="fas fa-robot"></i></span>
                            </button>
                            <!-- Model Selector Dropdown -->
                            <div class="model-dropdown" id="modelDropdown" style="display: none;">
                                <div class="model-dropdown-header">Select Model</div>
                                <div class="model-option" data-model="claude-sonnet-4" onclick="selectModel('claude-sonnet-4')">
                                    <div class="model-name">Claude Sonnet 4</div>
                                    <div class="model-badge">Free</div>
                                </div>
                                <div class="model-option premium" data-model="claude-opus-4" onclick="selectModel('claude-opus-4')">
                                    <div class="model-name">Claude Opus 4</div>
                                    <div class="model-badge">Premium</div>
                                </div>
                            </div>
                            <textarea 
                                class="input-area" 
                                id="messageInput" 
                                placeholder="Ask questions about your project, request code reviews, or get help with specific features..."
                                rows="1"
                            ></textarea>
                            <button class="send-button" id="sendButton" onclick="sendMessage()">
                                <span>Send</span>
                            </button>
                        </div>
                    </div>
                </div>
                <input type="file" id="fileInput" accept="image/*,.txt,.lua,.luau,.js,.json,.md" style="display: none;" onchange="handleFileSelect(event)" multiple>
                
                <!-- Drag & Drop Overlay -->
                <div class="drag-overlay" id="dragOverlay" style="display: none;">
                    <div class="drag-content">
                        <div class="drag-icon">📁</div>
                        <div class="drag-text">Drop files here to upload</div>
                        <div class="drag-subtext">Images, code files, and documents</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer Ad -->
        <div id="footerAd" class="ad-container footer-ad">
            <div class="ad-label">Advertisement</div>
        </div>
    </div>

    <!-- Upgrade Prompt -->
    <div class="upgrade-prompt" id="upgradePrompt">
        <div class="upgrade-prompt-header">
            <div class="upgrade-prompt-title">🚀 Unlock More Power</div>
            <button class="upgrade-prompt-close" onclick="closeUpgradePrompt()">×</button>
        </div>
        <div class="upgrade-prompt-message" id="upgradePromptMessage">
            You've used 8 of your 10 daily messages. Upgrade to Pro for 500 messages per day!
        </div>
        <div class="upgrade-prompt-buttons">
            <button class="upgrade-btn primary" onclick="window.location.href='/pricing.html'">
                View Plans
            </button>
            <button class="upgrade-btn secondary" onclick="closeUpgradePrompt()">
                Maybe Later
            </button>
        </div>
    </div>

    <script>
        // DYNAMIC API CONFIGURATION - Updated for production deployment
        const getApiBaseUrl = () => {
            // Check if we're running on localhost (development)
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                return 'http://localhost:3000';
            }
            
            // For production, point to Railway backend
            return 'https://roassistantv3-production.up.railway.app';
        };

        const API_BASE_URL = getApiBaseUrl();
        console.log(`[CONFIG] Using API Base URL: ${API_BASE_URL}`);

        // FIXED: Global variables with proper user isolation
        let currentChatId = null;
        let isLoggedIn = false;
        let authToken = null;
        let currentUser = null;
        let selectedModel = 'claude-sonnet-4';
        let currentView = 'projects';
        let attachedFiles = [];
        let currentProjectId = null;
        let currentProject = null;

        // FIXED: User-specific data storage
        let userChats = [];
        let userScripts = [];

        // Subscription management
        let userSubscription = {
            plan: 'free',
            limits: {
                daily_messages: 10,
                models: ['gpt-4o-mini']
            },
            usage: {
                daily_messages: 0,
                daily_limit: 10
            }
        };

        // Message counter for ad insertion
        let messageCount = 0;
        const AD_FREQUENCY = 5; // Show ad every 5 messages

        // Project chat specific functions
        function loadProjectFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            currentProjectId = urlParams.get('project');
            
            if (currentProjectId) {
                const projects = JSON.parse(localStorage.getItem('roblox_projects') || '[]');
                currentProject = projects.find(p => p.id === currentProjectId);
                
                if (currentProject) {
                    updateProjectHeader();
                } else {
                    // Project not found, redirect to projects page
                    window.location.href = 'projects.html';
                }
            } else {
                // No project ID, redirect to projects page
                window.location.href = 'projects.html';
            }
        }

        function updateProjectHeader() {
            if (!currentProject) return;
            
            document.getElementById('chatTitle').textContent = currentProject.name;
            document.getElementById('projectName').textContent = currentProject.name;
            document.getElementById('projectDescription').textContent = currentProject.description || 'No description provided';
            
            // Update project icon based on type
            const iconElement = document.getElementById('projectIcon');
            const iconMap = {
                'game': '🎮',
                'script': '📝',
                'tool': '🔧',
                'library': '📚',
                'template': '📋'
            };
            iconElement.textContent = iconMap[currentProject.type] || '📂';
            
            // Update artifact count
            const artifactCount = currentProject.artifacts ? currentProject.artifacts.length : 0;
            document.getElementById('artifactCount').textContent = artifactCount;
        }

        // Artifact Management Functions
        function openArtifactsModal() {
            document.getElementById('artifactsModal').style.display = 'block';
            renderArtifacts();
        }

        function closeArtifactsModal() {
            document.getElementById('artifactsModal').style.display = 'none';
        }

        function openAddTextModal() {
            document.getElementById('addTextModal').style.display = 'block';
            document.getElementById('artifactName').focus();
        }

        function closeAddTextModal() {
            document.getElementById('addTextModal').style.display = 'none';
            document.getElementById('artifactName').value = '';
            document.getElementById('artifactContent').value = '';
        }

        function openAddFileDialog() {
            document.getElementById('artifactFileInput').click();
        }

        function addTextArtifact(event) {
            event.preventDefault();
            const name = document.getElementById('artifactName').value.trim();
            const content = document.getElementById('artifactContent').value.trim();
            
            if (!name || !content) return;
            
            const artifact = {
                id: 'artifact_' + Date.now(),
                type: 'text',
                name: name,
                content: content,
                size: new Blob([content]).size,
                created: Date.now()
            };
            
            addArtifactToProject(artifact);
            closeAddTextModal();
        }

        function handleArtifactFileSelect(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const artifact = {
                        id: 'artifact_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        type: 'file',
                        name: file.name,
                        content: e.target.result,
                        mimeType: file.type,
                        size: file.size,
                        created: Date.now()
                    };
                    addArtifactToProject(artifact);
                };
                
                // Read as text for text files, as data URL for others
                if (file.type.startsWith('text/') || 
                    file.name.endsWith('.lua') || 
                    file.name.endsWith('.luau') || 
                    file.name.endsWith('.js') || 
                    file.name.endsWith('.json') ||
                    file.name.endsWith('.md')) {
                    reader.readAsText(file);
                } else {
                    reader.readAsDataURL(file);
                }
            });
            
            // Clear the file input
            event.target.value = '';
        }

        function addArtifactToProject(artifact) {
            if (!currentProject) return;
            
            if (!currentProject.artifacts) {
                currentProject.artifacts = [];
            }
            
            currentProject.artifacts.push(artifact);
            currentProject.updated = Date.now();
            
            // Save to localStorage
            const projects = JSON.parse(localStorage.getItem('roblox_projects') || '[]');
            const projectIndex = projects.findIndex(p => p.id === currentProject.id);
            if (projectIndex !== -1) {
                projects[projectIndex] = currentProject;
                localStorage.setItem('roblox_projects', JSON.stringify(projects));
            }
            
            // Update UI
            updateProjectHeader();
            renderArtifacts();
            
            // Show success message
            showNotification(`Added "${artifact.name}" to project artifacts`);
        }

        function removeArtifact(artifactId) {
            if (!currentProject || !currentProject.artifacts) return;
            
            const artifact = currentProject.artifacts.find(a => a.id === artifactId);
            if (!artifact) return;
            
            if (confirm(`Remove "${artifact.name}" from artifacts?`)) {
                currentProject.artifacts = currentProject.artifacts.filter(a => a.id !== artifactId);
                currentProject.updated = Date.now();
                
                // Save to localStorage
                const projects = JSON.parse(localStorage.getItem('roblox_projects') || '[]');
                const projectIndex = projects.findIndex(p => p.id === currentProject.id);
                if (projectIndex !== -1) {
                    projects[projectIndex] = currentProject;
                    localStorage.setItem('roblox_projects', JSON.stringify(projects));
                }
                
                // Update UI
                updateProjectHeader();
                renderArtifacts();
                
                // Show success message
                showNotification(`Removed "${artifact.name}" from artifacts`);
            }
        }

        function renderArtifacts() {
            const artifactsList = document.getElementById('artifactsList');
            
            if (!currentProject || !currentProject.artifacts || currentProject.artifacts.length === 0) {
                artifactsList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #8b949e;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">📭</div>
                        <p>No artifacts yet. Add files or text content to help the AI understand your project better.</p>
                    </div>
                `;
                return;
            }
            
            artifactsList.innerHTML = currentProject.artifacts.map(artifact => {
                const icon = artifact.type === 'text' ? '📝' : getFileIcon(artifact.name);
                const sizeStr = formatFileSize(artifact.size);
                
                return `
                    <div class="artifact-item">
                        <div class="artifact-info">
                            <div class="artifact-icon">${icon}</div>
                            <div class="artifact-details">
                                <h4>${artifact.name}</h4>
                                <p>${artifact.type === 'text' ? 'Text content' : 'File'} • ${sizeStr} • ${formatDate(artifact.created)}</p>
                            </div>
                        </div>
                        <div class="artifact-actions">
                            <button class="artifact-btn" onclick="viewArtifact('${artifact.id}')">View</button>
                            <button class="artifact-btn delete" onclick="removeArtifact('${artifact.id}')">Remove</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function viewArtifact(artifactId) {
            const artifact = currentProject.artifacts.find(a => a.id === artifactId);
            if (!artifact) return;
            
            // For text content, show in a modal or copy to clipboard
            if (artifact.type === 'text' || artifact.mimeType?.startsWith('text/')) {
                const truncated = artifact.content.length > 1000 
                    ? artifact.content.substring(0, 1000) + '...\n\n[Content truncated for preview]'
                    : artifact.content;
                
                alert(`Content of "${artifact.name}":\n\n${truncated}`);
            } else {
                alert(`"${artifact.name}" is a binary file and cannot be previewed directly.`);
            }
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const iconMap = {
                'lua': '📜',
                'luau': '📜',
                'js': '🟨',
                'json': '📋',
                'md': '📄',
                'txt': '📄',
                'png': '🖼️',
                'jpg': '🖼️',
                'jpeg': '🖼️',
                'gif': '🖼️',
                'zip': '📦',
                'rbxm': '🎮',
                'rbxl': '🎮'
            };
            return iconMap[ext] || '📎';
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function formatDate(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            
            if (minutes < 1) return 'Just now';
            if (minutes === 1) return '1 minute ago';
            if (minutes < 60) return `${minutes} minutes ago`;
            
            const hours = Math.floor(minutes / 60);
            if (hours === 1) return '1 hour ago';
            if (hours < 24) return `${hours} hours ago`;
            
            const days = Math.floor(hours / 24);
            if (days === 1) return 'Yesterday';
            if (days < 7) return `${days} days ago`;
            
            return new Date(timestamp).toLocaleDateString();
        }

        function showNotification(message) {
            // Create a temporary notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 2rem;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(45deg, #238636, #2ea043);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                z-index: 1001;
                animation: slideInUp 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Add modal close on click outside
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                if (event.target.id === 'artifactsModal') {
                    closeArtifactsModal();
                } else if (event.target.id === 'addTextModal') {
                    closeAddTextModal();
                }
            }
        });

        // FIXED: Account switching functionality
        class AccountManager {
            constructor() {
                this.lastKnownUser = null;
                this.initializeWatcher();
            }

            initializeWatcher() {
                // Watch for auth token changes
                const originalSetItem = localStorage.setItem;
                const originalRemoveItem = localStorage.removeItem;
                
                localStorage.setItem = (key, value) => {
                    if (key === 'authToken' || key === 'user') {
                        setTimeout(() => this.checkForAccountSwitch(), 100);
                    }
                    return originalSetItem.call(localStorage, key, value);
                };
                
                localStorage.removeItem = (key) => {
                    if (key === 'authToken' || key === 'user') {
                        setTimeout(() => this.checkForAccountSwitch(), 100);
                    }
                    return originalRemoveItem.call(localStorage, key);
                };
            }

            checkForAccountSwitch() {
                const currentToken = localStorage.getItem('authToken');
                const currentUserData = localStorage.getItem('user');
                
                let currentUserId = null;
                if (currentUserData) {
                    try {
                        const user = JSON.parse(currentUserData);
                        currentUserId = user.id || user.email;
                    } catch (error) {
                        console.error('Error parsing user data:', error);
                    }
                }

                // Check if user has switched
                if (this.lastKnownUser !== currentUserId) {
                    console.log('[ACCOUNT] User switch detected:', this.lastKnownUser, '->', currentUserId);
                    this.handleAccountSwitch(currentUserId);
                    this.lastKnownUser = currentUserId;
                }
            }
        }

        // Check premium status
        function checkPremiumStatus() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (user.premium || user.plan === 'premium') {
                document.body.classList.add('premium-user');
                console.log('[AdSense] Premium user detected - ads hidden');
            }
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing project chat...');
            loadProjectFromUrl();
            initApp();
            
            // Check subscription status and refresh periodically
            checkSubscriptionStatus();
            setInterval(checkSubscriptionStatus, 60000); // Refresh every minute
            
            // Check premium status on load
            checkPremiumStatus();
        });

        // Check for project parameter in URL
        function checkProjectParameter() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('project');
            
            if (projectId) {
                // Load project context if needed
                console.log('Loading project context:', projectId);
                // You can implement project-specific logic here
            }
        }

        // Check premium status on auth changes
        document.addEventListener('authStatusChanged', checkPremiumStatus);

        // Authentication and User Profile Functions
        function checkAuth() {
            console.log('Checking auth...');
            authToken = localStorage.getItem('authToken');
            const user = localStorage.getItem('user');

            if (authToken && user) {
                try {
                    const userData = JSON.parse(user);
                    currentUser = userData;
                    showLoggedInUser(userData);
                    isLoggedIn = true;
                } catch (error) {
                    console.error('Error parsing user data:', error);
                    showGuestUser();
                    isLoggedIn = false;
                    currentUser = null;
                }
            } else {
                showGuestUser();
                isLoggedIn = false;
                currentUser = null;
            }
            updateModelSelector();
        }

        // Show logged in user profile
        function showLoggedInUser(userData) {
            const userProfile = document.getElementById('userProfile');
            if (userProfile) {
                const planText = userData.subscription?.plan || 'free';
                const planDisplay = planText.charAt(0).toUpperCase() + planText.slice(1);
                
                userProfile.innerHTML = `
                    <div class="user-avatar">${(userData.name || userData.email || 'U').charAt(0).toUpperCase()}</div>
                    <div class="user-info">
                        <div class="user-name">${userData.name || userData.email || 'User'}</div>
                        <div class="user-plan">${planDisplay} Plan</div>
                    </div>
                    <button onclick="logout()" style="background: #f85149; border: none; border-radius: 6px; color: white; padding: 0.4rem 0.8rem; font-size: 0.8rem; cursor: pointer; margin-left: 0.5rem;">
                        Logout
                    </button>
                `;
            }
        }

        // Show guest user profile
        function showGuestUser() {
            console.log('[AUTH] Showing guest user profile...');
            const userProfile = document.getElementById('userProfile');
            if (userProfile) {
                userProfile.innerHTML = `
                    <div class="user-avatar">👤</div>
                    <div class="user-info">
                        <div class="user-name">Guest User</div>
                        <div class="user-plan">Free Plan - <span style="color: #58a6ff; cursor: pointer;" onclick="window.location.href='/login.html'">Sign In for More</span></div>
                    </div>
                    <button onclick="window.location.href='/login.html'" style="background: #238636; border: none; border-radius: 6px; color: white; padding: 0.4rem 0.8rem; font-size: 0.8rem; cursor: pointer; margin-left: 0.5rem;">
                        Sign In
                    </button>
                `;
                console.log('[AUTH] Guest user profile updated successfully');
            } else {
                console.error('[AUTH] Could not find userProfile element!');
            }
        }

        // Logout function
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('user');
            
            isLoggedIn = false;
            authToken = null;
            currentUser = null;
            
            showGuestUser();
            updateModelSelector();
            
            // Switch to available model for guests
            if (selectedModel === 'claude-opus-4') {
                selectedModel = 'claude-sonnet-4';
                updateModelButton();
            }
        }

        // Toggle model selector dropdown
        function toggleModelSelector() {
            const dropdown = document.getElementById('modelDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        // Select a model
        function selectModel(model) {
            // Check if user needs to be logged in for Opus 4
            if (model === 'claude-opus-4' && !isLoggedIn) {
                alert('Please sign in to access Claude Opus 4');
                return;
            }

            const newModel = model;
            console.log('Model changed to:', newModel);

            // If the model actually changed, start a new chat
            if (newModel !== selectedModel) {
                selectedModel = newModel;

                // Update button icon to show current model
                updateModelButton();

                // Start a new chat when model changes
                startNewChat();

                // Show a message indicating the model change
                const modelName = model === 'claude-opus-4' ? 'Claude Opus 4' : 'Claude Sonnet 4';
                addMessage('system', `🔄 Switched to ${modelName}. Starting a new conversation.`);
            }

            // Hide dropdown
            document.getElementById('modelDropdown').style.display = 'none';
        }

        // Update model button to show current selection
        function updateModelButton() {
            const modelButton = document.getElementById('modelButton');
            if (modelButton) {
                // Update title to show current model
                const modelName = selectedModel === 'claude-opus-4' ? 'Claude Opus 4' : 'Claude Sonnet 4';
                modelButton.title = `Current Model: ${modelName}`;
            }
        }

        // Update model selector for auth status
        function updateModelSelector() {
            // Update the premium model option based on auth status
            const premiumOption = document.querySelector('.model-option.premium');
            if (premiumOption && !isLoggedIn) {
                premiumOption.classList.add('disabled');
            } else if (premiumOption) {
                premiumOption.classList.remove('disabled');
            }
            updateModelButton();
        }

        // Initialize app
        function initApp() {
            console.log('Initializing project chat app...');
            checkAuth();
        }

        // Check subscription status (stub for now)
        function checkSubscriptionStatus() {
            // This function would normally check subscription status from server
            console.log('Checking subscription status...');
        }

        // Navigation function to update active nav
        function setActiveNav(element, view) {
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to clicked nav item
            element.classList.add('active');
            
            // Navigate based on view
            if (view === 'chats') {
                window.location.href = 'index.html';
            } else if (view === 'projects') {
                window.location.href = 'projects.html';
            } else if (view === 'scripts') {
                window.location.href = 'scripts.html';
            }
        }

        // Start new chat function
        function startNewChat() {
            window.location.href = 'index.html';
        }
    </script>

    <!-- Load JavaScript modules -->
    <script src="js/auth.js"></script>
    <script src="js/chat.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/scripts.js"></script>
    <script src="js/app.js"></script>

    <!-- Initialize the application -->
    <script>
        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            const app = new App();
            app.init();

            // Add click outside listener for model dropdown
            document.addEventListener('click', function(e) {
                const modelDropdown = document.getElementById('modelDropdown');
                const modelButton = document.getElementById('modelButton');

                if (modelDropdown && modelButton) {
                    if (!modelButton.contains(e.target) && !modelDropdown.contains(e.target)) {
                        modelDropdown.style.display = 'none';
                    }
                }
            });

            // Initialize model button
            updateModelButton();
        });
    </script>

    <!-- Content Ad Template for Chat -->
    <template id="chatContentAdTemplate">
        <div class="ad-container content-ad chat-content-ad" style="margin: 2rem auto;">
            <div class="ad-label">Advertisement</div>
        </div>
    </template>

    <!-- Artifacts Modal -->
    <div class="modal" id="artifactsModal" style="display: none;">
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title">Project Artifacts</h2>
                <button class="modal-close" onclick="closeArtifactsModal()">×</button>
            </div>
            <div id="artifactsList" style="padding: 1rem 0;">
                <!-- Artifacts will be listed here -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeArtifactsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Add Text Modal -->
    <div class="modal" id="addTextModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Text Content</h2>
                <button class="modal-close" onclick="closeAddTextModal()">×</button>
            </div>
            <form onsubmit="addTextArtifact(event)">
                <div class="form-group">
                    <label class="form-label" for="artifactName">Name</label>
                    <input type="text" id="artifactName" class="form-input" placeholder="e.g., Game Logic, Player Stats, UI Code" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="artifactContent">Content</label>
                    <textarea id="artifactContent" class="form-input form-textarea" placeholder="Paste your code or text here..." style="min-height: 200px; font-family: monospace;" required></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAddTextModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Text</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Hidden file input for artifacts -->
    <input type="file" id="artifactFileInput" accept="*" style="display: none;" onchange="handleArtifactFileSelect(event)" multiple>

    <style>
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 2rem;
            width: 90%;
            max-width: 480px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-title {
            color: #f0f6fc;
            margin: 0;
            font-size: 1.25rem;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: #6e7681;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            color: #f0f6fc;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .form-input {
            width: 100%;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 0.75rem;
            color: #f0f6fc;
            font-size: 0.875rem;
            box-sizing: border-box;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #58a6ff;
        }
        
        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            font-weight: 600;
        }
        
        .btn-primary {
            background: #238636;
            color: white;
        }
        
        .btn-secondary {
            background: transparent;
            color: #8b949e;
            border: 1px solid #30363d;
        }

        .artifact-item {
            background: rgba(33, 38, 45, 0.6);
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .artifact-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .artifact-icon {
            font-size: 1.5rem;
        }

        .artifact-details h4 {
            color: #f0f6fc;
            margin: 0 0 0.25rem 0;
            font-size: 0.95rem;
        }

        .artifact-details p {
            color: #8b949e;
            margin: 0;
            font-size: 0.8rem;
        }

        .artifact-actions {
            display: flex;
            gap: 0.5rem;
        }

        .artifact-btn {
            background: none;
            border: 1px solid #30363d;
            border-radius: 4px;
            color: #8b949e;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .artifact-btn:hover {
            border-color: #58a6ff;
            color: #58a6ff;
        }

        .artifact-btn.delete:hover {
            border-color: #f85149;
            color: #f85149;
        }
    </style>

</body>
</html>
