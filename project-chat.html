<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoAssistant - Project Chat</title>
    <link rel="icon" type="image/png" href="/roassistant-logo.png">

    <link rel="stylesheet" href="styles/liquid-glass.css">
    <link rel="stylesheet" href="styles/dot-grid.css">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/sidebar.css">
    <link rel="stylesheet" href="styles/chat.css">
    <link rel="stylesheet" href="styles/animations.css">
    <link rel="stylesheet" href="styles/responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* Subscription Status Styles */
        .subscription-status {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem 1rem;
            background: rgba(33, 38, 45, 0.6);
            border: 1px solid #30363d;
            border-radius: 8px;
            margin-right: 1rem;
        }

        .plan-badge {
            background: linear-gradient(45deg, #58a6ff, #1f6feb);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .plan-badge.free {
            background: linear-gradient(45deg, #8b949e, #6e7681);
        }

        .plan-badge.pro {
            background: linear-gradient(45deg, #58a6ff, #1f6feb);
        }

        .plan-badge.enterprise {
            background: linear-gradient(45deg, #9d4edd, #7c3aed);
        }

        /* Project Context Styles */
        .project-files-info {
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid rgba(88, 166, 255, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .welcome-content a {
            color: #58a6ff;
            text-decoration: none;
        }

        .welcome-content a:hover {
            text-decoration: underline;
        }

        .usage-counter {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #8b949e;
            font-size: 0.85rem;
        }

        .usage-bar {
            width: 100px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .usage-fill {
            height: 100%;
            background: linear-gradient(90deg, #58a6ff, #1f6feb);
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        .usage-fill.warning {
            background: linear-gradient(90deg, #d4ac0d, #f39c12);
        }

        .usage-fill.danger {
            background: linear-gradient(90deg, #f85149, #da3633);
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="roassistant-logo.png" alt="RoAssistant Logo" class="sidebar-logo" style="width: 40px; height: 40px; object-fit: contain;">
            <div class="sidebar-title">RoAssistant</div>
        </div>

        <button class="new-chat-btn" onclick="startNewChat()">
            <span>+</span>
            New chat
        </button>

        <div class="sidebar-nav">
            <!-- Main Navigation -->
            <div class="nav-section">
                <div class="nav-item" onclick="setActiveNav(this, 'chats')">
                    <span class="nav-icon"><i class="fas fa-comments"></i></span>
                    Chats
                </div>
                <div class="nav-item active" onclick="setActiveNav(this, 'projects')">
                    <span class="nav-icon"><i class="fas fa-folder"></i></span>
                    Projects
                </div>
                <div class="nav-item" onclick="setActiveNav(this, 'scripts')">
                    <span class="nav-icon"><i class="fas fa-wrench"></i></span>
                    Scripts
                </div>
                <div class="nav-item authenticated-only" onclick="window.location.href='/account.html'" style="color: #8b949e;">
                    <span class="nav-icon">⚙️</span>
                    Account
                </div>
                <div class="nav-item" onclick="window.location.href='/pricing.html'" style="color: #58a6ff;">
                    <span class="nav-icon"><i class="fas fa-gem"></i></span>
                    Upgrade Plan
                </div>
            </div>

            <!-- Recent Chats -->
            <div class="nav-section">
                <div class="nav-title">Recents</div>
                <div id="chatHistory">
                    <!-- Chat history will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <div class="sidebar-footer">
            <div class="user-profile" id="userProfile">
                <!-- Default Sign In button - will be replaced by JavaScript -->
                <div class="user-avatar"><i class="fas fa-user"></i></div>
                <div class="user-info">
                    <div class="user-name">Guest User</div>
                    <div class="user-plan">Free Plan - <span style="color: #58a6ff; cursor: pointer;" onclick="window.location.href='/login.html'">Sign In for More</span></div>
                </div>
                <button onclick="window.location.href='/login.html'" style="background: #238636; border: none; border-radius: 6px; color: white; padding: 0.4rem 0.8rem; font-size: 0.8rem; cursor: pointer; margin-left: 0.5rem;">
                    Sign In
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Header -->
        <div class="main-header">
            <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleSidebar()">
                ☰
            </button>
            <div class="header-title" id="chatTitle">New Chat</div>

            <!-- Subscription Status -->
            <div class="subscription-status" id="subscriptionStatus" style="display: none;">
                <a href="/account.html" style="text-decoration: none;">
                    <div class="plan-badge" id="planBadge" style="cursor: pointer; transition: transform 0.2s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'" title="View Account Details">Free</div>
                </a>
                <div class="usage-counter">
                    <span id="usageText">0/10</span>
                    <div class="usage-bar">
                        <div class="usage-fill" id="usageFill" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <div class="messages-container" id="messagesContainer">
                <!-- Welcome Screen -->
                <div class="welcome-screen stagger-animation" id="welcomeScreen">
                    <div class="welcome-icon"><i class="fas fa-rocket"></i></div>
                    <h1 class="welcome-title" data-text="Welcome to RoAssistant">Welcome to RoAssistant</h1>
                    <p class="welcome-subtitle">Your intelligent assistant for Roblox game development</p>
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-container">
                <div class="input-wrapper" id="inputWrapper">
                    <div class="input-content">
                        <!-- File attachments area -->
                        <div class="file-attachments" id="fileAttachments" style="display: none;"></div>

                        <!-- Input row -->
                        <div class="input-row">
                            <button class="model-button" id="modelButton" onclick="toggleModelSelector()" title="Select AI Model">
                                <span><i class="fas fa-sliders-h"></i></span>
                            </button>

                            <!-- Model Selector Dropdown -->
                            <div class="model-dropdown" id="modelDropdown" style="display: none;">
                                <div class="model-dropdown-header">Select Model</div>
                                <div class="model-option selected" data-model="claude-4-sonnet" onclick="selectModel('claude-4-sonnet')">
                                    <div class="model-name">RoCode 3</div>
                                    <i class="fas fa-check model-check"></i>
                                </div>
                                <div class="model-option premium" data-model="claude-4-opus" onclick="selectModel('claude-4-opus')">
                                    <div class="model-name">RoCode Nexus 3</div>
                                    <i class="fas fa-check model-check" style="display: none;"></i>
                                </div>
                            </div>

                            <textarea
                                class="input-area"
                                id="messageInput"
                                placeholder="Ask me about your project..."
                                rows="1"
                            ></textarea>
                            <button class="send-button" id="sendButton" onclick="sendMessage()">
                                <span>Send</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DYNAMIC API CONFIGURATION
        const getApiBaseUrl = () => {
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                return 'http://localhost:3000';
            }
            return 'https://roassistantv3-production.up.railway.app';
        };

        const API_BASE_URL = getApiBaseUrl();
        console.log(`[CONFIG] Using API Base URL: ${API_BASE_URL}`);

        // Global variables
        let selectedModel = 'claude-4-sonnet';
        window.selectedModel = selectedModel;
        let currentProject = null;

        // Load project context from URL
        function loadProjectFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('project');

            if (projectId) {
                // Load project from localStorage
                const projects = JSON.parse(localStorage.getItem('roblox_projects') || '[]');
                currentProject = projects.find(p => p.id === projectId);

                if (currentProject) {
                    // Set project in chat manager
                    if (window.chatManager) {
                        window.chatManager.currentProject = currentProject;
                        console.log('Project loaded in ChatManager:', currentProject.name);
                    }

                    // Update UI to show project name
                    const chatTitle = document.getElementById('chatTitle');
                    if (chatTitle) {
                        chatTitle.textContent = `Project: ${currentProject.name}`;
                    }
                } else {
                    console.log('Project not found:', projectId);
                    window.location.href = 'projects.html';
                }
            } else {
                window.location.href = 'projects.html';
            }
        }

        // Global sendMessage wrapper
        function sendMessage() {
            if (window.chatManager) {
                window.chatManager.sendMessage();
            } else {
                console.error('ChatManager not initialized');
            }
        }

        // Toggle model selector dropdown
        function toggleModelSelector() {
            const dropdown = document.getElementById('modelDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        // Select a model
        function selectModel(model) {
            selectedModel = model;
            window.selectedModel = selectedModel;

            // Update selected state in dropdown
            document.querySelectorAll('.model-option').forEach(option => {
                option.classList.remove('selected');
                const check = option.querySelector('.model-check');
                if (check) {
                    check.style.display = 'none';
                }
            });

            const selectedOption = document.querySelector(`.model-option[data-model="${model}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
                const check = selectedOption.querySelector('.model-check');
                if (check) {
                    check.style.display = 'block';
                }
            }

            // Start a new chat when model changes
            startNewChat();

            // Show a message indicating the model change
            const modelName = model === 'claude-4-opus' ? 'RoCode Nexus 3' : 'RoCode 3';
            if (window.chatManager) {
                window.chatManager.addMessage('system', `🔄 Switched to ${modelName}. Starting a new conversation.`);
            }

            // Hide dropdown
            document.getElementById('modelDropdown').style.display = 'none';
        }

        // Start new chat
        function startNewChat() {
            if (window.chatManager) {
                window.chatManager.startNewChat();
            }
        }

        // Set active nav
        function setActiveNav(element, section) {
            if (section === 'chats') {
                window.location.href = 'index.html';
            } else if (section === 'projects') {
                window.location.href = 'projects.html';
            } else if (section === 'scripts') {
                window.location.href = 'scripts.html';
            }
        }

        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }

        // Load project when DOM is ready
        window.addEventListener('DOMContentLoaded', function() {
            console.log('Project chat DOM loaded');
            loadProjectFromUrl();

            // Set project in chat manager after it's initialized
            setTimeout(() => {
                if (window.chatManager && currentProject) {
                    window.chatManager.currentProject = currentProject;
                    console.log('Project set:', currentProject.name);
                }
            }, 100);
        });
    </script>

    <!-- Load JavaScript modules - EXACT SAME ORDER AS index.html -->
    <script src="js/auth.js"></script>
    <script src="js/chat.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/scripts.js"></script>
    <script src="js/micro-interactions.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

    <!-- ReactBits-Inspired Animations -->
    <script src="js/animations/dot-grid-background.js"></script>
    <script src="js/animations/cursor-trail.js"></script>
    <script src="js/animations/blur-text.js"></script>
    <script src="js/animations/micro-interactions.js"></script>
    <script src="js/animations/animations-init.js"></script>

    <script src="js/app.js"></script>

    <!-- Initialize the application -->
    <script>
        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Add click outside listener for model dropdown
            document.addEventListener('click', function(e) {
                const modelDropdown = document.getElementById('modelDropdown');
                const modelButton = document.getElementById('modelButton');

                if (modelDropdown && modelButton) {
                    if (!modelButton.contains(e.target) && !modelDropdown.contains(e.target)) {
                        modelDropdown.style.display = 'none';
                    }
                }
            });
        });
    </script>
</body>
</html>