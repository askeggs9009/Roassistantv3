<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoAssistant - Project Chat</title>
    <link rel="icon" type="image/png" href="/roassistant-logo.png">

    <link rel="stylesheet" href="styles/liquid-glass.css">
    <link rel="stylesheet" href="styles/dot-grid.css">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/sidebar.css">
    <link rel="stylesheet" href="styles/chat.css">
    <link rel="stylesheet" href="styles/animations.css">
    <link rel="stylesheet" href="styles/responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* Subscription Status Styles */
        .subscription-status {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem 1rem;
            background: rgba(33, 38, 45, 0.6);
            border: 1px solid #30363d;
            border-radius: 8px;
            margin-right: 1rem;
        }

        .plan-badge {
            background: linear-gradient(45deg, #58a6ff, #1f6feb);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .plan-badge.free {
            background: linear-gradient(45deg, #8b949e, #6e7681);
        }

        .plan-badge.pro {
            background: linear-gradient(45deg, #58a6ff, #1f6feb);
        }

        .plan-badge.enterprise {
            background: linear-gradient(45deg, #9d4edd, #7c3aed);
        }

        /* Project Context Styles */
        .project-files-info {
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid rgba(88, 166, 255, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .welcome-content a {
            color: #58a6ff;
            text-decoration: none;
        }

        .welcome-content a:hover {
            text-decoration: underline;
        }

        .usage-counter {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #8b949e;
            font-size: 0.85rem;
        }

        .usage-bar {
            width: 100px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .usage-fill {
            height: 100%;
            background: linear-gradient(90deg, #58a6ff, #1f6feb);
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        .usage-fill.warning {
            background: linear-gradient(90deg, #d4ac0d, #f39c12);
        }

        .usage-fill.danger {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }

        /* Roblox Connection Status Styles */
        .roblox-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            background: rgba(33, 38, 45, 0.6);
            border: 1px solid #30363d;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-right: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .roblox-status:hover {
            background: rgba(33, 38, 45, 0.8);
            border-color: #484f58;
        }

        .roblox-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .roblox-status-dot.connected {
            background: #57f287;
            box-shadow: 0 0 8px rgba(87, 242, 135, 0.6);
        }

        .roblox-status-dot.disconnected {
            background: #ed4245;
            box-shadow: 0 0 8px rgba(237, 66, 69, 0.6);
        }

        .roblox-status-text {
            color: #8b949e;
            font-weight: 500;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Send to Roblox Button */
        .send-to-roblox-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            transition: all 0.2s ease;
            margin-left: 0.5rem;
        }

        .send-to-roblox-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
        }

        .send-to-roblox-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .send-to-roblox-btn i {
            font-size: 0.9rem;
        }

        .usage-fill.danger {
            background: linear-gradient(90deg, #f85149, #da3633);
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="roassistant-logo.png" alt="RoAssistant Logo" class="sidebar-logo" style="width: 40px; height: 40px; object-fit: contain;">
            <div class="sidebar-title">RoAssistant</div>
        </div>

        <button class="new-chat-btn" onclick="startNewChat()">
            <span>+</span>
            New chat
        </button>

        <div class="sidebar-nav">
            <!-- Main Navigation -->
            <div class="nav-section">
                <div class="nav-item" onclick="setActiveNav(this, 'chats')">
                    <span class="nav-icon"><i class="fas fa-comments"></i></span>
                    Chats
                </div>
                <div class="nav-item active" onclick="setActiveNav(this, 'projects')">
                    <span class="nav-icon"><i class="fas fa-folder"></i></span>
                    Projects
                </div>
                <div class="nav-item" onclick="setActiveNav(this, 'scripts')">
                    <span class="nav-icon"><i class="fas fa-wrench"></i></span>
                    Scripts
                </div>
                <div class="nav-item authenticated-only" onclick="window.location.href='/account.html'" style="color: #8b949e;">
                    <span class="nav-icon">⚙️</span>
                    Account
                </div>
                <div class="nav-item" onclick="window.location.href='/pricing.html'" style="color: #58a6ff;">
                    <span class="nav-icon"><i class="fas fa-gem"></i></span>
                    Upgrade Plan
                </div>
            </div>

            <!-- Recent Chats -->
            <div class="nav-section">
                <div class="nav-title">Recents</div>
                <div id="chatHistory">
                    <!-- Chat history will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <div class="sidebar-footer">
            <div class="user-profile" id="userProfile">
                <!-- Default Sign In button - will be replaced by JavaScript -->
                <div class="user-avatar"><i class="fas fa-user"></i></div>
                <div class="user-info">
                    <div class="user-name">Guest User</div>
                    <div class="user-plan">Free Plan - <span style="color: #58a6ff; cursor: pointer;" onclick="window.location.href='/login.html'">Sign In for More</span></div>
                </div>
                <button onclick="window.location.href='/login.html'" style="background: #238636; border: none; border-radius: 6px; color: white; padding: 0.4rem 0.8rem; font-size: 0.8rem; cursor: pointer; margin-left: 0.5rem;">
                    Sign In
                </button>
            </div>
        </div>
    </div>

    <!-- Code Panel (for displaying code blocks) -->
    <div class="code-panel-overlay" id="codePanel">
        <div class="code-panel-resize-handle" id="codePanelResizeHandle"></div>
        <div class="code-panel-header">
            <div class="code-panel-title">
                <i class="fas fa-code"></i>
                <span>Code Output</span>
            </div>
            <button class="code-panel-close" onclick="closeCodePanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="code-panel-content" id="codePanelContent">
            <!-- Code blocks will be displayed here -->
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Header -->
        <div class="main-header">
            <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleSidebar()">
                ☰
            </button>
            <div class="header-title" id="chatTitle">New Chat</div>

            <!-- Subscription Status -->
            <div class="subscription-status" id="subscriptionStatus" style="display: none;">
                <a href="/account.html" style="text-decoration: none;">
                    <div class="plan-badge" id="planBadge" style="cursor: pointer; transition: transform 0.2s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'" title="View Account Details">Free</div>
                </a>
                <div class="usage-counter">
                    <span id="usageText">0/10</span>
                    <div class="usage-bar">
                        <div class="usage-fill" id="usageFill" style="width: 0%;"></div>
                    </div>
                </div>
            </div>

            <!-- Roblox Connection Status -->
            <div class="roblox-status" id="robloxStatus" title="Click to check connection">
                <div class="roblox-status-dot disconnected" id="robloxStatusDot"></div>
                <span class="roblox-status-text" id="robloxStatusText">Roblox Studio</span>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <div class="messages-container" id="messagesContainer">
                <!-- Welcome Screen -->
                <div class="welcome-screen stagger-animation" id="welcomeScreen">
                    <div class="welcome-icon"><i class="fas fa-rocket"></i></div>
                    <h1 class="welcome-title" data-text="Welcome to RoAssistant">Welcome to RoAssistant</h1>
                    <p class="welcome-subtitle">Your intelligent assistant for Roblox game development</p>
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-container">
                <div class="input-wrapper" id="inputWrapper">
                    <div class="input-content">
                        <!-- File attachments area -->
                        <div class="file-attachments" id="fileAttachments" style="display: none;"></div>

                        <!-- Roblox Auto-Send Toggle -->
                        <div class="roblox-toggle-container" style="padding: 8px 12px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <input type="checkbox" id="robloxAutoSend" style="width: 16px; height: 16px; cursor: pointer;">
                            <label for="robloxAutoSend" style="cursor: pointer; user-select: none; font-size: 14px; color: rgba(255,255,255,0.8); flex: 1;">
                                <i class="fas fa-cube" style="margin-right: 6px;"></i>
                                Auto-send to Roblox Studio
                            </label>
                            <div id="robloxStatus" style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: rgba(255,255,255,0.6);">
                                <div id="robloxStatusDot" style="width: 8px; height: 8px; border-radius: 50%; background: #666;"></div>
                                <span id="robloxStatusText">Checking...</span>
                            </div>
                        </div>

                        <!-- Input row -->
                        <div class="input-row">
                            <button class="model-button" id="modelButton" onclick="toggleModelSelector()" title="Select AI Model">
                                <span><i class="fas fa-sliders-h"></i></span>
                            </button>

                            <!-- Model Selector Dropdown -->
                            <div class="model-dropdown" id="modelDropdown" style="display: none;">
                                <div class="model-dropdown-header">Select Model</div>
                                <div class="model-option selected" data-model="claude-4-sonnet" onclick="selectModel('claude-4-sonnet')">
                                    <div class="model-name">RoCode 3</div>
                                    <i class="fas fa-check model-check"></i>
                                </div>
                                <div class="model-option premium" data-model="claude-4-opus" onclick="selectModel('claude-4-opus')">
                                    <div class="model-name">RoCode Nexus 3</div>
                                    <i class="fas fa-check model-check" style="display: none;"></i>
                                </div>
                            </div>

                            <textarea
                                class="input-area"
                                id="messageInput"
                                placeholder="Ask me about your project..."
                                rows="1"
                            ></textarea>
                            <button class="send-button" id="sendButton" onclick="sendMessage()">
                                <span>Send</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DYNAMIC API CONFIGURATION
        const getApiBaseUrl = () => {
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                return 'http://localhost:3000';
            }
            return 'https://roassistantv3-production.up.railway.app';
        };

        const API_BASE_URL = getApiBaseUrl();
        console.log(`[CONFIG] Using API Base URL: ${API_BASE_URL}`);

        // Global variables
        let selectedModel = 'claude-4-sonnet';
        window.selectedModel = selectedModel;
        let currentProject = null;
        let currentChatName = 'New Chat';

        // Load project context from URL
        function loadProjectFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('project');

            if (projectId) {
                // Load project from localStorage with full artifact data
                const projects = JSON.parse(localStorage.getItem('roblox_projects') || '[]');
                currentProject = projects.find(p => p.id === projectId);

                if (currentProject) {
                    // Ensure artifacts array exists
                    if (!currentProject.artifacts) {
                        currentProject.artifacts = [];
                    }

                    // Log project details for debugging
                    console.log('Project loaded:', currentProject.name);
                    console.log('Project artifacts:', currentProject.artifacts?.length || 0);
                    console.log('Project instructions:', currentProject.instructions?.substring(0, 100));

                    // Set project in chat manager
                    if (window.chatManager) {
                        window.chatManager.currentProject = currentProject;
                        console.log('Project set in ChatManager with', currentProject.artifacts?.length || 0, 'artifacts');
                    }

                    // Update UI to show project/chat format
                    updateChatTitle();

                    // Display artifacts in welcome screen if available
                    displayProjectArtifacts();
                } else {
                    console.log('Project not found:', projectId);
                    window.location.href = 'projects.html';
                }
            } else {
                window.location.href = 'projects.html';
            }
        }

        // Display project artifacts in the welcome screen
        function displayProjectArtifacts() {
            if (!currentProject || !currentProject.artifacts || currentProject.artifacts.length === 0) return;

            const welcomeScreen = document.getElementById('welcomeScreen');
            if (welcomeScreen) {
                const artifactsList = currentProject.artifacts.map(artifact => {
                    const icon = artifact.type === 'image' ? '🖼️' : '📝';
                    return `<li>${icon} ${artifact.name}</li>`;
                }).join('');

                const artifactsSection = `
                    <div class="project-files-info" style="margin-top: 1.5rem;">
                        <strong>📦 Available Artifacts:</strong>
                        <ul style="margin-top: 0.5rem; list-style: none; padding-left: 0;">
                            ${artifactsList}
                        </ul>
                        <p style="font-size: 0.85rem; color: #8b949e; margin-top: 0.5rem;">
                            These artifacts are automatically included when relevant to your questions.
                        </p>
                    </div>
                `;

                const welcomeContent = welcomeScreen.querySelector('.welcome-subtitle');
                if (welcomeContent) {
                    welcomeContent.insertAdjacentHTML('afterend', artifactsSection);
                }
            }
        }

        // Update chat title in directory format
        function updateChatTitle() {
            const chatTitle = document.getElementById('chatTitle');
            if (!chatTitle) return;

            if (currentProject) {
                const artifactCount = currentProject.artifacts?.length || 0;
                const artifactInfo = artifactCount > 0 ?
                    `<span style="color: #58a6ff; font-size: 0.85rem; margin-left: 0.5rem;">(${artifactCount} artifact${artifactCount !== 1 ? 's' : ''})</span>` : '';

                chatTitle.innerHTML = `
                    <span style="color: #8b949e;">${currentProject.name}</span>
                    <span style="color: #484f58; margin: 0 0.25rem;">/</span>
                    <span>${currentChatName}</span>
                    ${artifactInfo}
                `;
            } else {
                chatTitle.textContent = currentChatName;
            }
        }

        // Update chat name when it changes
        window.updateChatName = function(newName) {
            currentChatName = newName || 'New Chat';
            updateChatTitle();
        }

        // Global sendMessage wrapper
        function sendMessage() {
            if (window.chatManager) {
                window.chatManager.sendMessage();
            } else {
                console.error('ChatManager not initialized');
            }
        }

        // Toggle model selector dropdown
        function toggleModelSelector() {
            const dropdown = document.getElementById('modelDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        // Select a model
        function selectModel(model) {
            selectedModel = model;
            window.selectedModel = selectedModel;

            // Update selected state in dropdown
            document.querySelectorAll('.model-option').forEach(option => {
                option.classList.remove('selected');
                const check = option.querySelector('.model-check');
                if (check) {
                    check.style.display = 'none';
                }
            });

            const selectedOption = document.querySelector(`.model-option[data-model="${model}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
                const check = selectedOption.querySelector('.model-check');
                if (check) {
                    check.style.display = 'block';
                }
            }

            // Start a new chat when model changes
            startNewChat();

            // Show a message indicating the model change
            const modelName = model === 'claude-4-opus' ? 'RoCode Nexus 3' : 'RoCode 3';
            if (window.chatManager) {
                window.chatManager.addMessage('system', `🔄 Switched to ${modelName}. Starting a new conversation.`);
            }

            // Hide dropdown
            document.getElementById('modelDropdown').style.display = 'none';
        }

        // Start new chat
        function startNewChat() {
            currentChatName = 'New Chat';
            updateChatTitle();
            if (window.chatManager) {
                window.chatManager.startNewChat();
            }
        }

        // Set active nav
        function setActiveNav(element, section) {
            if (section === 'chats') {
                window.location.href = 'index.html';
            } else if (section === 'projects') {
                window.location.href = 'projects.html';
            } else if (section === 'scripts') {
                window.location.href = 'scripts.html';
            }
        }

        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }

        // ============================================
        // ROBLOX AUTO-SEND FUNCTIONALITY
        // ============================================

        let robloxConnected = false;

        // Check Roblox connection status
        async function checkRobloxConnection() {
            try {
                const response = await fetch(`${getApiBaseUrl()}/roblox/connection-status`);
                const data = await response.json();

                robloxConnected = data.connected && data.clients > 0;

                const statusDot = document.getElementById('robloxStatusDot');
                const statusText = document.getElementById('robloxStatusText');
                const checkbox = document.getElementById('robloxAutoSend');

                if (robloxConnected) {
                    statusDot.style.background = '#57f287'; // Green
                    statusText.textContent = 'Connected';
                    checkbox.disabled = false;
                } else {
                    statusDot.style.background = '#ed4245'; // Red
                    statusText.textContent = 'Not Connected';
                    checkbox.disabled = true;
                    checkbox.checked = false;
                }
            } catch (error) {
                console.error('[Roblox] Failed to check connection:', error);
                const statusDot = document.getElementById('robloxStatusDot');
                const statusText = document.getElementById('robloxStatusText');
                statusDot.style.background = '#666';
                statusText.textContent = 'Error';
            }
        }

        // Send code to Roblox Studio
        async function sendCodeToRoblox(codeBlock) {
            try {
                const scriptName = codeBlock.summary || codeBlock.id || 'GeneratedScript';

                const response = await fetch(`${getApiBaseUrl()}/roblox/send-script`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: scriptName,
                        code: codeBlock.code,
                        scriptType: 'Script',
                        location: 'ServerScriptService'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    console.log(`[Roblox] ✅ Sent script: ${scriptName}`);
                    return { success: true, scriptName };
                } else {
                    console.error(`[Roblox] ❌ Failed to send script: ${scriptName}`);
                    return { success: false, scriptName };
                }
            } catch (error) {
                console.error('[Roblox] Error sending script:', error);
                return { success: false, scriptName: codeBlock.summary || 'Unknown' };
            }
        }

        // Auto-send all code blocks to Roblox if toggle is enabled
        async function autoSendToRoblox() {
            const checkbox = document.getElementById('robloxAutoSend');

            // Check if toggle is enabled and we're connected
            if (!checkbox.checked || !robloxConnected) {
                return;
            }

            // Get all code blocks from global storage
            if (!window._codeBlocks || Object.keys(window._codeBlocks).length === 0) {
                console.log('[Roblox] No code blocks to send');
                return;
            }

            console.log(`[Roblox] Auto-sending ${Object.keys(window._codeBlocks).length} code blocks...`);

            const results = [];
            for (const blockId in window._codeBlocks) {
                const result = await sendCodeToRoblox(window._codeBlocks[blockId]);
                results.push(result);
            }

            // Show notification
            const successCount = results.filter(r => r.success).length;
            const totalCount = results.length;

            if (successCount > 0) {
                // Create a simple toast notification
                showRobloxNotification(`✅ Sent ${successCount}/${totalCount} script(s) to Roblox Studio`);
            } else {
                showRobloxNotification(`❌ Failed to send scripts to Roblox Studio`, 'error');
            }
        }

        // Show notification toast
        function showRobloxNotification(message, type = 'success') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                padding: 12px 20px;
                background: ${type === 'success' ? '#57f287' : '#ed4245'};
                color: #000;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            // Add animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(400px); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);

            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Save toggle state to localStorage
        function saveRobloxToggleState() {
            const checkbox = document.getElementById('robloxAutoSend');
            localStorage.setItem('robloxAutoSend', checkbox.checked ? 'true' : 'false');
        }

        // Load toggle state from localStorage
        function loadRobloxToggleState() {
            const saved = localStorage.getItem('robloxAutoSend');
            if (saved === 'true') {
                const checkbox = document.getElementById('robloxAutoSend');
                checkbox.checked = true;
            }
        }

        // Hook into ChatManager to trigger auto-send when message completes
        function setupRobloxAutoSendHook() {
            // Check connection every 5 seconds
            checkRobloxConnection();
            setInterval(checkRobloxConnection, 5000);

            // Load saved toggle state
            loadRobloxToggleState();

            // Save state when checkbox changes
            const checkbox = document.getElementById('robloxAutoSend');
            checkbox.addEventListener('change', saveRobloxToggleState);

            // Override the original addMessage to trigger auto-send when assistant messages complete
            if (window.chatManager) {
                const originalAddMessage = window.chatManager.addMessage.bind(window.chatManager);

                window.chatManager.addMessage = function(role, content, options) {
                    const result = originalAddMessage(role, content, options);

                    // If this is an assistant message, trigger auto-send after a short delay
                    // to ensure code blocks are processed
                    if (role === 'assistant') {
                        setTimeout(() => {
                            autoSendToRoblox();
                        }, 500);
                    }

                    return result;
                };
            }
        }

        // ============================================
        // END ROBLOX FUNCTIONALITY
        // ============================================

        // Load project when DOM is ready
        window.addEventListener('DOMContentLoaded', function() {
            console.log('Project chat DOM loaded');
            loadProjectFromUrl();

            // Set project in chat manager after it's initialized
            // Use a longer delay and multiple attempts to ensure ChatManager is ready
            let attempts = 0;
            const maxAttempts = 10;

            const setProjectInChatManager = () => {
                if (window.chatManager && currentProject) {
                    // Ensure currentProject has all its data including artifacts
                    window.chatManager.currentProject = currentProject;
                    console.log('Project set in ChatManager:', currentProject.name);
                    console.log('With artifacts:', currentProject.artifacts?.length || 0);

                    // Force update the welcome screen with project info
                    if (window.chatManager.updateWelcomeScreen) {
                        window.chatManager.updateWelcomeScreen();
                    }

                    // Display artifacts if not already displayed
                    displayProjectArtifacts();
                } else if (attempts < maxAttempts) {
                    attempts++;
                    setTimeout(setProjectInChatManager, 200);
                } else {
                    console.error('Failed to set project in ChatManager after', maxAttempts, 'attempts');
                }
            };

            setTimeout(setProjectInChatManager, 100);

            // Initialize Roblox auto-send functionality
            setTimeout(setupRobloxAutoSendHook, 500);
        });
    </script>

    <!-- Load JavaScript modules - EXACT SAME ORDER AS index.html -->
    <script src="js/storage-utils.js"></script>
    <script src="js/sync-manager.js"></script>
    <script src="js/sync-ui.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/chat.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/scripts.js"></script>
    <script src="js/micro-interactions.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

    <!-- ReactBits-Inspired Animations -->
    <script src="js/animations/dot-grid-background.js"></script>
    <script src="js/animations/blur-text.js"></script>
    <script src="js/animations/micro-interactions.js"></script>
    <script src="js/animations/animations-init.js"></script>

    <script src="js/app.js"></script>

    <!-- Initialize the application -->
    <script>
        // Ensure openCodePanel is available globally for project chat
        if (!window.openCodePanel) {
            window.openCodePanel = function(blockId) {
                console.log('[Project Chat] openCodePanel called for:', blockId);
                if (window.chatManager && window.chatManager.openCodePanel) {
                    window.chatManager.openCodePanel(blockId);
                } else {
                    console.error('[Project Chat] ChatManager not ready, retrying...');
                    // Retry after a short delay
                    setTimeout(() => {
                        if (window.chatManager && window.chatManager.openCodePanel) {
                            window.chatManager.openCodePanel(blockId);
                        } else {
                            console.error('[Project Chat] ChatManager still not available');
                        }
                    }, 500);
                }
            };
        }

        // Close code panel function
        function closeCodePanel() {
            const codePanel = document.getElementById('codePanel');
            const mainContent = document.getElementById('mainContent');

            if (codePanel) {
                codePanel.classList.remove('active');
            }
            if (mainContent) {
                mainContent.classList.remove('code-panel-active');
            }
        }

        // Make closeCodePanel globally available
        window.closeCodePanel = closeCodePanel;

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Add click outside listener for model dropdown
            document.addEventListener('click', function(e) {
                const modelDropdown = document.getElementById('modelDropdown');
                const modelButton = document.getElementById('modelButton');

                if (modelDropdown && modelButton) {
                    if (!modelButton.contains(e.target) && !modelDropdown.contains(e.target)) {
                        modelDropdown.style.display = 'none';
                    }
                }
            });

            // Code panel resize functionality
            const codePanel = document.getElementById('codePanel');
            const resizeHandle = document.getElementById('codePanelResizeHandle');

            if (codePanel && resizeHandle) {
                let isResizing = false;
                let startX = 0;
                let startWidth = 0;

                resizeHandle.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    startX = e.clientX;
                    startWidth = codePanel.offsetWidth;
                    resizeHandle.classList.add('resizing');
                    document.body.style.cursor = 'ew-resize';
                    document.body.style.userSelect = 'none';
                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isResizing) return;

                    const deltaX = startX - e.clientX;
                    const newWidth = startWidth + deltaX;

                    // Min width: 300px, Max width: 80% of window
                    const minWidth = 300;
                    const maxWidth = window.innerWidth * 0.8;

                    if (newWidth >= minWidth && newWidth <= maxWidth) {
                        codePanel.style.width = `${newWidth}px`;
                    }
                });

                document.addEventListener('mouseup', () => {
                    if (isResizing) {
                        isResizing = false;
                        resizeHandle.classList.remove('resizing');
                        document.body.style.cursor = '';
                        document.body.style.userSelect = '';
                    }
                });
            }

            // ================================================
            // ROBLOX STUDIO INTEGRATION
            // ================================================

            // Check Roblox connection status
            async function checkRobloxConnection() {
                try {
                    const response = await fetch('/roblox/connection-status');
                    const data = await response.json();

                    const statusDot = document.getElementById('robloxStatusDot');
                    const statusText = document.getElementById('robloxStatusText');

                    if (data.connected) {
                        statusDot.classList.remove('disconnected');
                        statusDot.classList.add('connected');
                        statusText.textContent = 'Roblox Studio ✓';
                    } else {
                        statusDot.classList.remove('connected');
                        statusDot.classList.add('disconnected');
                        statusText.textContent = 'Roblox Studio';
                    }
                } catch (error) {
                    console.error('Error checking Roblox connection:', error);
                }
            }

            // Send script to Roblox Studio
            async function sendToRoblox(code, name, scriptType = 'Script', location = 'ServerScriptService') {
                try {
                    // Show loading state
                    const buttons = document.querySelectorAll('.send-to-roblox-btn');
                    buttons.forEach(btn => {
                        btn.disabled = true;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                    });

                    const response = await fetch('/roblox/send-script', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: name || 'GeneratedScript',
                            code: code,
                            scriptType: scriptType,
                            location: location
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Show success message
                        showToast(data.sentImmediately ?
                            '✅ Script sent to Roblox Studio!' :
                            '📥 Script queued for Roblox Studio', 'success');

                        // Reset button state
                        setTimeout(() => {
                            buttons.forEach(btn => {
                                btn.disabled = false;
                                btn.innerHTML = '<i class="fas fa-cube"></i> Send to Roblox';
                            });
                        }, 2000);
                    } else {
                        throw new Error(data.error || 'Failed to send script');
                    }
                } catch (error) {
                    console.error('Error sending to Roblox:', error);
                    showToast('❌ Failed to send script: ' + error.message, 'error');

                    // Reset button state
                    const buttons = document.querySelectorAll('.send-to-roblox-btn');
                    buttons.forEach(btn => {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-cube"></i> Send to Roblox';
                    });
                }
            }

            // Show toast notification
            function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    background: ${type === 'success' ? '#238636' : type === 'error' ? '#da3633' : '#1f6feb'};
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                    z-index: 10000;
                    font-size: 0.9rem;
                    animation: slideIn 0.3s ease;
                `;
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            // Add "Send to Roblox" buttons to code blocks
            function addRobloxButtons() {
                // Handle both regular code blocks AND artifact code previews
                const regularCodeBlocks = document.querySelectorAll('pre code');
                const artifactCodePreviews = document.querySelectorAll('.artifact-code-preview');

                // Handle regular code blocks
                regularCodeBlocks.forEach((codeBlock) => {
                    if (codeBlock.parentElement.querySelector('.send-to-roblox-btn')) {
                        return;
                    }

                    const code = codeBlock.textContent;
                    const button = document.createElement('button');
                    button.className = 'send-to-roblox-btn';
                    button.innerHTML = '<i class="fas fa-cube"></i> Send to Roblox';
                    button.onclick = () => {
                        let scriptName = 'GeneratedScript';
                        const messageDiv = codeBlock.closest('.message');
                        if (messageDiv) {
                            const text = messageDiv.textContent;
                            const match = text.match(/script\s+(?:named|called)\s+["']?(\w+)["']?/i);
                            if (match) {
                                scriptName = match[1];
                            }
                        }
                        sendToRoblox(code, scriptName);
                    };

                    const pre = codeBlock.parentElement;
                    if (pre.tagName === 'PRE') {
                        pre.style.position = 'relative';
                        button.style.position = 'absolute';
                        button.style.top = '8px';
                        button.style.right = '8px';
                        pre.appendChild(button);
                    }
                });

                // Handle artifact code previews
                artifactCodePreviews.forEach((artifact) => {
                    if (artifact.querySelector('.send-to-roblox-btn')) {
                        return;
                    }

                    const artifactId = artifact.dataset.artifactId;
                    if (!artifactId || !window._codeBlocks || !window._codeBlocks[artifactId]) {
                        return;
                    }

                    const codeData = window._codeBlocks[artifactId];
                    const button = document.createElement('button');
                    button.className = 'send-to-roblox-btn';
                    button.innerHTML = '<i class="fas fa-cube"></i> Send to Roblox';
                    button.style.position = 'absolute';
                    button.style.top = '12px';
                    button.style.right = '40px';
                    button.style.zIndex = '10';

                    button.onclick = (e) => {
                        e.stopPropagation(); // Prevent artifact from opening
                        const scriptName = codeData.title || 'GeneratedScript';
                        sendToRoblox(codeData.code, scriptName);
                    };

                    artifact.style.position = 'relative';
                    artifact.appendChild(button);
                });
            }

            // Initialize Roblox integration
            checkRobloxConnection();
            setInterval(checkRobloxConnection, 5000); // Check every 5 seconds

            // Add Roblox buttons when messages are added
            const messagesContainer = document.getElementById('messagesContainer');
            if (messagesContainer) {
                const observer = new MutationObserver(() => {
                    addRobloxButtons();
                });

                observer.observe(messagesContainer, {
                    childList: true,
                    subtree: true
                });
            }

            // Add click handler for connection status
            document.getElementById('robloxStatus')?.addEventListener('click', () => {
                checkRobloxConnection();
                showToast('🔄 Checking connection...', 'info');
            });

            // Add CSS animations for toast
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }

                @keyframes slideOut {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);

            // ================================================
            // END ROBLOX INTEGRATION
            // ================================================
        });
    </script>
</body>
</html>