<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projects - Roblox Luau AI Assistant</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/sidebar.css">
    <link rel="stylesheet" href="styles/chat.css">
    <link rel="stylesheet" href="styles/responsive.css">
    
    <!-- AdSense Integration -->
    <link rel="stylesheet" href="styles/ads.css">
    <script src="js/adsense.js"></script>

    <!-- Google AdSense Verification Code -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7434697703458325"
            crossorigin="anonymous"></script>

    <style>
        /* Subscription Status Styles */
        .subscription-status {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem 1rem;
            background: rgba(33, 38, 45, 0.6);
            border: 1px solid #30363d;
            border-radius: 8px;
            margin-right: 1rem;
        }

        .plan-badge {
            background: linear-gradient(45deg, #58a6ff, #1f6feb);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .plan-badge.free {
            background: linear-gradient(45deg, #8b949e, #6e7681);
        }

        .plan-badge.pro {
            background: linear-gradient(45deg, #58a6ff, #1f6feb);
        }

        .plan-badge.enterprise {
            background: linear-gradient(45deg, #9d4edd, #7c3aed);
        }

        /* Projects Page Styles */
        .project-card {
            background: rgba(33, 38, 45, 0.8);
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .project-card:hover {
            border-color: #58a6ff;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(88, 166, 255, 0.15);
        }
        
        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .project-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #58a6ff, #a5b4fc);
            font-size: 1.25rem;
        }
        
        .project-content h3 {
            color: #f0f6fc;
            margin: 0 0 0.5rem 0;
            font-size: 1.125rem;
        }
        
        .project-description {
            color: #8b949e;
            font-size: 0.875rem;
            margin: 0 0 1rem 0;
        }
        
        .project-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid #21262d;
        }
        
        .project-type {
            background: rgba(88, 166, 255, 0.15);
            color: #58a6ff;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        
        .project-updated {
            color: #6e7681;
            font-size: 0.75rem;
        }
        
        .project-menu-btn {
            background: none;
            border: none;
            color: #6e7681;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .project-card:hover .project-menu-btn {
            opacity: 1;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 2rem;
            width: 90%;
            max-width: 480px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-title {
            color: #f0f6fc;
            margin: 0;
            font-size: 1.25rem;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: #6e7681;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            color: #f0f6fc;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .form-input {
            width: 100%;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 0.75rem;
            color: #f0f6fc;
            font-size: 0.875rem;
            box-sizing: border-box;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #58a6ff;
        }
        
        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            font-weight: 600;
        }
        
        .btn-primary {
            background: #238636;
            color: white;
        }
        
        .btn-secondary {
            background: transparent;
            color: #8b949e;
            border: 1px solid #30363d;
        }
        
        /* Project Context Styles */
        .project-files-info {
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid rgba(88, 166, 255, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        
        .welcome-content a {
            color: #58a6ff;
            text-decoration: none;
        }
        
        .welcome-content a:hover {
            text-decoration: underline;
        }

        .usage-counter {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #8b949e;
            font-size: 0.85rem;
        }

        .usage-bar {
            width: 100px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .usage-fill {
            height: 100%;
            background: linear-gradient(90deg, #58a6ff, #1f6feb);
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        .usage-fill.warning {
            background: linear-gradient(90deg, #d4ac0d, #f39c12);
        }

        .usage-fill.danger {
            background: linear-gradient(90deg, #f85149, #da3633);
        }

        .upgrade-prompt {
            display: none;
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: linear-gradient(135deg, #161b22, #21262d);
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 350px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: slideInUp 0.3s ease;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .upgrade-prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .upgrade-prompt-title {
            font-weight: 600;
            color: #f0f6fc;
        }

        .upgrade-prompt-close {
            background: none;
            border: none;
            color: #8b949e;
            cursor: pointer;
            font-size: 1.5rem;
            line-height: 1;
        }

        .upgrade-prompt-message {
            color: #8b949e;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            line-height: 1.4;
        }

        .upgrade-prompt-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .upgrade-btn {
            flex: 1;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
        }

        .upgrade-btn.primary {
            background: linear-gradient(45deg, #238636, #2ea043);
            color: white;
        }

        .upgrade-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(46, 160, 67, 0.4);
        }

        .upgrade-btn.secondary {
            background: transparent;
            border: 1px solid #30363d;
            color: #8b949e;
        }

        .upgrade-btn.secondary:hover {
            border-color: #58a6ff;
            color: #58a6ff;
        }

        .model-locked {
            position: relative;
        }

        .model-locked::after {
            content: '🔒';
            position: absolute;
            right: 35px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
        }

        .usage-warning {
            background: rgba(212, 172, 13, 0.1);
            border: 1px solid rgba(212, 172, 13, 0.3);
            border-radius: 8px;
            padding: 0.75rem;
            margin: 1rem;
            color: #d4ac0d;
            font-size: 0.85rem;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .usage-limit-reached {
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid rgba(248, 81, 73, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem;
            color: #f85149;
            text-align: center;
            display: none;
        }

        /* FIXED: Account switch notification */
        .account-switch-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #58a6ff, #1f6feb);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(88, 166, 255, 0.4);
            z-index: 1000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .account-switch-notification.show {
            opacity: 1;
            transform: translateX(0);
        }
    </style>
</head>

<body>
    <!-- FIXED: Account Switch Notification -->
    <div class="account-switch-notification" id="accountSwitchNotification">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span>🔄</span>
            <span>Account switched! Loading your data...</span>
        </div>
    </div>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-icon">RL</div>
            <div class="sidebar-title">Roblox Assistant</div>
        </div>

        <button class="new-chat-btn" onclick="startNewChat()">
            <span>➕</span>
            New chat
        </button>

        <!-- Sidebar Ad Container -->
        <div id="sidebarAd" class="ad-container sidebar-ad" data-ad-lazy data-ad-type="sidebar">
            <div class="ad-label">Advertisement</div>
        </div>

        <div class="sidebar-nav">
            <!-- Main Navigation -->
            <div class="nav-section">
                <div class="nav-item" onclick="window.location.href='/index.html'">
                    <span class="nav-icon">💬</span>
                    Chats
                </div>
                <div class="nav-item active">
                    <span class="nav-icon">📂</span>
                    Projects
                </div>
                <div class="nav-item" onclick="setActiveNav(this, 'scripts')">
                    <span class="nav-icon">🔧</span>
                    Scripts
                </div>
                <div class="nav-item" onclick="window.location.href='/pricing.html'" style="color: #58a6ff;">
                    <span class="nav-icon">💎</span>
                    Upgrade Plan
                </div>
            </div>

            <!-- Recent Chats -->
            <div class="nav-section">
                <div class="nav-title">Recents</div>
                <div id="chatHistory">
                    <!-- Chat history will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <div class="sidebar-footer">
            <div class="user-profile" id="userProfile">
                <!-- Default Sign In button - will be replaced by JavaScript -->
                <div class="user-avatar">👤</div>
                <div class="user-info">
                    <div class="user-name">Guest User</div>
                    <div class="user-plan">Free Plan - <span style="color: #58a6ff; cursor: pointer;" onclick="window.location.href='/login.html'">Sign In for More</span></div>
                </div>
                <button onclick="window.location.href='/login.html'" style="background: #238636; border: none; border-radius: 6px; color: white; padding: 0.4rem 0.8rem; font-size: 0.8rem; cursor: pointer; margin-left: 0.5rem;">
                    Sign In
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="main-header">
            <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleSidebar()">
                ☰
            </button>
            <div class="header-title" id="chatTitle">Projects</div>
            
            <!-- Search Bar -->
            <div style="flex: 1; max-width: 400px; margin: 0 1rem;">
                <input type="text" id="projectSearchBar" placeholder="🔍 Search projects..." style="
                    width: 100%;
                    padding: 0.5rem 1rem;
                    background: rgba(33, 38, 45, 0.8);
                    border: 1px solid #30363d;
                    border-radius: 6px;
                    color: #f0f6fc;
                    font-size: 0.875rem;
                " onkeyup="searchProjects(this.value)">
            </div>
            
            <!-- Subscription Status -->
            <div class="subscription-status" id="subscriptionStatus" style="display: none;">
                <div class="plan-badge" id="planBadge">Free</div>
                <div class="usage-counter">
                    <span id="usageText">0/10</span>
                    <div class="usage-bar">
                        <div class="usage-fill" id="usageFill" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
            
            <button class="new-project-btn" onclick="openNewProjectModal()" style="background: #238636; border: none; border-radius: 6px; color: white; padding: 0.5rem 1rem; cursor: pointer;">
                ➕ New Project
            </button>
        </div>

        <!-- Usage Warning -->
        <div id="usageWarning" class="usage-warning">
            ⚠️ You're approaching your daily message limit. Consider upgrading for unlimited access!
        </div>

        <!-- Usage Limit Reached -->
        <div id="usageLimitReached" class="usage-limit-reached">
            🚫 Daily message limit reached. <a href="/pricing.html" style="color: #58a6ff;">Upgrade now</a> for unlimited messages!
        </div>

        <!-- Header Banner Ad -->
        <div id="headerBannerAd" class="ad-container banner-ad">
            <div class="ad-label">Advertisement</div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <div class="messages-container" id="messagesContainer">
                <!-- Projects Screen -->
                <div class="welcome-screen" id="projectsScreen">
                    <div class="welcome-icon">📂</div>
                    <h1 class="welcome-title">Your Projects</h1>
                    <p class="welcome-subtitle">Organize your Roblox development work</p>
                    
                    <!-- Projects Grid -->
                    <div id="projectsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; margin: 2rem 0;">
                        <!-- Projects will be populated by JavaScript -->
                    </div>
                    
                    <!-- Empty State -->
                    <div id="emptyState" style="display: none; text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">📋</div>
                        <h3 style="color: #f0f6fc; margin: 0 0 0.5rem 0;">Create Your First Project</h3>
                        <p style="color: #8b949e; margin: 0 0 2rem 0;">Start organizing your Roblox development work</p>
                        <button onclick="openNewProjectModal()" style="background: #238636; border: none; border-radius: 6px; color: white; padding: 0.75rem 1.5rem; cursor: pointer; font-size: 1rem;">
                            ➕ Create Project
                        </button>
                    </div>
                </div>
            </div>

        </div>

        <!-- Footer Ad -->
        <div id="footerAd" class="ad-container footer-ad">
            <div class="ad-label">Advertisement</div>
        </div>
    </div>

    <!-- New Project Modal -->
    <div class="modal" id="newProjectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create New Project</h2>
                <button class="modal-close" onclick="closeNewProjectModal()">×</button>
            </div>
            <form onsubmit="createProject(event)">
                <div class="form-group">
                    <label class="form-label" for="projectName">Project Name</label>
                    <input type="text" id="projectName" class="form-input" placeholder="My Awesome Game" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="projectDescription">Description</label>
                    <textarea id="projectDescription" class="form-input form-textarea" placeholder="What's your project about?"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="projectType">Project Type</label>
                    <select id="projectType" class="form-input">
                        <option value="game">🎮 Game</option>
                        <option value="script">🔧 Script Collection</option>
                        <option value="gui">🖥️ GUI Design</option>
                        <option value="system">⚙️ Game System</option>
                        <option value="other">📋 Other</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeNewProjectModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Upgrade Prompt -->
    <div class="upgrade-prompt" id="upgradePrompt">
        <div class="upgrade-prompt-header">
            <div class="upgrade-prompt-title">🚀 Unlock More Power</div>
            <button class="upgrade-prompt-close" onclick="closeUpgradePrompt()">×</button>
        </div>
        <div class="upgrade-prompt-message" id="upgradePromptMessage">
            You've used 8 of your 10 daily messages. Upgrade to Pro for 500 messages per day!
        </div>
        <div class="upgrade-prompt-buttons">
            <button class="upgrade-btn primary" onclick="window.location.href='/pricing.html'">
                View Plans
            </button>
            <button class="upgrade-btn secondary" onclick="closeUpgradePrompt()">
                Maybe Later
            </button>
        </div>
    </div>

    <script>
        // DYNAMIC API CONFIGURATION - Updated for production deployment
        const getApiBaseUrl = () => {
            // Check if we're running on localhost (development)
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                return 'http://localhost:3000';
            }
            
            // For production, point to Railway backend
            return 'https://roassistantv3-production.up.railway.app';
        };

        const API_BASE_URL = getApiBaseUrl();
        console.log(`[CONFIG] Using API Base URL: ${API_BASE_URL}`);

        // FIXED: Global variables with proper user isolation
        let currentChatId = null;
        let isLoggedIn = false;
        let authToken = null;
        let currentUser = null;
        let selectedModel = 'gpt-4o-mini';
        let currentView = 'chats';
        let attachedFiles = [];

        // FIXED: User-specific data storage
        let userChats = [];
        let userScripts = [];

        // Subscription management
        let userSubscription = {
            plan: 'free',
            limits: {
                daily_messages: 10,
                models: ['gpt-4o-mini']
            },
            usage: {
                daily_messages: 0,
                daily_limit: 10
            }
        };

        // Message counter for ad insertion
        let messageCount = 0;
        const AD_FREQUENCY = 5; // Show ad every 5 messages

        // FIXED: Account switching functionality
        class AccountManager {
            constructor() {
                this.lastKnownUser = null;
                this.initializeWatcher();
            }

            initializeWatcher() {
                // Watch for auth token changes
                const originalSetItem = localStorage.setItem;
                const originalRemoveItem = localStorage.removeItem;
                
                localStorage.setItem = (key, value) => {
                    if (key === 'authToken' || key === 'user') {
                        setTimeout(() => this.checkForAccountSwitch(), 100);
                    }
                    return originalSetItem.call(localStorage, key, value);
                };
                
                localStorage.removeItem = (key) => {
                    if (key === 'authToken' || key === 'user') {
                        setTimeout(() => this.checkForAccountSwitch(), 100);
                    }
                    return originalRemoveItem.call(localStorage, key);
                };
            }

            checkForAccountSwitch() {
                const currentToken = localStorage.getItem('authToken');
                const currentUserData = localStorage.getItem('user');
                
                let currentUserId = null;
                if (currentUserData) {
                    try {
                        const user = JSON.parse(currentUserData);
                        currentUserId = user.id || user.email;
                    } catch (error) {
                        console.error('Error parsing user data:', error);
                    }
                }

                // Check if user has switched
                if (this.lastKnownUser !== currentUserId) {
                    console.log('[ACCOUNT] User switch detected:', this.lastKnownUser, '->', currentUserId);
                    this.handleAccountSwitch(currentUserId);
                    this.lastKnownUser = currentUserId;
                }
            }
        }

        // Check premium status
        function checkPremiumStatus() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (user.premium || user.plan === 'premium') {
                document.body.classList.add('premium-user');
                console.log('[AdSense] Premium user detected - ads hidden');
            }
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing app...');
            initApp();
            
            // Check subscription status and refresh periodically
            checkSubscriptionStatus();
            setInterval(checkSubscriptionStatus, 60000); // Refresh every minute
            
            // Check premium status on load
            checkPremiumStatus();
        });

        // Check for project parameter in URL
        function checkProjectParameter() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('project');
            
            if (projectId) {
                // Load project context if needed
                console.log('Loading project context:', projectId);
                // You can implement project-specific logic here
            }
        }

        // Project Management System
        class ProjectManager {
            constructor() {
                this.projects = JSON.parse(localStorage.getItem('roblox_projects') || '[]');
                // Migrate old projects to include artifacts if they don't have them
                this.projects = this.projects.map(project => {
                    if (!project.artifacts) {
                        project.artifacts = [];
                    }
                    return project;
                });
                this.saveProjects();
            }

            createProject(name, description, type) {
                const project = {
                    id: 'project_' + Date.now(),
                    name,
                    description,
                    type,
                    created: Date.now(),
                    updated: Date.now(),
                    files: [],
                    artifacts: [] // Store uploaded files and text content
                };
                this.projects.push(project);
                this.saveProjects();
                return project;
            }

            saveProjects() {
                localStorage.setItem('roblox_projects', JSON.stringify(this.projects));
            }

            deleteProject(projectId) {
                this.projects = this.projects.filter(p => p.id !== projectId);
                this.saveProjects();
            }

            openProject(projectId) {
                window.location.href = `/project-chat.html?project=${projectId}`;
            }

            getProjectIcon(type) {
                const icons = {
                    'game': '🎮',
                    'script': '🔧',
                    'gui': '🖥️',
                    'system': '⚙️',
                    'other': '📋'
                };
                return icons[type] || '📋';
            }

            addArtifact(projectId, artifact) {
                const project = this.projects.find(p => p.id === projectId);
                if (project) {
                    if (!project.artifacts) {
                        project.artifacts = [];
                    }
                    project.artifacts.push(artifact);
                    project.updated = Date.now();
                    this.saveProjects();
                }
            }

            removeArtifact(projectId, artifactId) {
                const project = this.projects.find(p => p.id === projectId);
                if (project && project.artifacts) {
                    project.artifacts = project.artifacts.filter(a => a.id !== artifactId);
                    project.updated = Date.now();
                    this.saveProjects();
                }
            }
        }

        const projectManager = new ProjectManager();

        // Render projects
        function renderProjects(searchQuery = '') {
            const grid = document.getElementById('projectsGrid');
            const emptyState = document.getElementById('emptyState');
            
            // Filter projects based on search query
            let filteredProjects = projectManager.projects;
            if (searchQuery) {
                const query = searchQuery.toLowerCase();
                filteredProjects = projectManager.projects.filter(project => 
                    project.name.toLowerCase().includes(query) || 
                    (project.description && project.description.toLowerCase().includes(query)) ||
                    project.type.toLowerCase().includes(query)
                );
            }
            
            if (filteredProjects.length === 0) {
                grid.innerHTML = '';
                if (projectManager.projects.length === 0) {
                    emptyState.style.display = 'block';
                    emptyState.innerHTML = `
                        <div style="font-size: 3rem; margin-bottom: 1rem;">📋</div>
                        <h3 style="color: #f0f6fc; margin: 0 0 0.5rem 0;">Create Your First Project</h3>
                        <p style="color: #8b949e; margin: 0 0 2rem 0;">Start organizing your Roblox development work</p>
                        <button onclick="openNewProjectModal()" style="background: #238636; border: none; border-radius: 6px; color: white; padding: 0.75rem 1.5rem; cursor: pointer; font-size: 1rem;">
                            ➕ Create Project
                        </button>
                    `;
                } else {
                    emptyState.style.display = 'block';
                    emptyState.innerHTML = `
                        <div style="font-size: 3rem; margin-bottom: 1rem;">🔍</div>
                        <h3 style="color: #f0f6fc; margin: 0 0 0.5rem 0;">No projects found</h3>
                        <p style="color: #8b949e; margin: 0 0 2rem 0;">Try searching with different keywords</p>
                    `;
                }
                return;
            }
            
            emptyState.style.display = 'none';
            
            grid.innerHTML = filteredProjects.map(project => {
                const artifactCount = project.artifacts ? project.artifacts.length : 0;
                return `
                <div class="project-card" onclick="projectManager.openProject('${project.id}')">
                    <div class="project-header">
                        <div class="project-icon">${projectManager.getProjectIcon(project.type)}</div>
                        <button class="project-menu-btn" onclick="event.stopPropagation(); deleteProject('${project.id}')" title="Delete">×</button>
                    </div>
                    <div class="project-content">
                        <h3>${project.name}</h3>
                        <p class="project-description">${project.description || 'No description'}</p>
                        ${artifactCount > 0 ? `
                            <div style="margin: 0.5rem 0; color: #58a6ff; font-size: 0.85rem;">
                                📎 ${artifactCount} artifact${artifactCount !== 1 ? 's' : ''}
                            </div>
                        ` : ''}
                        <div class="project-meta">
                            <div class="project-type">${project.type}</div>
                            <div class="project-updated">${formatDate(project.updated)}</div>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // Search projects function
        function searchProjects(query) {
            renderProjects(query);
        }

        // Modal functions
        function openNewProjectModal() {
            document.getElementById('newProjectModal').style.display = 'block';
            document.getElementById('projectName').focus();
        }

        function closeNewProjectModal() {
            document.getElementById('newProjectModal').style.display = 'none';
            document.getElementById('projectName').value = '';
            document.getElementById('projectDescription').value = '';
            document.getElementById('projectType').value = 'game';
        }

        function createProject(event) {
            event.preventDefault();
            const name = document.getElementById('projectName').value.trim();
            const description = document.getElementById('projectDescription').value.trim();
            const type = document.getElementById('projectType').value;
            
            if (!name) return;
            
            const project = projectManager.createProject(name, description, type);
            closeNewProjectModal();
            renderProjects();
            
            // Auto-open the new project
            setTimeout(() => projectManager.openProject(project.id), 300);
        }

        function deleteProject(projectId) {
            const project = projectManager.projects.find(p => p.id === projectId);
            if (!project) return;
            
            if (confirm(`Delete "${project.name}"?\n\nThis cannot be undone.`)) {
                projectManager.deleteProject(projectId);
                renderProjects();
            }
        }

        function formatDate(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days === 0) return 'Today';
            if (days === 1) return 'Yesterday';
            if (days < 7) return `${days} days ago`;
            return new Date(timestamp).toLocaleDateString();
        }

        // Check premium status on auth changes
        document.addEventListener('authStatusChanged', checkPremiumStatus);

        // Authentication and User Profile Functions
        function checkAuth() {
            console.log('Checking auth...');
            authToken = localStorage.getItem('authToken');
            const user = localStorage.getItem('user');

            if (authToken && user) {
                try {
                    const userData = JSON.parse(user);
                    currentUser = userData;
                    showLoggedInUser(userData);
                    isLoggedIn = true;
                } catch (error) {
                    console.error('Error parsing user data:', error);
                    showGuestUser();
                    isLoggedIn = false;
                    currentUser = null;
                }
            } else {
                showGuestUser();
                isLoggedIn = false;
                currentUser = null;
            }
            updateModelSelector();
        }

        // Modal event listeners
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('newProjectModal');
            if (event.target === modal) {
                closeNewProjectModal();
            }
        });

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeNewProjectModal();
            }
        });

        // Show logged in user profile
        function showLoggedInUser(userData) {
            const userProfile = document.getElementById('userProfile');
            if (userProfile) {
                const planText = userData.subscription?.plan || 'free';
                const planDisplay = planText.charAt(0).toUpperCase() + planText.slice(1);
                
                userProfile.innerHTML = `
                    <div class="user-avatar">${(userData.name || userData.email || 'U').charAt(0).toUpperCase()}</div>
                    <div class="user-info">
                        <div class="user-name">${userData.name || userData.email || 'User'}</div>
                        <div class="user-plan">${planDisplay} Plan</div>
                    </div>
                    <button onclick="logout()" style="background: #f85149; border: none; border-radius: 6px; color: white; padding: 0.4rem 0.8rem; font-size: 0.8rem; cursor: pointer; margin-left: 0.5rem;">
                        Logout
                    </button>
                `;
            }
        }

        // Show guest user profile
        function showGuestUser() {
            console.log('[AUTH] Showing guest user profile...');
            const userProfile = document.getElementById('userProfile');
            if (userProfile) {
                userProfile.innerHTML = `
                    <div class="user-avatar">👤</div>
                    <div class="user-info">
                        <div class="user-name">Guest User</div>
                        <div class="user-plan">Free Plan - <span style="color: #58a6ff; cursor: pointer;" onclick="window.location.href='/login.html'">Sign In for More</span></div>
                    </div>
                    <button onclick="window.location.href='/login.html'" style="background: #238636; border: none; border-radius: 6px; color: white; padding: 0.4rem 0.8rem; font-size: 0.8rem; cursor: pointer; margin-left: 0.5rem;">
                        Sign In
                    </button>
                `;
                console.log('[AUTH] Guest user profile updated successfully');
            } else {
                console.error('[AUTH] Could not find userProfile element!');
            }
        }

        // Logout function
        function logout() {
            if (window.authManager) {
                window.authManager.logout();
            } else {
                // Fallback if authManager isn't loaded
                localStorage.removeItem('authToken');
                localStorage.removeItem('user');

                // Reset state variables
                isLoggedIn = false;
                authToken = null;
                currentUser = null;

                // Show guest user interface
                showGuestUser();
                updateModelSelector();
            }
        }

        // Update model selector for auth status
        function updateModelSelector() {
            const modelSelector = document.getElementById('modelSelector');
            if (modelSelector) {
                const options = modelSelector.querySelectorAll('option');
                
                options.forEach(option => {
                    if (option.value !== 'gpt-4o-mini') {
                        option.disabled = !isLoggedIn;
                        if (!isLoggedIn && !option.textContent.includes('Sign in required')) {
                            option.textContent += ' - Sign in required';
                        } else if (isLoggedIn && option.textContent.includes(' - Sign in required')) {
                            option.textContent = option.textContent.replace(' - Sign in required', '');
                        }
                    }
                });
            }
        }

        // Initialize app
        function initApp() {
            console.log('Initializing app...');
            checkAuth();
            renderProjects();
        }

        // Check subscription status (stub for now)
        function checkSubscriptionStatus() {
            // This function would normally check subscription status from server
            console.log('Checking subscription status...');
        }
    </script>

    <!-- Load JavaScript modules -->
    <script src="js/auth.js"></script>
    <script src="js/chat.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/scripts.js"></script>
    <script src="js/app.js"></script>

    <!-- Initialize the application -->
    <script>
        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            const app = new App();
            app.init();
        });
    </script>

    <!-- Content Ad Template for Chat -->
    <template id="chatContentAdTemplate">
        <div class="ad-container content-ad chat-content-ad" style="margin: 2rem auto;">
            <div class="ad-label">Advertisement</div>
        </div>
    </template>

</body>
</html>
